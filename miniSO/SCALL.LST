Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 1
scall.ASM



      1				     $comm   macro   name,dist,size,count
      2					     comm    dist name[size]:BYTE:count
      3					     endm
      4					     ?debug  V 300h
      5					     ?debug  S "scall.c"
      6					     ?debug  C E90AAB734D077363616C6C2E63
      7					     ?debug  C E9EE217847086D696E69534F2E68
      8					     ?debug  C E9B0A5734D077363616C6C2E68
      9					     ?debug  C E969A4734D056C69622E68
     10	0000			     _TEXT   segment byte public 'CODE'
     11	0000			     _TEXT   ends
     12				     DGROUP  group   _DATA,_BSS
     13					     assume  cs:_TEXT,ds:DGROUP
     14	0000			     _DATA   segment word public 'DATA'
     15	0000			     d@	     label   byte
     16	0000			     d@w     label   word
     17	0000			     _DATA   ends
     18	0000			     _BSS    segment word public 'BSS'
     19	0000			     b@	     label   byte
     20	0000			     b@w     label   word
     21	0000			     _BSS    ends
     22	0000			     _DATA   segment word public 'DATA'
     23	0000			     miniSO_col	     label   byte
     24	0000  50			     db	     80
     25	0001			     miniSO_cor	     label   byte
     26	0001  07			     db	     7
     27	0002			     miniSO_pag	     label   byte
     28	0002  00			     db	     0
     29	0003			     miniSO_iskey    label   byte
     30	0003  00			     db	     0
     31	0004			     miniSO_key	     label   byte
     32	0004  00			     db	     0
     33	0005			     nextsemid	     label   word
     34	0005  00			     db	     0
     35	0006  00			     db	     0
     36	0007			     _miniSO_ready   label   word
     37	0007  FF			     db	     255
     38	0008  FF			     db	     255
     39	0009			     _miniSO_free    label   word
     40	0009  FF			     db	     255
     41	000A  FF			     db	     255
     42	000B			     _miniSO_scall_table     label   word
     43	000B  00			     db	     0
     44	000C  01			     db	     1
     45	000D  00			     db	     0
     46	000E  00DAr			     dw	     _sc_putch
     47	0010  01			     db	     1
     48	0011  00			     db	     0
     49	0012  00			     db	     0
     50	0013  0170r			     dw	     _sc_getch
     51	0015  02			     db	     2
     52	0016  00			     db	     0
     53	0017  00			     db	     0
     54	0018  01C0r			     dw	     _sc_clrscr
     55	001A  03			     db	     3
     56	001B  00			     db	     0
     57	001C  00			     db	     0
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 2
scall.ASM



     58	001D  01E2r			     dw	     _sc_getcolor
     59	001F  04			     db	     4
     60	0020  01			     db	     1
     61	0021  00			     db	     0
     62	0022  01EDr			     dw	     _sc_setcolor
     63	0024  05			     db	     5
     64	0025  00			     db	     0
     65	0026  00			     db	     0
     66	0027  01FCr			     dw	     _sc_wherex
     67	0029  06			     db	     6
     68	002A  00			     db	     0
     69	002B  00			     db	     0
     70	002C  0209r			     dw	     _sc_wherey
     71	002E  07			     db	     7
     72	002F  02			     db	     2
     73	0030  00			     db	     0
     74	0031  021Ar			     dw	     _sc_gotoxy
     75	0033  08			     db	     8
     76	0034  02			     db	     2
     77	0035  00			     db	     0
     78	0036  0248r			     dw	     _sc_getdate
     79	0038  09			     db	     9
     80	0039  02			     db	     2
     81	003A  00			     db	     0
     82	003B  02F8r			     dw	     _sc_gettime
     83	003D  0A			     db	     10
     84	003E  00			     db	     0
     85	003F  00			     db	     0
     86	0040  05B8r			     dw	     _sc_reboot
     87	0042  0B			     db	     11
     88	0043  02			     db	     2
     89	0044  00			     db	     0
     90	0045  05D8r			     dw	     _sc_fork
     91	0047  0C			     db	     12
     92	0048  01			     db	     1
     93	0049  00			     db	     0
     94	004A  0834r			     dw	     _sc_kill
     95	004C  0D			     db	     13
     96	004D  03			     db	     3
     97	004E  00			     db	     0
     98	004F  0B2Er			     dw	     _sc_waitpid
     99	0051  0E			     db	     14
    100	0052  02			     db	     2
    101	0053  00			     db	     0
    102	0054  0D01r			     dw	     _sc_wait
    103	0056  0F			     db	     15
    104	0057  01			     db	     1
    105	0058  00			     db	     0
    106	0059  0E81r			     dw	     _sc_exit
    107	005B  10			     db	     16
    108	005C  00			     db	     0
    109	005D  00			     db	     0
    110	005E  1106r			     dw	     _sc_getpid
    111	0060  11			     db	     17
    112	0061  00			     db	     0
    113	0062  00			     db	     0
    114	0063  111Br			     dw	     _sc_getppid
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 3
scall.ASM



    115	0065  12			     db	     18
    116	0066  02			     db	     2
    117	0067  00			     db	     0
    118	0068  1130r			     dw	     _sc_sendsignal
    119	006A  13			     db	     19
    120	006B  01			     db	     1
    121	006C  00			     db	     0
    122	006D  1230r			     dw	     _sc_waitsignal
    123	006F  14			     db	     20
    124	0070  01			     db	     1
    125	0071  00			     db	     0
    126	0072  1366r			     dw	     _sc_semcreate
    127	0074  15			     db	     21
    128	0075  02			     db	     2
    129	0076  00			     db	     0
    130	0077  13F1r			     dw	     _sc_semset
    131	0079  16			     db	     22
    132	007A  01			     db	     1
    133	007B  00			     db	     0
    134	007C  142Ar			     dw	     _sc_semup
    135	007E  17			     db	     23
    136	007F  01			     db	     1
    137	0080  00			     db	     0
    138	0081  1517r			     dw	     _sc_semdown
    139	0083  18			     db	     24
    140	0084  01			     db	     1
    141	0085  00			     db	     0
    142	0086  165Dr			     dw	     _sc_semdestroy
    143	0088  19			     db	     25
    144	0089  01			     db	     1
    145	008A  00			     db	     0
    146	008B  1695r			     dw	     _sc_sembroadcast
    147	008D			     _DATA   ends
    148	0000			     _TEXT   segment byte public 'CODE'
    149					;
    150					;    int scall(unsigned	servico,unsigned bx,unsigned cx,unsigned dx)
    151					;
    152					     assume  cs:_TEXT
    153	0000			     _scall  proc    near
    154	0000  55			     push    bp
    155	0001  8B EC			     mov     bp,sp
    156	0003  56			     push    si
    157	0004  57			     push    di
    158	0005  8B 7E 06			     mov     di,word ptr [bp+6]
    159					;
    160					;    {
    161					;	     int     i;
    162					;
    163					;	     for     (i=0;i<miniSO_NUMSCALL;++i) {
    164					;
    165	0008  33 F6			     xor     si,si
    166	000A  EB 7C 90			     jmp     @1@338
    167	000D			     @1@58:
    168					;
    169					;		     if	     (servico==(unsigned)miniSO_scall_table[i].ah) {
    170					;
    171	000D  8B C6			     mov     ax,si
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 4
scall.ASM



    172	000F  BA 0005			     mov     dx,5
    173	0012  F7 EA			     imul    dx
    174	0014  8B D8			     mov     bx,ax
    175	0016  8A 87 000Br		     mov     al,byte ptr DGROUP:_miniSO_scall_table[bx]
    176	001A  98			     cbw
    177	001B  3B 46 04			     cmp     ax,word ptr [bp+4]
    178	001E  75 67			     jne     short @1@310
    179					;
    180					;			     switch  (miniSO_scall_table[i].numparam)  {
    181					;
    182	0020  8B C6			     mov     ax,si
    183	0022  BA 0005			     mov     dx,5
    184	0025  F7 EA			     imul    dx
    185	0027  8B D8			     mov     bx,ax
    186	0029  8B 9F 000Cr		     mov     bx,word ptr DGROUP:_miniSO_scall_table[bx+1]
    187	002D  83 FB 03			     cmp     bx,3
    188	0030  77 55			     ja	     short @1@310
    189	0032  D1 E3			     shl     bx,1
    190	0034  2E: FF A7	0098r		     jmp     word ptr cs:@1@C434[bx]
    191	0039			     @1@170:
    192					;
    193					;				     case    0:
    194					;					     return miniSO_scall_table[i].function.p0();
    195					;
    196	0039  8B C6			     mov     ax,si
    197	003B  BA 0005			     mov     dx,5
    198	003E  F7 EA			     imul    dx
    199	0040  8B D8			     mov     bx,ax
    200	0042  FF 97 000Er		     call    word ptr DGROUP:_miniSO_scall_table[bx+3]
    201	0046			     @1@198:
    202	0046  EB 4C			     jmp     short @1@394
    203	0048			     @1@226:
    204					;
    205					;				     case    1:
    206					;					     return miniSO_scall_table[i].function.p1(bx);
    207					;
    208	0048  57			     push    di
    209	0049  8B C6			     mov     ax,si
    210	004B  BA 0005			     mov     dx,5
    211	004E  F7 EA			     imul    dx
    212	0050  8B D8			     mov     bx,ax
    213	0052  FF 97 000Er		     call    word ptr DGROUP:_miniSO_scall_table[bx+3]
    214	0056  59			     pop     cx
    215	0057  EB ED			     jmp     short @1@198
    216	0059			     @1@254:
    217					;
    218					;				     case    2:
    219					;					     return miniSO_scall_table[i].function.p2(bx,cx);
    220					;
    221	0059  FF 76 08			     push    word ptr [bp+8]
    222	005C  57			     push    di
    223	005D  8B C6			     mov     ax,si
    224	005F  BA 0005			     mov     dx,5
    225	0062  F7 EA			     imul    dx
    226	0064  8B D8			     mov     bx,ax
    227	0066  FF 97 000Er		     call    word ptr DGROUP:_miniSO_scall_table[bx+3]
    228	006A  59			     pop     cx
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 5
scall.ASM



    229	006B  59			     pop     cx
    230	006C  EB D8			     jmp     short @1@198
    231	006E			     @1@282:
    232					;
    233					;				     case    3:
    234					;					     return miniSO_scall_table[i].function.p3(bx,cx,+
    235				     dx);
    236					;
    237	006E  FF 76 0A			     push    word ptr [bp+10]
    238	0071  FF 76 08			     push    word ptr [bp+8]
    239	0074  57			     push    di
    240	0075  8B C6			     mov     ax,si
    241	0077  BA 0005			     mov     dx,5
    242	007A  F7 EA			     imul    dx
    243	007C  8B D8			     mov     bx,ax
    244	007E  FF 97 000Er		     call    word ptr DGROUP:_miniSO_scall_table[bx+3]
    245	0082  83 C4 06			     add     sp,6
    246	0085  EB BF			     jmp     short @1@198
    247	0087			     @1@310:
    248	0087  46			     inc     si
    249	0088			     @1@338:
    250	0088  83 FE 1A			     cmp     si,26
    251	008B  7D 03			     jge     @@0
    252	008D  E9 FF7D			     jmp     @1@58
    253	0090			     @@0:
    254					;
    255					;			     }
    256					;		     }
    257					;	     }
    258					;	     return 0;
    259					;
    260	0090  33 C0			     xor     ax,ax
    261	0092  EB B2			     jmp     short @1@198
    262	0094			     @1@394:
    263					;
    264					;    }
    265					;
    266	0094  5F			     pop     di
    267	0095  5E			     pop     si
    268	0096  5D			     pop     bp
    269	0097  C3			     ret
    270	0098			     _scall  endp
    271	0098			     @1@C434 label   word
    272	0098  0039r			     dw	     @1@170
    273	009A  0048r			     dw	     @1@226
    274	009C  0059r			     dw	     @1@254
    275	009E  006Er			     dw	     @1@282
    276					;
    277					;    void setCursorPosition(int	pos)
    278					;
    279					     assume  cs:_TEXT
    280	00A0			     setCursorPosition	     proc    near
    281	00A0  55			     push    bp
    282	00A1  8B EC			     mov     bp,sp
    283					;
    284					;    {
    285					;	     mov_dx(pos);
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 6
scall.ASM



    286					;
    287	00A3  8B 56 04			     mov     dx,word ptr [bp+4]
    288					;
    289					;	     mov_bh(miniSO_pag);
    290					;
    291	00A6  8A 3E 0002r		     mov     bh,byte ptr DGROUP:miniSO_pag
    292					;
    293					;	     mov_ah(2);
    294					;
    295	00AA  B4 02			     mov     ah,2
    296					;
    297					;	     int_10h();
    298					;
    299	00AC  CD 10			     int      10h
    300					;
    301					;    }
    302					;
    303	00AE  5D			     pop     bp
    304	00AF  C3			     ret
    305	00B0			     setCursorPosition	     endp
    306					;
    307					;    int getCursorPosition()
    308					;
    309					     assume  cs:_TEXT
    310	00B0			     getCursorPosition	     proc    near
    311	00B0  55			     push    bp
    312	00B1  8B EC			     mov     bp,sp
    313					;
    314					;    {
    315					;	     mov_bh(miniSO_pag);
    316					;
    317	00B3  8A 3E 0002r		     mov     bh,byte ptr DGROUP:miniSO_pag
    318					;
    319					;	     mov_ah(3);
    320					;
    321	00B7  B4 03			     mov     ah,3
    322					;
    323					;	     int_10h();
    324					;
    325	00B9  CD 10			     int      10h
    326					;
    327					;	     return _DX;
    328					;
    329	00BB  8B C2			     mov     ax,dx
    330	00BD  EB 00			     jmp     short @3@114
    331	00BF			     @3@114:
    332					;
    333					;    }
    334					;
    335	00BF  5D			     pop     bp
    336	00C0  C3			     ret
    337	00C1			     getCursorPosition	     endp
    338					;
    339					;    void scroll()
    340					;
    341					     assume  cs:_TEXT
    342	00C1			     scroll  proc    near
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 7
scall.ASM



    343	00C1  55			     push    bp
    344	00C2  8B EC			     mov     bp,sp
    345					;
    346					;    {
    347					;	     mov_al(1);	/* número de linhas para scroll	*/
    348					;
    349	00C4  B0 01			     mov     al,1
    350					;
    351					;	     mov_cx(0);
    352					;
    353	00C6  33 C9			     xor     cx,cx
    354					;
    355					;	     mov_ah(6);
    356					;
    357	00C8  B4 06			     mov     ah,6
    358					;
    359					;	     mov_dh(24);
    360					;
    361	00CA  B6 18			     mov     dh,24
    362					;
    363					;	     mov_dl(miniSO_col);
    364					;
    365	00CC  8A 16 0000r		     mov     dl,byte ptr DGROUP:miniSO_col
    366					;
    367					;	     dec_dl();
    368					;
    369	00D0  FE CA			     dec      dl
    370					;
    371					;	     mov_bh(miniSO_cor);
    372					;
    373	00D2  8A 3E 0001r		     mov     bh,byte ptr DGROUP:miniSO_cor
    374					;
    375					;	     int_10h();
    376					;
    377	00D6  CD 10			     int      10h
    378					;
    379					;    }
    380					;
    381	00D8  5D			     pop     bp
    382	00D9  C3			     ret
    383	00DA			     scroll  endp
    384					;
    385					;    int sc_putch(int car)
    386					;
    387					     assume  cs:_TEXT
    388	00DA			     _sc_putch	     proc    near
    389	00DA  55			     push    bp
    390	00DB  8B EC			     mov     bp,sp
    391	00DD  83 EC 02			     sub     sp,2
    392	00E0  56			     push    si
    393	00E1  57			     push    di
    394					;
    395					;    {
    396					;	     int     curpos,lin,col;
    397					;
    398					;	     car = car & 0x00ff;
    399					;
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 8
scall.ASM



    400	00E2  8B 46 04			     mov     ax,word ptr [bp+4]
    401	00E5  25 00FF			     and     ax,255
    402	00E8  89 46 04			     mov     word ptr [bp+4],ax
    403					;
    404					;	     if	     (car==10)	{
    405					;
    406	00EB  83 7E 04 0A		     cmp     word ptr [bp+4],10
    407	00EF  75 22			     jne     short @5@170
    408					;
    409					;		     curpos = getCursorPosition();
    410					;
    411	00F1  E8 FFBC			     call    near ptr getCursorPosition
    412	00F4  8B F8			     mov     di,ax
    413					;
    414					;		     lin = (curpos >> 8) & 0x00ff;
    415					;
    416	00F6  8B C7			     mov     ax,di
    417	00F8  B1 08			     mov     cl,8
    418	00FA  D3 F8			     sar     ax,cl
    419	00FC  25 00FF			     and     ax,255
    420	00FF  8B F0			     mov     si,ax
    421					;
    422					;		     col = 0;
    423					;
    424	0101  C7 46 FE 0000		     mov     word ptr [bp-2],0
    425					;
    426					;		     if	     (lin<24)
    427					;
    428	0106  83 FE 18			     cmp     si,24
    429	0109  7D 03			     jge     short @5@114
    430					;
    431					;			     ++lin;
    432					;
    433	010B  46			     inc     si
    434	010C  EB 03			     jmp     short @5@142
    435	010E			     @5@114:
    436					;
    437					;		     else
    438					;			     scroll();
    439					;
    440	010E  E8 FFB0			     call    near ptr scroll
    441	0111			     @5@142:
    442					;
    443					;	     }
    444					;
    445	0111  EB 43			     jmp     short @5@338
    446	0113			     @5@170:
    447					;
    448					;	     else    {
    449					;		     /*	Imprime	o caracter */
    450					;		     mov_bl(miniSO_cor);
    451					;
    452	0113  8A 1E 0001r		     mov     bl,byte ptr DGROUP:miniSO_cor
    453					;
    454					;		     mov_bh(miniSO_pag);
    455					;
    456	0117  8A 3E 0002r		     mov     bh,byte ptr DGROUP:miniSO_pag
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 9
scall.ASM



    457					;
    458					;		     mov_cx(1);
    459					;
    460	011B  B9 0001			     mov     cx,1
    461					;
    462					;		     mov_ah(0x9);
    463					;
    464	011E  B4 09			     mov     ah,9
    465					;
    466					;		     int_10h();
    467					;
    468	0120  CD 10			     int      10h
    469					;
    470					;		     curpos = getCursorPosition();
    471					;
    472	0122  E8 FF8B			     call    near ptr getCursorPosition
    473	0125  8B F8			     mov     di,ax
    474					;
    475					;		     lin = (curpos >> 8) & 0x00ff;
    476					;
    477	0127  8B C7			     mov     ax,di
    478	0129  B1 08			     mov     cl,8
    479	012B  D3 F8			     sar     ax,cl
    480	012D  25 00FF			     and     ax,255
    481	0130  8B F0			     mov     si,ax
    482					;
    483					;		     col = curpos & 0x00ff;
    484					;
    485	0132  8B C7			     mov     ax,di
    486	0134  25 00FF			     and     ax,255
    487	0137  89 46 FE			     mov     word ptr [bp-2],ax
    488					;
    489					;		     ++col;
    490					;
    491	013A  FF 46 FE			     inc     word ptr [bp-2]
    492					;
    493					;		     if	     (col==miniSO_col)	{
    494					;
    495	013D  A0 0000r			     mov     al,byte ptr DGROUP:miniSO_col
    496	0140  98			     cbw
    497	0141  3B 46 FE			     cmp     ax,word ptr [bp-2]
    498	0144  75 10			     jne     short @5@338
    499					;
    500					;			     col = 0;
    501					;
    502	0146  C7 46 FE 0000		     mov     word ptr [bp-2],0
    503					;
    504					;			     if	     (lin<24)
    505					;
    506	014B  83 FE 18			     cmp     si,24
    507	014E  7D 03			     jge     short @5@310
    508					;
    509					;				     ++lin;
    510					;
    511	0150  46			     inc     si
    512	0151  EB 03			     jmp     short @5@338
    513	0153			     @5@310:
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 10
scall.ASM



    514					;
    515					;			     else
    516					;				     scroll();
    517					;
    518	0153  E8 FF6B			     call    near ptr scroll
    519	0156			     @5@338:
    520					;
    521					;		     }
    522					;	     }
    523					;	     curpos = (lin << 8)|col;
    524					;
    525	0156  8B C6			     mov     ax,si
    526	0158  B1 08			     mov     cl,8
    527	015A  D3 E0			     shl     ax,cl
    528	015C  0B 46 FE			     or	     ax,word ptr [bp-2]
    529	015F  8B F8			     mov     di,ax
    530					;
    531					;	     setCursorPosition(curpos);
    532					;
    533	0161  57			     push    di
    534	0162  E8 FF3B			     call    near ptr setCursorPosition
    535	0165  59			     pop     cx
    536					;
    537					;	     return 0;
    538					;
    539	0166  33 C0			     xor     ax,ax
    540	0168  EB 00			     jmp     short @5@366
    541	016A			     @5@366:
    542					;
    543					;    }
    544					;
    545	016A  5F			     pop     di
    546	016B  5E			     pop     si
    547	016C  8B E5			     mov     sp,bp
    548	016E  5D			     pop     bp
    549	016F  C3			     ret
    550	0170			     _sc_putch	     endp
    551					;
    552					;    int sc_getch()
    553					;
    554					     assume  cs:_TEXT
    555	0170			     _sc_getch	     proc    near
    556	0170  55			     push    bp
    557	0171  8B EC			     mov     bp,sp
    558	0173  83 EC 02			     sub     sp,2
    559					;
    560					;    {
    561					;      int ax,al,ah;
    562					;
    563					;      if (miniSO_iskey!=0)  {
    564					;
    565	0176  80 3E 0003r 00		     cmp     byte ptr DGROUP:miniSO_iskey,0
    566	017B  74 0B			     je	     short @6@114
    567					;
    568					;	  miniSO_iskey = 0;
    569					;
    570	017D  C6 06 0003r 00		     mov     byte ptr DGROUP:miniSO_iskey,0
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 11
scall.ASM



    571					;
    572					;	  return miniSO_key;
    573					;
    574	0182  A0 0004r			     mov     al,byte ptr DGROUP:miniSO_key
    575	0185  98			     cbw
    576	0186			     @6@86:
    577	0186  EB 34			     jmp     short @6@282
    578	0188			     @6@114:
    579					;
    580					;      }
    581					;
    582					;      mov_ah(0x10);
    583					;
    584	0188  B4 10			     mov     ah,16
    585					;
    586					;      int_16h();
    587					;
    588	018A  CD 16			     int      16h
    589					;
    590					;
    591					;      ax = get_ax();
    592					;
    593	018C  8B D8			     mov     bx,ax
    594					;
    595					;      ah = (ax	>> 8) &	0x00ff;
    596					;
    597	018E  8B C3			     mov     ax,bx
    598	0190  B1 08			     mov     cl,8
    599	0192  D3 F8			     sar     ax,cl
    600	0194  25 00FF			     and     ax,255
    601	0197  89 46 FE			     mov     word ptr [bp-2],ax
    602					;
    603					;      al = 0x00ff & ax;
    604					;
    605	019A  B8 00FF			     mov     ax,255
    606	019D  23 C3			     and     ax,bx
    607	019F  8B D0			     mov     dx,ax
    608					;
    609					;
    610					;      if (al==0xe0 || al==0x00)  {
    611					;
    612	01A1  81 FA 00E0		     cmp     dx,224
    613	01A5  74 04			     je	     short @6@226
    614	01A7  0B D2			     or	     dx,dx
    615	01A9  75 0D			     jne     short @6@254
    616	01AB			     @6@226:
    617					;
    618					;	  miniSO_iskey = 1;
    619					;
    620	01AB  C6 06 0003r 01		     mov     byte ptr DGROUP:miniSO_iskey,1
    621					;
    622					;	  miniSO_key = ah;
    623					;
    624	01B0  8A 46 FE			     mov     al,byte ptr [bp-2]
    625	01B3  A2 0004r			     mov     byte ptr DGROUP:miniSO_key,al
    626					;
    627					;	  al = 0;
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 12
scall.ASM



    628					;
    629	01B6  33 D2			     xor     dx,dx
    630	01B8			     @6@254:
    631					;
    632					;      }
    633					;      return al;
    634					;
    635	01B8  8B C2			     mov     ax,dx
    636	01BA  EB CA			     jmp     short @6@86
    637	01BC			     @6@282:
    638					;
    639					;    }
    640					;
    641	01BC  8B E5			     mov     sp,bp
    642	01BE  5D			     pop     bp
    643	01BF  C3			     ret
    644	01C0			     _sc_getch	     endp
    645					;
    646					;    int sc_clrscr()
    647					;
    648					     assume  cs:_TEXT
    649	01C0			     _sc_clrscr	     proc    near
    650	01C0  55			     push    bp
    651	01C1  8B EC			     mov     bp,sp
    652					;
    653					;    {
    654					;      mov_al(0);
    655					;
    656	01C3  B0 00			     mov     al,0
    657					;
    658					;      mov_cx(0);
    659					;
    660	01C5  33 C9			     xor     cx,cx
    661					;
    662					;      mov_dh(24);
    663					;
    664	01C7  B6 18			     mov     dh,24
    665					;
    666					;      mov_dl(miniSO_col);
    667					;
    668	01C9  8A 16 0000r		     mov     dl,byte ptr DGROUP:miniSO_col
    669					;
    670					;      dec_dl();
    671					;
    672	01CD  FE CA			     dec      dl
    673					;
    674					;      mov_ah(6);
    675					;
    676	01CF  B4 06			     mov     ah,6
    677					;
    678					;      mov_bh(7);
    679					;
    680	01D1  B7 07			     mov     bh,7
    681					;
    682					;      int_10h();
    683					;
    684	01D3  CD 10			     int      10h
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 13
scall.ASM



    685					;
    686					;      setCursorPosition(0);
    687					;
    688	01D5  33 C0			     xor     ax,ax
    689	01D7  50			     push    ax
    690	01D8  E8 FEC5			     call    near ptr setCursorPosition
    691	01DB  59			     pop     cx
    692					;
    693					;      return 0;
    694					;
    695	01DC  33 C0			     xor     ax,ax
    696	01DE  EB 00			     jmp     short @7@170
    697	01E0			     @7@170:
    698					;
    699					;    }
    700					;
    701	01E0  5D			     pop     bp
    702	01E1  C3			     ret
    703	01E2			     _sc_clrscr	     endp
    704					;
    705					;    int sc_getcolor()
    706					;
    707					     assume  cs:_TEXT
    708	01E2			     _sc_getcolor    proc    near
    709	01E2  55			     push    bp
    710	01E3  8B EC			     mov     bp,sp
    711					;
    712					;    {
    713					;      return miniSO_cor;
    714					;
    715	01E5  A0 0001r			     mov     al,byte ptr DGROUP:miniSO_cor
    716	01E8  98			     cbw
    717	01E9  EB 00			     jmp     short @8@58
    718	01EB			     @8@58:
    719					;
    720					;    }
    721					;
    722	01EB  5D			     pop     bp
    723	01EC  C3			     ret
    724	01ED			     _sc_getcolor    endp
    725					;
    726					;    int sc_setcolor(int cor)
    727					;
    728					     assume  cs:_TEXT
    729	01ED			     _sc_setcolor    proc    near
    730	01ED  55			     push    bp
    731	01EE  8B EC			     mov     bp,sp
    732					;
    733					;    {
    734					;      miniSO_cor = cor;
    735					;
    736	01F0  8A 46 04			     mov     al,byte ptr [bp+4]
    737	01F3  A2 0001r			     mov     byte ptr DGROUP:miniSO_cor,al
    738					;
    739					;      return 0;
    740					;
    741	01F6  33 C0			     xor     ax,ax
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 14
scall.ASM



    742	01F8  EB 00			     jmp     short @9@58
    743	01FA			     @9@58:
    744					;
    745					;    }
    746					;
    747	01FA  5D			     pop     bp
    748	01FB  C3			     ret
    749	01FC			     _sc_setcolor    endp
    750					;
    751					;    int sc_wherex()
    752					;
    753					     assume  cs:_TEXT
    754	01FC			     _sc_wherex	     proc    near
    755	01FC  55			     push    bp
    756	01FD  8B EC			     mov     bp,sp
    757					;
    758					;    {
    759					;      return getCursorPosition() & 0x00ff;
    760					;
    761	01FF  E8 FEAE			     call    near ptr getCursorPosition
    762	0202  25 00FF			     and     ax,255
    763	0205  EB 00			     jmp     short @10@58
    764	0207			     @10@58:
    765					;
    766					;    }
    767					;
    768	0207  5D			     pop     bp
    769	0208  C3			     ret
    770	0209			     _sc_wherex	     endp
    771					;
    772					;    int sc_wherey()
    773					;
    774					     assume  cs:_TEXT
    775	0209			     _sc_wherey	     proc    near
    776	0209  55			     push    bp
    777	020A  8B EC			     mov     bp,sp
    778					;
    779					;    {
    780					;      return (getCursorPosition()>>8) & 0x00ff;
    781					;
    782	020C  E8 FEA1			     call    near ptr getCursorPosition
    783	020F  B1 08			     mov     cl,8
    784	0211  D3 F8			     sar     ax,cl
    785	0213  25 00FF			     and     ax,255
    786	0216  EB 00			     jmp     short @11@58
    787	0218			     @11@58:
    788					;
    789					;    }
    790					;
    791	0218  5D			     pop     bp
    792	0219  C3			     ret
    793	021A			     _sc_wherey	     endp
    794					;
    795					;    int sc_gotoxy(int x, int y)
    796					;
    797					     assume  cs:_TEXT
    798	021A			     _sc_gotoxy	     proc    near
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 15
scall.ASM



    799	021A  55			     push    bp
    800	021B  8B EC			     mov     bp,sp
    801	021D  56			     push    si
    802	021E  57			     push    di
    803	021F  8B 76 04			     mov     si,word ptr [bp+4]
    804	0222  8B 7E 06			     mov     di,word ptr [bp+6]
    805					;
    806					;    {
    807					;      x = x & 0x00ff;
    808					;
    809	0225  8B C6			     mov     ax,si
    810	0227  25 00FF			     and     ax,255
    811	022A  8B F0			     mov     si,ax
    812					;
    813					;      y = (y<<8) & 0xff00;
    814					;
    815	022C  8B C7			     mov     ax,di
    816	022E  B1 08			     mov     cl,8
    817	0230  D3 E0			     shl     ax,cl
    818	0232  25 FF00			     and     ax,-256
    819	0235  8B F8			     mov     di,ax
    820					;
    821					;      setCursorPosition(x|y);
    822					;
    823	0237  8B C6			     mov     ax,si
    824	0239  0B C7			     or	     ax,di
    825	023B  50			     push    ax
    826	023C  E8 FE61			     call    near ptr setCursorPosition
    827	023F  59			     pop     cx
    828					;
    829					;      return 0;
    830					;
    831	0240  33 C0			     xor     ax,ax
    832	0242  EB 00			     jmp     short @12@58
    833	0244			     @12@58:
    834					;
    835					;    }
    836					;
    837	0244  5F			     pop     di
    838	0245  5E			     pop     si
    839	0246  5D			     pop     bp
    840	0247  C3			     ret
    841	0248			     _sc_gotoxy	     endp
    842					;
    843					;    int sc_getdate(unsigned seg, unsigned off)
    844					;
    845					     assume  cs:_TEXT
    846	0248			     _sc_getdate     proc    near
    847	0248  55			     push    bp
    848	0249  8B EC			     mov     bp,sp
    849	024B  83 EC 08			     sub     sp,8
    850	024E  56			     push    si
    851					;
    852					;    {
    853					;      struct date far *dt;
    854					;      unsigned	d,m,a;
    855					;
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 16
scall.ASM



    856					;      dt = MK_FP(seg,off);
    857					;
    858	024F  FF 76 06			     push    word ptr [bp+6]
    859	0252  FF 76 04			     push    word ptr [bp+4]
    860	0255  E8 0000e			     call    near ptr _MK_FP
    861	0258  59			     pop     cx
    862	0259  59			     pop     cx
    863	025A  89 56 FE			     mov     word ptr [bp-2],dx
    864	025D  89 46 FC			     mov     word ptr [bp-4],ax
    865					;
    866					;      mov_ah(4);
    867					;
    868	0260  B4 04			     mov     ah,4
    869					;
    870					;      int_1ah();
    871					;
    872	0262  CD 1A			     int      1ah
    873					;
    874					;      d=get_dl();
    875					;
    876	0264  8A C2			     mov     al,dl
    877	0266  B4 00			     mov     ah,0
    878	0268  89 46 FA			     mov     word ptr [bp-6],ax
    879					;
    880					;      m=get_dh();
    881					;
    882	026B  8A C6			     mov     al,dh
    883	026D  B4 00			     mov     ah,0
    884	026F  89 46 F8			     mov     word ptr [bp-8],ax
    885					;
    886					;      a=get_cx();
    887					;
    888	0272  8B F1			     mov     si,cx
    889					;
    890					;      dt->da_day  = 10*((d & 0xf0)>>4)	+ (d & 0x0f);
    891					;
    892	0274  8B 46 FA			     mov     ax,word ptr [bp-6]
    893	0277  25 00F0			     and     ax,240
    894	027A  B1 04			     mov     cl,4
    895	027C  D3 E8			     shr     ax,cl
    896	027E  BA 000A			     mov     dx,10
    897	0281  F7 EA			     imul    dx
    898	0283  8A 56 FA			     mov     dl,byte ptr [bp-6]
    899	0286  80 E2 0F			     and     dl,15
    900	0289  02 C2			     add     al,dl
    901	028B  C4 5E FC			     les     bx,dword ptr [bp-4]
    902	028E  26: 88 47	02		     mov     byte ptr es:[bx+2],al
    903					;
    904					;      dt->da_mon  = 10*((m & 0xf0)>>4)	+ (m & 0x0f);
    905					;
    906	0292  8B 46 F8			     mov     ax,word ptr [bp-8]
    907	0295  25 00F0			     and     ax,240
    908	0298  B1 04			     mov     cl,4
    909	029A  D3 E8			     shr     ax,cl
    910	029C  BA 000A			     mov     dx,10
    911	029F  F7 EA			     imul    dx
    912	02A1  8A 56 F8			     mov     dl,byte ptr [bp-8]
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 17
scall.ASM



    913	02A4  80 E2 0F			     and     dl,15
    914	02A7  02 C2			     add     al,dl
    915	02A9  C4 5E FC			     les     bx,dword ptr [bp-4]
    916	02AC  26: 88 47	03		     mov     byte ptr es:[bx+3],al
    917					;
    918					;      dt->da_year = 1000*((a &	0xf000)>>12) + 100*((a & 0x0f00)>>8) + 10*((a &	0x00f0)>>4) +
    919				     + (a & 0x000f);
    920					;
    921	02B0  8B C6			     mov     ax,si
    922	02B2  25 F000			     and     ax,-4096
    923	02B5  B1 0C			     mov     cl,12
    924	02B7  D3 E8			     shr     ax,cl
    925	02B9  BA 03E8			     mov     dx,1000
    926	02BC  F7 EA			     imul    dx
    927	02BE  50			     push    ax
    928	02BF  8B C6			     mov     ax,si
    929	02C1  25 0F00			     and     ax,3840
    930	02C4  B1 08			     mov     cl,8
    931	02C6  D3 E8			     shr     ax,cl
    932	02C8  BA 0064			     mov     dx,100
    933	02CB  F7 EA			     imul    dx
    934	02CD  5A			     pop     dx
    935	02CE  03 D0			     add     dx,ax
    936	02D0  8B C6			     mov     ax,si
    937	02D2  25 00F0			     and     ax,240
    938	02D5  B1 04			     mov     cl,4
    939	02D7  D3 E8			     shr     ax,cl
    940	02D9  BB 000A			     mov     bx,10
    941	02DC  52			     push    dx
    942	02DD  F7 EB			     imul    bx
    943	02DF  5A			     pop     dx
    944	02E0  03 D0			     add     dx,ax
    945	02E2  8B C6			     mov     ax,si
    946	02E4  25 000F			     and     ax,15
    947	02E7  03 D0			     add     dx,ax
    948	02E9  C4 5E FC			     les     bx,dword ptr [bp-4]
    949	02EC  26: 89 17			     mov     word ptr es:[bx],dx
    950					;
    951					;      return 0;
    952					;
    953	02EF  33 C0			     xor     ax,ax
    954	02F1  EB 00			     jmp     short @13@114
    955	02F3			     @13@114:
    956					;
    957					;    }
    958					;
    959	02F3  5E			     pop     si
    960	02F4  8B E5			     mov     sp,bp
    961	02F6  5D			     pop     bp
    962	02F7  C3			     ret
    963	02F8			     _sc_getdate     endp
    964					;
    965					;    int sc_gettime(unsigned seg,unsigned off)
    966					;
    967					     assume  cs:_TEXT
    968	02F8			     _sc_gettime     proc    near
    969	02F8  55			     push    bp
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 18
scall.ASM



    970	02F9  8B EC			     mov     bp,sp
    971	02FB  83 EC 0A			     sub     sp,10
    972					;
    973					;    {
    974					;      struct time far *tm;
    975					;      unsigned	h,m,s;
    976					;
    977					;      tm = MK_FP(seg,off);
    978					;
    979	02FE  FF 76 06			     push    word ptr [bp+6]
    980	0301  FF 76 04			     push    word ptr [bp+4]
    981	0304  E8 0000e			     call    near ptr _MK_FP
    982	0307  59			     pop     cx
    983	0308  59			     pop     cx
    984	0309  89 56 FE			     mov     word ptr [bp-2],dx
    985	030C  89 46 FC			     mov     word ptr [bp-4],ax
    986					;
    987					;      mov_ah(2);
    988					;
    989	030F  B4 02			     mov     ah,2
    990					;
    991					;      int_1ah();
    992					;
    993	0311  CD 1A			     int      1ah
    994					;
    995					;      h=get_ch();
    996					;
    997	0313  8A C5			     mov     al,ch
    998	0315  B4 00			     mov     ah,0
    999	0317  89 46 FA			     mov     word ptr [bp-6],ax
   1000					;
   1001					;      m=get_cl();
   1002					;
   1003	031A  8A C1			     mov     al,cl
   1004	031C  B4 00			     mov     ah,0
   1005	031E  89 46 F8			     mov     word ptr [bp-8],ax
   1006					;
   1007					;      s=get_dh();
   1008					;
   1009	0321  8A C6			     mov     al,dh
   1010	0323  B4 00			     mov     ah,0
   1011	0325  89 46 F6			     mov     word ptr [bp-10],ax
   1012					;
   1013					;      tm->ti_hour = 10*((h & 0xf0)>>4)	+ (h & 0x0f);
   1014					;
   1015	0328  8B 46 FA			     mov     ax,word ptr [bp-6]
   1016	032B  25 00F0			     and     ax,240
   1017	032E  B1 04			     mov     cl,4
   1018	0330  D3 E8			     shr     ax,cl
   1019	0332  BA 000A			     mov     dx,10
   1020	0335  F7 EA			     imul    dx
   1021	0337  8A 56 FA			     mov     dl,byte ptr [bp-6]
   1022	033A  80 E2 0F			     and     dl,15
   1023	033D  02 C2			     add     al,dl
   1024	033F  C4 5E FC			     les     bx,dword ptr [bp-4]
   1025	0342  26: 88 47	01		     mov     byte ptr es:[bx+1],al
   1026					;
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 19
scall.ASM



   1027					;      tm->ti_min  = 10*((m & 0xf0)>>4)	+ (m & 0x0f);
   1028					;
   1029	0346  8B 46 F8			     mov     ax,word ptr [bp-8]
   1030	0349  25 00F0			     and     ax,240
   1031	034C  B1 04			     mov     cl,4
   1032	034E  D3 E8			     shr     ax,cl
   1033	0350  BA 000A			     mov     dx,10
   1034	0353  F7 EA			     imul    dx
   1035	0355  8A 56 F8			     mov     dl,byte ptr [bp-8]
   1036	0358  80 E2 0F			     and     dl,15
   1037	035B  02 C2			     add     al,dl
   1038	035D  C4 5E FC			     les     bx,dword ptr [bp-4]
   1039	0360  26: 88 07			     mov     byte ptr es:[bx],al
   1040					;
   1041					;      tm->ti_sec  = 10*((s & 0xf0)>>4)	+ (s & 0x0f);
   1042					;
   1043	0363  8B 46 F6			     mov     ax,word ptr [bp-10]
   1044	0366  25 00F0			     and     ax,240
   1045	0369  B1 04			     mov     cl,4
   1046	036B  D3 E8			     shr     ax,cl
   1047	036D  BA 000A			     mov     dx,10
   1048	0370  F7 EA			     imul    dx
   1049	0372  8A 56 F6			     mov     dl,byte ptr [bp-10]
   1050	0375  80 E2 0F			     and     dl,15
   1051	0378  02 C2			     add     al,dl
   1052	037A  C4 5E FC			     les     bx,dword ptr [bp-4]
   1053	037D  26: 88 47	03		     mov     byte ptr es:[bx+3],al
   1054					;
   1055					;      tm->ti_hund = 0;
   1056					;
   1057	0381  C4 5E FC			     les     bx,dword ptr [bp-4]
   1058	0384  26: C6 47	02 00		     mov     byte ptr es:[bx+2],0
   1059					;
   1060					;      return 0;
   1061					;
   1062	0389  33 C0			     xor     ax,ax
   1063	038B  EB 00			     jmp     short @14@114
   1064	038D			     @14@114:
   1065					;
   1066					;    }
   1067					;
   1068	038D  8B E5			     mov     sp,bp
   1069	038F  5D			     pop     bp
   1070	0390  C3			     ret
   1071	0391			     _sc_gettime     endp
   1072					;
   1073					;    void miniSO_contextswitch ()
   1074					;
   1075					     assume  cs:_TEXT
   1076	0391			     _miniSO_contextswitch   proc    near
   1077	0391  55			     push    bp
   1078	0392  8B EC			     mov     bp,sp
   1079					;
   1080					;    {
   1081					;      if ( miniSO_nextthread == miniSO_NONE )
   1082					;
   1083	0394  83 3E 0004r FF		     cmp     word ptr DGROUP:_miniSO_nextthread,-1
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 20
scall.ASM



   1084	0399  75 11			     jne     short @15@86
   1085					;
   1086					;	  miniSO_nextthread=miniSO_thread[miniSO_ready].next;
   1087					;
   1088	039B  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1089	039E  BA 001A			     mov     dx,26
   1090	03A1  F7 EA			     imul    dx
   1091	03A3  8B D8			     mov     bx,ax
   1092	03A5  8B 87 001Fr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+24]
   1093	03A9  A3 0004r			     mov     word ptr DGROUP:_miniSO_nextthread,ax
   1094	03AC			     @15@86:
   1095					;
   1096					;      /* Se houve alteracao de	thread corrente	... */
   1097					;      if (miniSO_nextthread!=miniSO_ready)  {
   1098					;
   1099	03AC  A1 0004r			     mov     ax,word ptr DGROUP:_miniSO_nextthread
   1100	03AF  3B 06 0007r		     cmp     ax,word ptr DGROUP:_miniSO_ready
   1101	03B3  75 03			     jne     @@1
   1102	03B5  EB 7E 90			     jmp     @15@254
   1103	03B8			     @@1:
   1104					;
   1105					;	  if (miniSO_delcurthread)	    /* Se a thread corrente foi	excluida ... */
   1106					;
   1107	03B8  80 3E 0006r 00		     cmp     byte ptr DGROUP:_miniSO_delcurthread,0
   1108	03BD  74 07			     je	     short @15@170
   1109					;
   1110					;	     miniSO_delcurthread=0;	   /* zera o flag para deletado	e nao captura SS:SP +
   1111				     */
   1112					;
   1113	03BF  C6 06 0006r 00		     mov     byte ptr DGROUP:_miniSO_delcurthread,0
   1114	03C4  EB 3D			     jmp     short @15@226
   1115	03C6			     @15@170:
   1116					;
   1117					;	  else	{
   1118					;	     /*	Salva SS:SP da thread corrente no BCP */
   1119					;	     miniSO_thread[miniSO_ready].ss=_SS;
   1120					;
   1121	03C6  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1122	03C9  BA 001A			     mov     dx,26
   1123	03CC  F7 EA			     imul    dx
   1124	03CE  8B D8			     mov     bx,ax
   1125	03D0  8C 97 000Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+6],ss
   1126					;
   1127					;	     miniSO_thread[miniSO_ready].sp=_SP;
   1128					;
   1129	03D4  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1130	03D7  BA 001A			     mov     dx,26
   1131	03DA  F7 EA			     imul    dx
   1132	03DC  8B D8			     mov     bx,ax
   1133	03DE  89 A7 000Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+8],sp
   1134					;
   1135					;	     if	(miniSO_thread[miniSO_ready].status==RUNNING)
   1136					;
   1137	03E2  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1138	03E5  BA 001A			     mov     dx,26
   1139	03E8  F7 EA			     imul    dx
   1140	03EA  8B D8			     mov     bx,ax
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 21
scall.ASM



   1141	03EC  83 BF 000Br 01		     cmp     word ptr DGROUP:_miniSO_thread[bx+4],1
   1142	03F1  75 10			     jne     short @15@226
   1143					;
   1144					;		miniSO_thread[miniSO_ready].status=READY;
   1145					;
   1146	03F3  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1147	03F6  BA 001A			     mov     dx,26
   1148	03F9  F7 EA			     imul    dx
   1149	03FB  8B D8			     mov     bx,ax
   1150	03FD  C7 87 000Br 0000		     mov     word ptr DGROUP:_miniSO_thread[bx+4],0
   1151	0403			     @15@226:
   1152					;
   1153					;	  }
   1154					;	  /* Atualiza thread corrente */
   1155					;	  miniSO_ready=miniSO_nextthread;
   1156					;
   1157	0403  A1 0004r			     mov     ax,word ptr DGROUP:_miniSO_nextthread
   1158	0406  A3 0007r			     mov     word ptr DGROUP:_miniSO_ready,ax
   1159					;
   1160					;	  miniSO_thread[miniSO_ready].status=RUNNING;
   1161					;
   1162	0409  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1163	040C  BA 001A			     mov     dx,26
   1164	040F  F7 EA			     imul    dx
   1165	0411  8B D8			     mov     bx,ax
   1166	0413  C7 87 000Br 0001		     mov     word ptr DGROUP:_miniSO_thread[bx+4],1
   1167					;
   1168					;	  /* Define SS:SP para a thread	corrente */
   1169					;	  _SS=miniSO_thread[miniSO_ready].ss;
   1170					;
   1171	0419  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1172	041C  BA 001A			     mov     dx,26
   1173	041F  F7 EA			     imul    dx
   1174	0421  8B D8			     mov     bx,ax
   1175	0423  8E 97 000Dr		     mov     ss,word ptr DGROUP:_miniSO_thread[bx+6]
   1176					;
   1177					;	  _SP=miniSO_thread[miniSO_ready].sp;
   1178					;
   1179	0427  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1180	042A  BA 001A			     mov     dx,26
   1181	042D  F7 EA			     imul    dx
   1182	042F  8B D8			     mov     bx,ax
   1183	0431  8B A7 000Fr		     mov     sp,word ptr DGROUP:_miniSO_thread[bx+8]
   1184	0435			     @15@254:
   1185					;
   1186					;
   1187					;      }
   1188					;      miniSO_nextthread = miniSO_NONE;
   1189					;
   1190	0435  C7 06 0004r FFFF		     mov     word ptr DGROUP:_miniSO_nextthread,-1
   1191					;
   1192					;    }
   1193					;
   1194	043B  5D			     pop     bp
   1195	043C  C3			     ret
   1196	043D			     _miniSO_contextswitch   endp
   1197					;
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 22
scall.ASM



   1198					;    static void end_mso(char *msg)
   1199					;
   1200					     assume  cs:_TEXT
   1201	043D			     end_mso proc    near
   1202	043D  55			     push    bp
   1203	043E  8B EC			     mov     bp,sp
   1204					;
   1205					;    {
   1206					;      /* Restaura a interrupção do relógio original */
   1207					;      setvect(miniSO_CLOCKINT,miniSO_oldisr);
   1208					;
   1209	0440  FF 36 0002r		     push    word ptr DGROUP:_miniSO_oldisr+2
   1210	0444  FF 36 0000r		     push    word ptr DGROUP:_miniSO_oldisr
   1211	0448  B8 001C			     mov     ax,28
   1212	044B  50			     push    ax
   1213	044C  E8 0000e			     call    near ptr _setvect
   1214	044F  83 C4 06			     add     sp,6
   1215					;
   1216					;      enable();
   1217					;
   1218	0452  E8 0000e			     call    near ptr _enable
   1219					;
   1220					;      putstr("\n\n");
   1221					;
   1222	0455  1E			     push    ds
   1223	0456  B8 008Fr			     mov     ax,offset DGROUP:s@
   1224	0459  50			     push    ax
   1225	045A  E8 0000e			     call    near ptr _putstr
   1226	045D  59			     pop     cx
   1227	045E  59			     pop     cx
   1228					;
   1229					;      putstr(msg);
   1230					;
   1231	045F  1E			     push    ds
   1232	0460  FF 76 04			     push    word ptr [bp+4]
   1233	0463  E8 0000e			     call    near ptr _putstr
   1234	0466  59			     pop     cx
   1235	0467  59			     pop     cx
   1236					;
   1237					;      putch('\n');
   1238					;
   1239	0468  B8 000A			     mov     ax,10
   1240	046B  50			     push    ax
   1241	046C  E8 0000e			     call    near ptr _putch
   1242	046F  59			     pop     cx
   1243					;
   1244					;      putstr("Pressione uma tecla para	reiniciar...\n");
   1245					;
   1246	0470  1E			     push    ds
   1247	0471  B8 0092r			     mov     ax,offset DGROUP:s@+3
   1248	0474  50			     push    ax
   1249	0475  E8 0000e			     call    near ptr _putstr
   1250	0478  59			     pop     cx
   1251	0479  59			     pop     cx
   1252					;
   1253					;      getch();
   1254					;
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 23
scall.ASM



   1255	047A  E8 0000e			     call    near ptr _getch
   1256					;
   1257					;      /* Reinicializa a máquina */
   1258					;      sc_reboot();
   1259					;
   1260	047D  E8 0138			     call    near ptr _sc_reboot
   1261					;
   1262					;    }
   1263					;
   1264	0480  5D			     pop     bp
   1265	0481  C3			     ret
   1266	0482			     end_mso endp
   1267					;
   1268					;    static pcb_t get_pcb(pid_t	pid)
   1269					;
   1270					     assume  cs:_TEXT
   1271	0482			     get_pcb proc    near
   1272	0482  55			     push    bp
   1273	0483  8B EC			     mov     bp,sp
   1274					;
   1275					;    {
   1276					;	     pcb_t   pcb;
   1277					;
   1278					;	     for     (pcb=0;pcb<miniSO_MAXTHREADS;++pcb)  {
   1279					;
   1280	0485  33 C9			     xor     cx,cx
   1281	0487  EB 27			     jmp     short @17@198
   1282	0489			     @17@58:
   1283					;
   1284					;		     if	     ( miniSO_thread[pcb].status!=FREE && miniSO_thread		    +
   1285				     [pcb].pid==pid )
   1286					;
   1287	0489  8B C1			     mov     ax,cx
   1288	048B  BA 001A			     mov     dx,26
   1289	048E  F7 EA			     imul    dx
   1290	0490  8B D8			     mov     bx,ax
   1291	0492  83 BF 000Br FF		     cmp     word ptr DGROUP:_miniSO_thread[bx+4],-1
   1292	0497  74 16			     je	     short @17@170
   1293	0499  8B C1			     mov     ax,cx
   1294	049B  BA 001A			     mov     dx,26
   1295	049E  F7 EA			     imul    dx
   1296	04A0  8B D8			     mov     bx,ax
   1297	04A2  8B 87 0007r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx]
   1298	04A6  3B 46 04			     cmp     ax,word ptr [bp+4]
   1299	04A9  75 04			     jne     short @17@170
   1300					;
   1301					;			     return pcb;
   1302					;
   1303	04AB  8B C1			     mov     ax,cx
   1304	04AD			     @17@142:
   1305	04AD  EB 0B			     jmp     short @17@254
   1306	04AF			     @17@170:
   1307	04AF  41			     inc     cx
   1308	04B0			     @17@198:
   1309	04B0  83 F9 10			     cmp     cx,16
   1310	04B3  7C D4			     jl	     short @17@58
   1311					;
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 24
scall.ASM



   1312					;	     }
   1313					;	     return -1;
   1314					;
   1315	04B5  B8 FFFF			     mov     ax,-1
   1316	04B8  EB F3			     jmp     short @17@142
   1317	04BA			     @17@254:
   1318					;
   1319					;    }
   1320					;
   1321	04BA  5D			     pop     bp
   1322	04BB  C3			     ret
   1323	04BC			     get_pcb endp
   1324					;
   1325					;    void miniSO_init_semtable()
   1326					;
   1327					     assume  cs:_TEXT
   1328	04BC			     _miniSO_init_semtable   proc    near
   1329	04BC  55			     push    bp
   1330	04BD  8B EC			     mov     bp,sp
   1331					;
   1332					;    {
   1333					;	     int i;
   1334					;
   1335					;	     for     (i=0;i<miniSO_MAXSEMAPHORES;++i)
   1336					;
   1337	04BF  33 C0			     xor     ax,ax
   1338	04C1  EB 0D			     jmp     short @18@114
   1339	04C3			     @18@58:
   1340					;
   1341					;		     miniSO_sem[i].status = FREE;
   1342					;
   1343	04C3  8B D8			     mov     bx,ax
   1344	04C5  B1 03			     mov     cl,3
   1345	04C7  D3 E3			     shl     bx,cl
   1346	04C9  C7 87 01A7r FFFF		     mov     word ptr DGROUP:_miniSO_sem[bx],-1
   1347	04CF  40			     inc     ax
   1348	04D0			     @18@114:
   1349	04D0  3D 000A			     cmp     ax,10
   1350	04D3  7C EE			     jl	     short @18@58
   1351					;
   1352					;    }
   1353					;
   1354	04D5  5D			     pop     bp
   1355	04D6  C3			     ret
   1356	04D7			     _miniSO_init_semtable   endp
   1357					;
   1358					;    void miniSO_init_proctable()
   1359					;
   1360					     assume  cs:_TEXT
   1361	04D7			     _miniSO_init_proctable  proc    near
   1362	04D7  55			     push    bp
   1363	04D8  8B EC			     mov     bp,sp
   1364	04DA  56			     push    si
   1365					;
   1366					;    {
   1367					;      pcb_t i;
   1368					;
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 25
scall.ASM



   1369					;      disable();
   1370					;
   1371	04DB  E8 0000e			     call    near ptr _disable
   1372					;
   1373					;
   1374					;      /* Inicializa a tabela de semaforos */
   1375					;      miniSO_init_semtable();
   1376					;
   1377	04DE  E8 FFDB			     call    near ptr _miniSO_init_semtable
   1378					;
   1379					;      /* Inicializa tabela de threads */
   1380					;      miniSO_ready =  0;
   1381					;
   1382	04E1  C7 06 0007r 0000		     mov     word ptr DGROUP:_miniSO_ready,0
   1383					;
   1384					;      miniSO_thread[miniSO_ready].pid	    = 0;
   1385					;
   1386	04E7  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1387	04EA  BA 001A			     mov     dx,26
   1388	04ED  F7 EA			     imul    dx
   1389	04EF  8B D8			     mov     bx,ax
   1390	04F1  C7 87 0007r 0000		     mov     word ptr DGROUP:_miniSO_thread[bx],0
   1391					;
   1392					;      miniSO_thread[miniSO_ready].ppid	    = -1;
   1393					;
   1394	04F7  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1395	04FA  BA 001A			     mov     dx,26
   1396	04FD  F7 EA			     imul    dx
   1397	04FF  8B D8			     mov     bx,ax
   1398	0501  C7 87 0009r FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+2],-1
   1399					;
   1400					;      miniSO_thread[miniSO_ready].next	    = miniSO_ready;
   1401					;
   1402	0507  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1403	050A  BA 001A			     mov     dx,26
   1404	050D  F7 EA			     imul    dx
   1405	050F  8B 16 0007r		     mov     dx,word ptr DGROUP:_miniSO_ready
   1406	0513  8B D8			     mov     bx,ax
   1407	0515  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   1408					;
   1409					;      miniSO_thread[miniSO_ready].prev	    = miniSO_ready;
   1410					;
   1411	0519  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1412	051C  BA 001A			     mov     dx,26
   1413	051F  F7 EA			     imul    dx
   1414	0521  8B 16 0007r		     mov     dx,word ptr DGROUP:_miniSO_ready
   1415	0525  8B D8			     mov     bx,ax
   1416	0527  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   1417					;
   1418					;      miniSO_thread[miniSO_ready].status   = RUNNING;
   1419					;
   1420	052B  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1421	052E  BA 001A			     mov     dx,26
   1422	0531  F7 EA			     imul    dx
   1423	0533  8B D8			     mov     bx,ax
   1424	0535  C7 87 000Br 0001		     mov     word ptr DGROUP:_miniSO_thread[bx+4],1
   1425					;
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 26
scall.ASM



   1426					;      miniSO_thread[miniSO_ready].recvsig  = 0;
   1427					;
   1428	053B  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1429	053E  BA 001A			     mov     dx,26
   1430	0541  F7 EA			     imul    dx
   1431	0543  8B D8			     mov     bx,ax
   1432	0545  C7 87 0011r 0000		     mov     word ptr DGROUP:_miniSO_thread[bx+10],0
   1433					;
   1434					;      miniSO_thread[miniSO_ready].wait	    = -1;
   1435					;
   1436	054B  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1437	054E  BA 001A			     mov     dx,26
   1438	0551  F7 EA			     imul    dx
   1439	0553  8B D8			     mov     bx,ax
   1440	0555  C7 87 0015r FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+14],-1
   1441					;
   1442					;      miniSO_thread[miniSO_ready].zombies  = -1;
   1443					;
   1444	055B  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1445	055E  BA 001A			     mov     dx,26
   1446	0561  F7 EA			     imul    dx
   1447	0563  8B D8			     mov     bx,ax
   1448	0565  C7 87 001Br FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+20],-1
   1449					;
   1450					;      /* O resto dos BCPs permanece na	lista de livres	*/
   1451					;      miniSO_free  =  1;
   1452					;
   1453	056B  C7 06 0009r 0001		     mov     word ptr DGROUP:_miniSO_free,1
   1454					;
   1455					;      for ( i=1 ; i<miniSO_MAXTHREADS-1 ; ++i)	 {
   1456					;
   1457	0571  BE 0001			     mov     si,1
   1458	0574  EB 20			     jmp     short @19@114
   1459	0576			     @19@58:
   1460					;
   1461					;	   miniSO_thread[i].next   = i+1;
   1462					;
   1463	0576  8B C6			     mov     ax,si
   1464	0578  BA 001A			     mov     dx,26
   1465	057B  F7 EA			     imul    dx
   1466	057D  8B D6			     mov     dx,si
   1467	057F  42			     inc     dx
   1468	0580  8B D8			     mov     bx,ax
   1469	0582  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   1470					;
   1471					;	   miniSO_thread[i].status = FREE;
   1472					;
   1473	0586  8B C6			     mov     ax,si
   1474	0588  BA 001A			     mov     dx,26
   1475	058B  F7 EA			     imul    dx
   1476	058D  8B D8			     mov     bx,ax
   1477	058F  C7 87 000Br FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+4],-1
   1478	0595  46			     inc     si
   1479	0596			     @19@114:
   1480	0596  83 FE 0F			     cmp     si,15
   1481	0599  7C DB			     jl	     short @19@58
   1482					;
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 27
scall.ASM



   1483					;      }
   1484					;      miniSO_thread[miniSO_MAXTHREADS-1].next	 = -1;
   1485					;
   1486	059B  C7 06 01A5r FFFF		     mov     word ptr DGROUP:_miniSO_thread+414,-1
   1487					;
   1488					;      miniSO_thread[miniSO_MAXTHREADS-1].status = FREE;
   1489					;
   1490	05A1  C7 06 0191r FFFF		     mov     word ptr DGROUP:_miniSO_thread+394,-1
   1491					;
   1492					;      /* Zera tempos do sistema */
   1493					;      miniSO_delcurthread  = 0;
   1494					;
   1495	05A7  C6 06 0006r 00		     mov     byte ptr DGROUP:_miniSO_delcurthread,0
   1496					;
   1497					;      miniSO_nextthread = miniSO_NONE;
   1498					;
   1499	05AC  C7 06 0004r FFFF		     mov     word ptr DGROUP:_miniSO_nextthread,-1
   1500					;
   1501					;      /* Habilita as interrupcoes e retorna */
   1502					;      enable();
   1503					;
   1504	05B2  E8 0000e			     call    near ptr _enable
   1505					;
   1506					;    }
   1507					;
   1508	05B5  5E			     pop     si
   1509	05B6  5D			     pop     bp
   1510	05B7  C3			     ret
   1511	05B8			     _miniSO_init_proctable  endp
   1512					;
   1513					;    int sc_reboot()
   1514					;
   1515					     assume  cs:_TEXT
   1516	05B8			     _sc_reboot	     proc    near
   1517	05B8  55			     push    bp
   1518	05B9  8B EC			     mov     bp,sp
   1519					;
   1520					;    {
   1521					;	     /*	Restaura a interrupção do relógio original */
   1522					;	     setvect(miniSO_CLOCKINT,miniSO_oldisr);
   1523					;
   1524	05BB  FF 36 0002r		     push    word ptr DGROUP:_miniSO_oldisr+2
   1525	05BF  FF 36 0000r		     push    word ptr DGROUP:_miniSO_oldisr
   1526	05C3  B8 001C			     mov     ax,28
   1527	05C6  50			     push    ax
   1528	05C7  E8 0000e			     call    near ptr _setvect
   1529	05CA  83 C4 06			     add     sp,6
   1530					;
   1531					;	     enable();
   1532					;
   1533	05CD  E8 0000e			     call    near ptr _enable
   1534					;
   1535					;	     asm     {
   1536					;		     int     19h
   1537					;
   1538	05D0  CD 19			     int	     19h
   1539					;
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 28
scall.ASM



   1540					;	     }
   1541					;	     return 0;
   1542					;
   1543	05D2  33 C0			     xor     ax,ax
   1544	05D4  EB 00			     jmp     short @20@114
   1545	05D6			     @20@114:
   1546					;
   1547					;    }
   1548					;
   1549	05D6  5D			     pop     bp
   1550	05D7  C3			     ret
   1551	05D8			     _sc_reboot	     endp
   1552	05D8			     _TEXT   ends
   1553	008D			     _DATA   segment word public 'DATA'
   1554	008D  01			     db	     1
   1555	008E  00			     db	     0
   1556	008F			     _DATA   ends
   1557	05D8			     _TEXT   segment byte public 'CODE'
   1558					;
   1559					;    int sc_fork(unsigned cs, unsigned ip)
   1560					;
   1561					     assume  cs:_TEXT
   1562	05D8			     _sc_fork	     proc    near
   1563	05D8  55			     push    bp
   1564	05D9  8B EC			     mov     bp,sp
   1565	05DB  83 EC 06			     sub     sp,6
   1566	05DE  56			     push    si
   1567	05DF  57			     push    di
   1568					;
   1569					;    {
   1570					;	     pid_t	     pid;
   1571					;	     pcb_t	     pcb,last;
   1572					;	     unsigned far *  stack;
   1573					;	     static pid_t    nextpid=1;	/* Número do próximo pid */
   1574					;	     extern void     miniSO_return_addr(void);
   1575					;
   1576					;	     /*	Se o nucleo esta' instalado e existem BCPs livres insere no fim	da lista ...+
   1577				     */
   1578					;	     if	     (miniSO_free == -1)
   1579					;
   1580	05E0  83 3E 0009r FF		     cmp     word ptr DGROUP:_miniSO_free,-1
   1581	05E5  75 06			     jne     short @21@114
   1582					;
   1583					;		     return miniSO_ERROR;
   1584					;
   1585	05E7  B8 FFFF			     mov     ax,-1
   1586	05EA			     @21@86:
   1587	05EA  E9 0241			     jmp     @21@338
   1588	05ED			     @21@114:
   1589					;
   1590					;	     disable();
   1591					;
   1592	05ED  E8 0000e			     call    near ptr _disable
   1593					;
   1594					;	     /*	Gera um	pid para a thread */
   1595					;	     pcb = 0;
   1596					;
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 29
scall.ASM



   1597	05F0  33 F6			     xor     si,si
   1598	05F2  EB 27			     jmp     short @21@282
   1599	05F4			     @21@142:
   1600					;
   1601					;	     while   (pcb!=-1)	{
   1602					;		     pcb = get_pcb (nextpid);
   1603					;
   1604	05F4  FF 36 008Dr		     push    word ptr DGROUP:d@w+141
   1605	05F8  E8 FE87			     call    near ptr get_pcb
   1606	05FB  59			     pop     cx
   1607	05FC  8B F0			     mov     si,ax
   1608					;
   1609					;		     if	     (pcb==-1)
   1610					;
   1611	05FE  83 FE FF			     cmp     si,-1
   1612	0601  75 04			     jne     short @21@198
   1613					;
   1614					;			     pid = nextpid;
   1615					;
   1616	0603  8B 3E 008Dr		     mov     di,word ptr DGROUP:d@w+141
   1617	0607			     @21@198:
   1618					;
   1619					;		     if	     (nextpid==32767)
   1620					;
   1621	0607  81 3E 008Dr 7FFF		     cmp     word ptr DGROUP:d@w+141,32767
   1622	060D  75 08			     jne     short @21@254
   1623					;
   1624					;			     nextpid=1;
   1625					;
   1626	060F  C7 06 008Dr 0001		     mov     word ptr DGROUP:d@w+141,1
   1627	0615  EB 04			     jmp     short @21@282
   1628	0617			     @21@254:
   1629					;
   1630					;		     else
   1631					;			     nextpid++;
   1632					;
   1633	0617  FF 06 008Dr		     inc     word ptr DGROUP:d@w+141
   1634	061B			     @21@282:
   1635	061B  83 FE FF			     cmp     si,-1
   1636	061E  75 D4			     jne     short @21@142
   1637					;
   1638					;	     }
   1639					;	     /*	Retira um BCP da lista de BCPs livres */
   1640					;	     pcb     = miniSO_free;
   1641					;
   1642	0620  8B 36 0009r		     mov     si,word ptr DGROUP:_miniSO_free
   1643					;
   1644					;	     miniSO_free = miniSO_thread[miniSO_free].next;
   1645					;
   1646	0624  A1 0009r			     mov     ax,word ptr DGROUP:_miniSO_free
   1647	0627  BA 001A			     mov     dx,26
   1648	062A  F7 EA			     imul    dx
   1649	062C  8B D8			     mov     bx,ax
   1650	062E  8B 87 001Fr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+24]
   1651	0632  A3 0009r			     mov     word ptr DGROUP:_miniSO_free,ax
   1652					;
   1653					;	     miniSO_thread[pcb].pid = pid;
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 30
scall.ASM



   1654					;
   1655	0635  8B C6			     mov     ax,si
   1656	0637  BA 001A			     mov     dx,26
   1657	063A  F7 EA			     imul    dx
   1658	063C  8B D8			     mov     bx,ax
   1659	063E  89 BF 0007r		     mov     word ptr DGROUP:_miniSO_thread[bx],di
   1660					;
   1661					;	     miniSO_thread[pcb].ppid = miniSO_thread[miniSO_ready].pid;
   1662					;
   1663	0642  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1664	0645  BA 001A			     mov     dx,26
   1665	0648  F7 EA			     imul    dx
   1666	064A  8B D8			     mov     bx,ax
   1667	064C  8B 87 0007r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx]
   1668	0650  50			     push    ax
   1669	0651  8B C6			     mov     ax,si
   1670	0653  BA 001A			     mov     dx,26
   1671	0656  F7 EA			     imul    dx
   1672	0658  8B D8			     mov     bx,ax
   1673	065A  58			     pop     ax
   1674	065B  89 87 0009r		     mov     word ptr DGROUP:_miniSO_thread[bx+2],ax
   1675					;
   1676					;	     /*	Cria pilha da thread */
   1677					;	     stack=(unsigned far *)MK_FP(miniSO_INITSTACKS+(miniSO_STACKSIZE>>4)*	    +
   1678				     (miniSO_MAXTHREADS-1-pcb),miniSO_STACKSIZE);
   1679					;
   1680	065F  B8 0600			     mov     ax,1536
   1681	0662  50			     push    ax
   1682	0663  B8 000F			     mov     ax,15
   1683	0666  2B C6			     sub     ax,si
   1684	0668  BA 0060			     mov     dx,96
   1685	066B  F7 EA			     imul    dx
   1686	066D  05 0D00			     add     ax,3328
   1687	0670  50			     push    ax
   1688	0671  E8 0000e			     call    near ptr _MK_FP
   1689	0674  59			     pop     cx
   1690	0675  59			     pop     cx
   1691	0676  89 56 FC			     mov     word ptr [bp-4],dx
   1692	0679  89 46 FA			     mov     word ptr [bp-6],ax
   1693					;
   1694					;	     /*	Empilha	o endereco da funcao sc_exit, de modo que se	*/
   1695					;	     /*	 a thread sair da funcao sem chamar sc_exit, a thread */
   1696					;	     /*	 seja automaticamente excluida */
   1697					;	     *(--stack)=0; /* Empilha código de	fim a ser enviado para sc_exit */
   1698					;
   1699	067C  83 6E FA 02		     sub     word ptr [bp-6],2
   1700	0680  C4 5E FA			     les     bx,dword ptr [bp-6]
   1701	0683  26: C7 07	0000		     mov     word ptr es:[bx],0
   1702					;
   1703					;	     *(--stack)=miniSO_CODESEGMENT;
   1704					;
   1705	0688  83 6E FA 02		     sub     word ptr [bp-6],2
   1706	068C  C4 5E FA			     les     bx,dword ptr [bp-6]
   1707	068F  26: C7 07	07E0		     mov     word ptr es:[bx],2016
   1708					;
   1709					;	     *(--stack)=(unsigned)sc_exit;
   1710					;
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 31
scall.ASM



   1711	0694  83 6E FA 02		     sub     word ptr [bp-6],2
   1712	0698  C4 5E FA			     les     bx,dword ptr [bp-6]
   1713	069B  26: C7 07	0E81r		     mov     word ptr es:[bx],offset _sc_exit
   1714					;
   1715					;	     *(--stack)=0x0200 ;       /* FLAGS	*/
   1716					;
   1717	06A0  83 6E FA 02		     sub     word ptr [bp-6],2
   1718	06A4  C4 5E FA			     les     bx,dword ptr [bp-6]
   1719	06A7  26: C7 07	0200		     mov     word ptr es:[bx],512
   1720					;
   1721					;	     *(--stack)=cs;	       /* CS */
   1722					;
   1723	06AC  83 6E FA 02		     sub     word ptr [bp-6],2
   1724	06B0  C4 5E FA			     les     bx,dword ptr [bp-6]
   1725	06B3  8B 46 04			     mov     ax,word ptr [bp+4]
   1726	06B6  26: 89 07			     mov     word ptr es:[bx],ax
   1727					;
   1728					;	     *(--stack)=ip;	       /* IP */
   1729					;
   1730	06B9  83 6E FA 02		     sub     word ptr [bp-6],2
   1731	06BD  C4 5E FA			     les     bx,dword ptr [bp-6]
   1732	06C0  8B 46 06			     mov     ax,word ptr [bp+6]
   1733	06C3  26: 89 07			     mov     word ptr es:[bx],ax
   1734					;
   1735					;	     *(--stack)=0;	       /* AX */
   1736					;
   1737	06C6  83 6E FA 02		     sub     word ptr [bp-6],2
   1738	06CA  C4 5E FA			     les     bx,dword ptr [bp-6]
   1739	06CD  26: C7 07	0000		     mov     word ptr es:[bx],0
   1740					;
   1741					;	     *(--stack)=0;	       /* BX */
   1742					;
   1743	06D2  83 6E FA 02		     sub     word ptr [bp-6],2
   1744	06D6  C4 5E FA			     les     bx,dword ptr [bp-6]
   1745	06D9  26: C7 07	0000		     mov     word ptr es:[bx],0
   1746					;
   1747					;	     *(--stack)=0;	       /* CX */
   1748					;
   1749	06DE  83 6E FA 02		     sub     word ptr [bp-6],2
   1750	06E2  C4 5E FA			     les     bx,dword ptr [bp-6]
   1751	06E5  26: C7 07	0000		     mov     word ptr es:[bx],0
   1752					;
   1753					;	     *(--stack)=0;	       /* DX */
   1754					;
   1755	06EA  83 6E FA 02		     sub     word ptr [bp-6],2
   1756	06EE  C4 5E FA			     les     bx,dword ptr [bp-6]
   1757	06F1  26: C7 07	0000		     mov     word ptr es:[bx],0
   1758					;
   1759					;	     *(--stack)=0;	       /* ES */
   1760					;
   1761	06F6  83 6E FA 02		     sub     word ptr [bp-6],2
   1762	06FA  C4 5E FA			     les     bx,dword ptr [bp-6]
   1763	06FD  26: C7 07	0000		     mov     word ptr es:[bx],0
   1764					;
   1765					;	     *(--stack)=miniSO_DATASEGMENT;/* DS */
   1766					;
   1767	0702  83 6E FA 02		     sub     word ptr [bp-6],2
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 32
scall.ASM



   1768	0706  C4 5E FA			     les     bx,dword ptr [bp-6]
   1769	0709  26: C7 07	0B7B		     mov     word ptr es:[bx],2939
   1770					;
   1771					;	     *(--stack)=0;	       /* SI */
   1772					;
   1773	070E  83 6E FA 02		     sub     word ptr [bp-6],2
   1774	0712  C4 5E FA			     les     bx,dword ptr [bp-6]
   1775	0715  26: C7 07	0000		     mov     word ptr es:[bx],0
   1776					;
   1777					;	     *(--stack)=0;	       /* DI */
   1778					;
   1779	071A  83 6E FA 02		     sub     word ptr [bp-6],2
   1780	071E  C4 5E FA			     les     bx,dword ptr [bp-6]
   1781	0721  26: C7 07	0000		     mov     word ptr es:[bx],0
   1782					;
   1783					;	     *(--stack)=0;	       /* BP */
   1784					;
   1785	0726  83 6E FA 02		     sub     word ptr [bp-6],2
   1786	072A  C4 5E FA			     les     bx,dword ptr [bp-6]
   1787	072D  26: C7 07	0000		     mov     word ptr es:[bx],0
   1788					;
   1789					;	     *(--stack)=(unsigned)miniSO_return_addr;
   1790					;
   1791	0732  83 6E FA 02		     sub     word ptr [bp-6],2
   1792	0736  C4 5E FA			     les     bx,dword ptr [bp-6]
   1793	0739  26: C7 07	0000e		     mov     word ptr es:[bx],offset _miniSO_return_addr
   1794					;
   1795					;	     *(--stack)=0;	       /* BP */
   1796					;
   1797	073E  83 6E FA 02		     sub     word ptr [bp-6],2
   1798	0742  C4 5E FA			     les     bx,dword ptr [bp-6]
   1799	0745  26: C7 07	0000		     mov     word ptr es:[bx],0
   1800					;
   1801					;	     /*	Inicializa campos da nova thread */
   1802					;	     miniSO_thread[pcb].ss	 = FP_SEG(stack);
   1803					;
   1804	074A  FF 76 FC			     push    word ptr [bp-4]
   1805	074D  FF 76 FA			     push    word ptr [bp-6]
   1806	0750  E8 0000e			     call    near ptr _FP_SEG
   1807	0753  59			     pop     cx
   1808	0754  59			     pop     cx
   1809	0755  50			     push    ax
   1810	0756  8B C6			     mov     ax,si
   1811	0758  BA 001A			     mov     dx,26
   1812	075B  F7 EA			     imul    dx
   1813	075D  8B D8			     mov     bx,ax
   1814	075F  58			     pop     ax
   1815	0760  89 87 000Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+6],ax
   1816					;
   1817					;	     miniSO_thread[pcb].sp	 = FP_OFF(stack);
   1818					;
   1819	0764  FF 76 FC			     push    word ptr [bp-4]
   1820	0767  FF 76 FA			     push    word ptr [bp-6]
   1821	076A  E8 0000e			     call    near ptr _FP_OFF
   1822	076D  59			     pop     cx
   1823	076E  59			     pop     cx
   1824	076F  50			     push    ax
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 33
scall.ASM



   1825	0770  8B C6			     mov     ax,si
   1826	0772  BA 001A			     mov     dx,26
   1827	0775  F7 EA			     imul    dx
   1828	0777  8B D8			     mov     bx,ax
   1829	0779  58			     pop     ax
   1830	077A  89 87 000Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+8],ax
   1831					;
   1832					;	     miniSO_thread[pcb].status	 = READY;
   1833					;
   1834	077E  8B C6			     mov     ax,si
   1835	0780  BA 001A			     mov     dx,26
   1836	0783  F7 EA			     imul    dx
   1837	0785  8B D8			     mov     bx,ax
   1838	0787  C7 87 000Br 0000		     mov     word ptr DGROUP:_miniSO_thread[bx+4],0
   1839					;
   1840					;	     miniSO_thread[pcb].recvsig	 = 0;
   1841					;
   1842	078D  8B C6			     mov     ax,si
   1843	078F  BA 001A			     mov     dx,26
   1844	0792  F7 EA			     imul    dx
   1845	0794  8B D8			     mov     bx,ax
   1846	0796  C7 87 0011r 0000		     mov     word ptr DGROUP:_miniSO_thread[bx+10],0
   1847					;
   1848					;	     miniSO_thread[pcb].waitsig	 = 0;
   1849					;
   1850	079C  8B C6			     mov     ax,si
   1851	079E  BA 001A			     mov     dx,26
   1852	07A1  F7 EA			     imul    dx
   1853	07A3  8B D8			     mov     bx,ax
   1854	07A5  C7 87 0013r 0000		     mov     word ptr DGROUP:_miniSO_thread[bx+12],0
   1855					;
   1856					;	     miniSO_thread[pcb].wait	 = -1;
   1857					;
   1858	07AB  8B C6			     mov     ax,si
   1859	07AD  BA 001A			     mov     dx,26
   1860	07B0  F7 EA			     imul    dx
   1861	07B2  8B D8			     mov     bx,ax
   1862	07B4  C7 87 0015r FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+14],-1
   1863					;
   1864					;	     miniSO_thread[pcb].waitfor	 = -1;
   1865					;
   1866	07BA  8B C6			     mov     ax,si
   1867	07BC  BA 001A			     mov     dx,26
   1868	07BF  F7 EA			     imul    dx
   1869	07C1  8B D8			     mov     bx,ax
   1870	07C3  C7 87 0017r FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+16],-1
   1871					;
   1872					;	     miniSO_thread[pcb].zombies	 = -1;
   1873					;
   1874	07C9  8B C6			     mov     ax,si
   1875	07CB  BA 001A			     mov     dx,26
   1876	07CE  F7 EA			     imul    dx
   1877	07D0  8B D8			     mov     bx,ax
   1878	07D2  C7 87 001Br FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+20],-1
   1879					;
   1880					;	     /*	Descobre qual a	ultima thread */
   1881					;	     last = miniSO_thread[miniSO_ready].prev;
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 34
scall.ASM



   1882					;
   1883	07D8  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1884	07DB  BA 001A			     mov     dx,26
   1885	07DE  F7 EA			     imul    dx
   1886	07E0  8B D8			     mov     bx,ax
   1887	07E2  8B 87 001Dr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+22]
   1888	07E6  89 46 FE			     mov     word ptr [bp-2],ax
   1889					;
   1890					;	     /*	Acerta links para incluir a nova thread	*/
   1891					;	     miniSO_thread[pcb].prev	  = last;
   1892					;
   1893	07E9  8B C6			     mov     ax,si
   1894	07EB  BA 001A			     mov     dx,26
   1895	07EE  F7 EA			     imul    dx
   1896	07F0  8B 56 FE			     mov     dx,word ptr [bp-2]
   1897	07F3  8B D8			     mov     bx,ax
   1898	07F5  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   1899					;
   1900					;	     miniSO_thread[pcb].next	  = miniSO_ready;
   1901					;
   1902	07F9  8B C6			     mov     ax,si
   1903	07FB  BA 001A			     mov     dx,26
   1904	07FE  F7 EA			     imul    dx
   1905	0800  8B 16 0007r		     mov     dx,word ptr DGROUP:_miniSO_ready
   1906	0804  8B D8			     mov     bx,ax
   1907	0806  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   1908					;
   1909					;	     miniSO_thread[last].next	  = pcb;
   1910					;
   1911	080A  8B 46 FE			     mov     ax,word ptr [bp-2]
   1912	080D  BA 001A			     mov     dx,26
   1913	0810  F7 EA			     imul    dx
   1914	0812  8B D8			     mov     bx,ax
   1915	0814  89 B7 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],si
   1916					;
   1917					;	     miniSO_thread[miniSO_ready].prev =	pcb;
   1918					;
   1919	0818  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1920	081B  BA 001A			     mov     dx,26
   1921	081E  F7 EA			     imul    dx
   1922	0820  8B D8			     mov     bx,ax
   1923	0822  89 B7 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],si
   1924					;
   1925					;	     enable();
   1926					;
   1927	0826  E8 0000e			     call    near ptr _enable
   1928					;
   1929					;	     return pid;
   1930					;
   1931	0829  8B C7			     mov     ax,di
   1932	082B  E9 FDBC			     jmp     @21@86
   1933	082E			     @21@338:
   1934					;
   1935					;    }
   1936					;
   1937	082E  5F			     pop     di
   1938	082F  5E			     pop     si
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 35
scall.ASM



   1939	0830  8B E5			     mov     sp,bp
   1940	0832  5D			     pop     bp
   1941	0833  C3			     ret
   1942	0834			     _sc_fork	     endp
   1943					;
   1944					;    int sc_kill(pid_t pid)
   1945					;
   1946					     assume  cs:_TEXT
   1947	0834			     _sc_kill	     proc    near
   1948	0834  55			     push    bp
   1949	0835  8B EC			     mov     bp,sp
   1950	0837  83 EC 08			     sub     sp,8
   1951	083A  56			     push    si
   1952	083B  57			     push    di
   1953					;
   1954					;    {
   1955					;	     pcb_t pcb,pcbw,last,prevthread,nextthread,pai,i,ant;
   1956					;
   1957					;	     disable();
   1958					;
   1959	083C  E8 0000e			     call    near ptr _disable
   1960					;
   1961					;	     /*	Se remover a thread 0 ... */
   1962					;	     if	     (pid==0)
   1963					;
   1964	083F  83 7E 04 00		     cmp     word ptr [bp+4],0
   1965	0843  75 08			     jne     short @22@86
   1966					;
   1967					;		     end_mso("kill(): thread 0 excluida!");
   1968					;
   1969	0845  B8 00B9r			     mov     ax,offset DGROUP:s@+42
   1970	0848  50			     push    ax
   1971	0849  E8 FBF1			     call    near ptr end_mso
   1972	084C  59			     pop     cx
   1973	084D			     @22@86:
   1974					;
   1975					;	     /*	Tem que	verificar se existe a thread */
   1976					;	     pcb = get_pcb(pid);
   1977					;
   1978	084D  FF 76 04			     push    word ptr [bp+4]
   1979	0850  E8 FC2F			     call    near ptr get_pcb
   1980	0853  59			     pop     cx
   1981	0854  8B F0			     mov     si,ax
   1982					;
   1983					;	     /*	Se nao existe uma thread com este numero, entao	retorna	*/
   1984					;	     if	     (pcb==-1)	{
   1985					;
   1986	0856  83 FE FF			     cmp     si,-1
   1987	0859  75 09			     jne     short @22@170
   1988	085B			     @22@114:
   1989					;
   1990					;		     enable();
   1991					;
   1992	085B  E8 0000e			     call    near ptr _enable
   1993					;
   1994					;		     return miniSO_ERROR;
   1995					;
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 36
scall.ASM



   1996	085E  B8 FFFF			     mov     ax,-1
   1997	0861			     @22@142:
   1998	0861  E9 02B8			     jmp     @22@1206
   1999	0864			     @22@170:
   2000	0864  EB 40			     jmp     short @22@226
   2001	0866			     @22@198:
   2002					;
   2003					;	     }
   2004					;	     /*	Trata os zumbis	do processo, colocando-os na lista de livres */
   2005					;	     i = miniSO_thread[pcb].zombies;
   2006					;	     while   (i!= -1)  {
   2007					;		     miniSO_thread[pcb].zombies	= miniSO_thread[i].next;
   2008					;
   2009	0866  8B C7			     mov     ax,di
   2010	0868  BA 001A			     mov     dx,26
   2011	086B  F7 EA			     imul    dx
   2012	086D  8B D8			     mov     bx,ax
   2013	086F  8B 87 001Fr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+24]
   2014	0873  50			     push    ax
   2015	0874  8B C6			     mov     ax,si
   2016	0876  BA 001A			     mov     dx,26
   2017	0879  F7 EA			     imul    dx
   2018	087B  8B D8			     mov     bx,ax
   2019	087D  58			     pop     ax
   2020	087E  89 87 001Br		     mov     word ptr DGROUP:_miniSO_thread[bx+20],ax
   2021					;
   2022					;		     miniSO_thread[i].next   = miniSO_free;
   2023					;
   2024	0882  8B C7			     mov     ax,di
   2025	0884  BA 001A			     mov     dx,26
   2026	0887  F7 EA			     imul    dx
   2027	0889  8B 16 0009r		     mov     dx,word ptr DGROUP:_miniSO_free
   2028	088D  8B D8			     mov     bx,ax
   2029	088F  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   2030					;
   2031					;		     miniSO_free	     = i;
   2032					;
   2033	0893  89 3E 0009r		     mov     word ptr DGROUP:_miniSO_free,di
   2034					;
   2035					;		     miniSO_thread[i].status = FREE;
   2036					;
   2037	0897  8B C7			     mov     ax,di
   2038	0899  BA 001A			     mov     dx,26
   2039	089C  F7 EA			     imul    dx
   2040	089E  8B D8			     mov     bx,ax
   2041	08A0  C7 87 000Br FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+4],-1
   2042					;
   2043					;		     i = miniSO_thread[pcb].zombies;
   2044					;
   2045	08A6			     @22@226:
   2046	08A6  8B C6			     mov     ax,si
   2047	08A8  BA 001A			     mov     dx,26
   2048	08AB  F7 EA			     imul    dx
   2049	08AD  8B D8			     mov     bx,ax
   2050	08AF  8B BF 001Br		     mov     di,word ptr DGROUP:_miniSO_thread[bx+20]
   2051	08B3  83 FF FF			     cmp     di,-1
   2052	08B6  75 AE			     jne     short @22@198
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 37
scall.ASM



   2053					;
   2054					;	     }
   2055					;	     /*	Passa os filhos	do processo para o avo */
   2056					;	     for     (i=0;i<miniSO_MAXTHREADS;++i)  {
   2057					;
   2058	08B8  33 FF			     xor     di,di
   2059	08BA  EB 4B			     jmp     short @22@422
   2060	08BC			     @22@310:
   2061					;
   2062					;		     if	     (miniSO_thread[i].status!=FREE && miniSO_thread[i].ppid ==	    +
   2063				     miniSO_thread[pcb].pid)
   2064					;
   2065	08BC  8B C7			     mov     ax,di
   2066	08BE  BA 001A			     mov     dx,26
   2067	08C1  F7 EA			     imul    dx
   2068	08C3  8B D8			     mov     bx,ax
   2069	08C5  83 BF 000Br FF		     cmp     word ptr DGROUP:_miniSO_thread[bx+4],-1
   2070	08CA  74 3A			     je	     short @22@394
   2071	08CC  8B C7			     mov     ax,di
   2072	08CE  BA 001A			     mov     dx,26
   2073	08D1  F7 EA			     imul    dx
   2074	08D3  8B D8			     mov     bx,ax
   2075	08D5  8B 87 0009r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+2]
   2076	08D9  50			     push    ax
   2077	08DA  8B C6			     mov     ax,si
   2078	08DC  BA 001A			     mov     dx,26
   2079	08DF  F7 EA			     imul    dx
   2080	08E1  8B D8			     mov     bx,ax
   2081	08E3  58			     pop     ax
   2082	08E4  3B 87 0007r		     cmp     ax,word ptr DGROUP:_miniSO_thread[bx]
   2083	08E8  75 1C			     jne     short @22@394
   2084					;
   2085					;			     miniSO_thread[i].ppid = miniSO_thread[pcb].ppid;
   2086					;
   2087	08EA  8B C6			     mov     ax,si
   2088	08EC  BA 001A			     mov     dx,26
   2089	08EF  F7 EA			     imul    dx
   2090	08F1  8B D8			     mov     bx,ax
   2091	08F3  8B 87 0009r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+2]
   2092	08F7  50			     push    ax
   2093	08F8  8B C7			     mov     ax,di
   2094	08FA  BA 001A			     mov     dx,26
   2095	08FD  F7 EA			     imul    dx
   2096	08FF  8B D8			     mov     bx,ax
   2097	0901  58			     pop     ax
   2098	0902  89 87 0009r		     mov     word ptr DGROUP:_miniSO_thread[bx+2],ax
   2099	0906			     @22@394:
   2100	0906  47			     inc     di
   2101	0907			     @22@422:
   2102	0907  83 FF 10			     cmp     di,16
   2103	090A  7C B0			     jl	     short @22@310
   2104					;
   2105					;	     }
   2106					;	     /*	Salva anterior e proximo da thread que sera deletada */
   2107					;	     prevthread	= miniSO_thread[pcb].prev;
   2108					;
   2109	090C  8B C6			     mov     ax,si
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 38
scall.ASM



   2110	090E  BA 001A			     mov     dx,26
   2111	0911  F7 EA			     imul    dx
   2112	0913  8B D8			     mov     bx,ax
   2113	0915  8B 87 001Dr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+22]
   2114	0919  89 46 FC			     mov     word ptr [bp-4],ax
   2115					;
   2116					;	     nextthread	= miniSO_thread[pcb].next;
   2117					;
   2118	091C  8B C6			     mov     ax,si
   2119	091E  BA 001A			     mov     dx,26
   2120	0921  F7 EA			     imul    dx
   2121	0923  8B D8			     mov     bx,ax
   2122	0925  8B 87 001Fr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+24]
   2123	0929  89 46 FA			     mov     word ptr [bp-6],ax
   2124					;
   2125					;	     /*	A thread pode estar em um de varios estados... */
   2126					;	     switch  (miniSO_thread[pcb].status)  {
   2127					;
   2128	092C  8B C6			     mov     ax,si
   2129	092E  BA 001A			     mov     dx,26
   2130	0931  F7 EA			     imul    dx
   2131	0933  8B D8			     mov     bx,ax
   2132	0935  8B 9F 000Br		     mov     bx,word ptr DGROUP:_miniSO_thread[bx+4]
   2133	0939  83 FB 05			     cmp     bx,5
   2134	093C  77 53			     ja	     short @22@758
   2135	093E  D1 E3			     shl     bx,1
   2136	0940  2E: FF A7	0B22r		     jmp     word ptr cs:@22@C1250[bx]
   2137	0945			     @22@562:
   2138					;
   2139					;		     case    READY:
   2140					;		     case    RUNNING:
   2141					;			     /*	Exclui o nodo da lista de prontos */
   2142					;			     miniSO_thread[prevthread].next=nextthread;
   2143					;
   2144	0945  8B 46 FC			     mov     ax,word ptr [bp-4]
   2145	0948  BA 001A			     mov     dx,26
   2146	094B  F7 EA			     imul    dx
   2147	094D  8B 56 FA			     mov     dx,word ptr [bp-6]
   2148	0950  8B D8			     mov     bx,ax
   2149	0952  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   2150					;
   2151					;			     miniSO_thread[nextthread].prev=prevthread;
   2152					;
   2153	0956  8B 46 FA			     mov     ax,word ptr [bp-6]
   2154	0959  BA 001A			     mov     dx,26
   2155	095C  F7 EA			     imul    dx
   2156	095E  8B 56 FC			     mov     dx,word ptr [bp-4]
   2157	0961  8B D8			     mov     bx,ax
   2158	0963  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   2159					;
   2160					;			     if	     (pcb==miniSO_ready)  {
   2161					;
   2162	0967  3B 36 0007r		     cmp     si,word ptr DGROUP:_miniSO_ready
   2163	096B  75 1E			     jne     short @22@674
   2164					;
   2165					;				     if	     (nextthread==miniSO_ready)
   2166					;
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 39
scall.ASM



   2167	096D  8B 46 FA			     mov     ax,word ptr [bp-6]
   2168	0970  3B 06 0007r		     cmp     ax,word ptr DGROUP:_miniSO_ready
   2169	0974  75 0A			     jne     short @22@646
   2170					;
   2171					;					     end_mso("kill(): nao ha' mais threads	    +
   2172				     executando!");
   2173					;
   2174	0976  B8 00D4r			     mov     ax,offset DGROUP:s@+69
   2175	0979  50			     push    ax
   2176	097A  E8 FAC0			     call    near ptr end_mso
   2177	097D  59			     pop     cx
   2178	097E  EB 0B			     jmp     short @22@674
   2179	0980			     @22@646:
   2180					;
   2181					;				     else  {
   2182					;					     miniSO_nextthread=nextthread;
   2183					;
   2184	0980  8B 46 FA			     mov     ax,word ptr [bp-6]
   2185	0983  A3 0004r			     mov     word ptr DGROUP:_miniSO_nextthread,ax
   2186					;
   2187					;					     miniSO_delcurthread=1;
   2188					;
   2189	0986  C6 06 0006r 01		     mov     byte ptr DGROUP:_miniSO_delcurthread,1
   2190	098B			     @22@674:
   2191					;
   2192					;				     }
   2193					;			     }
   2194					;			     break;
   2195					;
   2196	098B  EB 07			     jmp     short @22@786
   2197	098D			     @22@702:
   2198					;
   2199					;		     case    WAITSEM:
   2200					;			     /*	Exclui o nodo da lista do semaforo */
   2201					;			     break;
   2202					;
   2203	098D  EB 05			     jmp     short @22@786
   2204	098F			     @22@730:
   2205					;
   2206					;		     case    WAIT:
   2207					;		     case    WAITSIG:
   2208					;			     break;
   2209					;
   2210	098F  EB 03			     jmp     short @22@786
   2211	0991			     @22@758:
   2212	0991  E9 FEC7			     jmp     @22@114
   2213	0994			     @22@786:
   2214					;
   2215					;		     case    ZOMBIE:
   2216					;		     default:
   2217					;			     enable();
   2218					;			     return miniSO_ERROR;
   2219					;	     }
   2220					;	     /*	Coloca o BCP da	thread na lista	de filhos zumbis do pai	*/
   2221					;	     pai = get_pcb(miniSO_thread[pcb].ppid);
   2222					;
   2223	0994  8B C6			     mov     ax,si
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 40
scall.ASM



   2224	0996  BA 001A			     mov     dx,26
   2225	0999  F7 EA			     imul    dx
   2226	099B  8B D8			     mov     bx,ax
   2227	099D  FF B7 0009r		     push    word ptr DGROUP:_miniSO_thread[bx+2]
   2228	09A1  E8 FADE			     call    near ptr get_pcb
   2229	09A4  59			     pop     cx
   2230	09A5  89 46 F8			     mov     word ptr [bp-8],ax
   2231					;
   2232					;	     if	     (pai==-1) { /* Se nao encontrou o pai, */
   2233					;
   2234	09A8  83 7E F8 FF		     cmp     word ptr [bp-8],-1
   2235	09AC  75 27			     jne     short @22@842
   2236					;
   2237					;		     /*	coloca o processo na lista de livres */
   2238					;		     miniSO_thread[pcb].status = FREE;
   2239					;
   2240	09AE  8B C6			     mov     ax,si
   2241	09B0  BA 001A			     mov     dx,26
   2242	09B3  F7 EA			     imul    dx
   2243	09B5  8B D8			     mov     bx,ax
   2244	09B7  C7 87 000Br FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+4],-1
   2245					;
   2246					;		     miniSO_thread[pcb].next = miniSO_free;
   2247					;
   2248	09BD  8B C6			     mov     ax,si
   2249	09BF  BA 001A			     mov     dx,26
   2250	09C2  F7 EA			     imul    dx
   2251	09C4  8B 16 0009r		     mov     dx,word ptr DGROUP:_miniSO_free
   2252	09C8  8B D8			     mov     bx,ax
   2253	09CA  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   2254					;
   2255					;		     miniSO_free=pcb;
   2256					;
   2257	09CE  89 36 0009r		     mov     word ptr DGROUP:_miniSO_free,si
   2258					;
   2259					;	     }
   2260					;
   2261	09D2  E9 0095			     jmp     @22@1038
   2262	09D5			     @22@842:
   2263					;
   2264					;	     else  {
   2265					;		     /*	senao, coloca o	processo na lista de zumbis do pai */
   2266					;		     miniSO_thread[pcb].status = ZOMBIE;
   2267					;
   2268	09D5  8B C6			     mov     ax,si
   2269	09D7  BA 001A			     mov     dx,26
   2270	09DA  F7 EA			     imul    dx
   2271	09DC  8B D8			     mov     bx,ax
   2272	09DE  C7 87 000Br 0002		     mov     word ptr DGROUP:_miniSO_thread[bx+4],2
   2273					;
   2274					;		     if	     (miniSO_thread[pai].zombies==-1) {	/* Se a	lista esta vazia */
   2275					;
   2276	09E4  8B 46 F8			     mov     ax,word ptr [bp-8]
   2277	09E7  BA 001A			     mov     dx,26
   2278	09EA  F7 EA			     imul    dx
   2279	09EC  8B D8			     mov     bx,ax
   2280	09EE  83 BF 001Br FF		     cmp     word ptr DGROUP:_miniSO_thread[bx+20],-1
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 41
scall.ASM



   2281	09F3  75 1F			     jne     short @22@898
   2282					;
   2283					;			     /*	Insere no inicio */
   2284					;			     miniSO_thread[pai].zombies	= pcb;
   2285					;
   2286	09F5  8B 46 F8			     mov     ax,word ptr [bp-8]
   2287	09F8  BA 001A			     mov     dx,26
   2288	09FB  F7 EA			     imul    dx
   2289	09FD  8B D8			     mov     bx,ax
   2290	09FF  89 B7 001Br		     mov     word ptr DGROUP:_miniSO_thread[bx+20],si
   2291					;
   2292					;			     miniSO_thread[pcb].prev = -1;
   2293					;
   2294	0A03  8B C6			     mov     ax,si
   2295	0A05  BA 001A			     mov     dx,26
   2296	0A08  F7 EA			     imul    dx
   2297	0A0A  8B D8			     mov     bx,ax
   2298	0A0C  C7 87 001Dr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+22],-1
   2299					;
   2300					;		     }
   2301					;
   2302	0A12  EB 47			     jmp     short @22@1010
   2303	0A14			     @22@898:
   2304					;
   2305					;		     else {
   2306					;			     /*	Senao insere no	final */
   2307					;			     i = miniSO_thread[pai].zombies;
   2308					;
   2309	0A14  8B 46 F8			     mov     ax,word ptr [bp-8]
   2310	0A17  BA 001A			     mov     dx,26
   2311	0A1A  F7 EA			     imul    dx
   2312	0A1C  8B D8			     mov     bx,ax
   2313	0A1E  8B BF 001Br		     mov     di,word ptr DGROUP:_miniSO_thread[bx+20]
   2314	0A22  EB 0D			     jmp     short @22@954
   2315	0A24			     @22@926:
   2316					;
   2317					;			     while   (miniSO_thread[i].next!=-1)
   2318					;				     i = miniSO_thread[i].next;
   2319					;
   2320	0A24  8B C7			     mov     ax,di
   2321	0A26  BA 001A			     mov     dx,26
   2322	0A29  F7 EA			     imul    dx
   2323	0A2B  8B D8			     mov     bx,ax
   2324	0A2D  8B BF 001Fr		     mov     di,word ptr DGROUP:_miniSO_thread[bx+24]
   2325	0A31			     @22@954:
   2326	0A31  8B C7			     mov     ax,di
   2327	0A33  BA 001A			     mov     dx,26
   2328	0A36  F7 EA			     imul    dx
   2329	0A38  8B D8			     mov     bx,ax
   2330	0A3A  83 BF 001Fr FF		     cmp     word ptr DGROUP:_miniSO_thread[bx+24],-1
   2331	0A3F  75 E3			     jne     short @22@926
   2332					;
   2333					;			     miniSO_thread[i].next = pcb;
   2334					;
   2335	0A41  8B C7			     mov     ax,di
   2336	0A43  BA 001A			     mov     dx,26
   2337	0A46  F7 EA			     imul    dx
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 42
scall.ASM



   2338	0A48  8B D8			     mov     bx,ax
   2339	0A4A  89 B7 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],si
   2340					;
   2341					;			     miniSO_thread[pcb].prev = i;
   2342					;
   2343	0A4E  8B C6			     mov     ax,si
   2344	0A50  BA 001A			     mov     dx,26
   2345	0A53  F7 EA			     imul    dx
   2346	0A55  8B D8			     mov     bx,ax
   2347	0A57  89 BF 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],di
   2348	0A5B			     @22@1010:
   2349					;
   2350					;		     }
   2351					;		     miniSO_thread[pcb].next = -1;
   2352					;
   2353	0A5B  8B C6			     mov     ax,si
   2354	0A5D  BA 001A			     mov     dx,26
   2355	0A60  F7 EA			     imul    dx
   2356	0A62  8B D8			     mov     bx,ax
   2357	0A64  C7 87 001Fr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+24],-1
   2358	0A6A			     @22@1038:
   2359					;
   2360					;	     }
   2361					;	     if	     (miniSO_thread[pai].status==WAIT) {
   2362					;
   2363	0A6A  8B 46 F8			     mov     ax,word ptr [bp-8]
   2364	0A6D  BA 001A			     mov     dx,26
   2365	0A70  F7 EA			     imul    dx
   2366	0A72  8B D8			     mov     bx,ax
   2367	0A74  83 BF 000Br 03		     cmp     word ptr DGROUP:_miniSO_thread[bx+4],3
   2368	0A79  75 00			     jne     short @22@1066
   2369	0A7B			     @22@1066:
   2370					;
   2371					;	     }
   2372					;	     /*	REVISAR	*/
   2373					;      /* Se o processo-pai esta' esperando em wait, coloca ele	na lista de prontos */
   2374					;      nextthread = miniSO_thread[pcb].wait;
   2375					;
   2376	0A7B  8B C6			     mov     ax,si
   2377	0A7D  BA 001A			     mov     dx,26
   2378	0A80  F7 EA			     imul    dx
   2379	0A82  8B D8			     mov     bx,ax
   2380	0A84  8B 87 0015r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+14]
   2381	0A88  89 46 FA			     mov     word ptr [bp-6],ax
   2382					;
   2383					;      if (nextthread != -1)  {
   2384					;
   2385	0A8B  83 7E FA FF		     cmp     word ptr [bp-6],-1
   2386	0A8F  75 03			     jne     @@2
   2387	0A91  EB 77 90			     jmp     @22@1122
   2388	0A94			     @@2:
   2389					;
   2390					;	  /* Descobre qual a ultima thread */
   2391					;	  last = miniSO_thread[miniSO_ready].prev;
   2392					;
   2393	0A94  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   2394	0A97  BA 001A			     mov     dx,26
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 43
scall.ASM



   2395	0A9A  F7 EA			     imul    dx
   2396	0A9C  8B D8			     mov     bx,ax
   2397	0A9E  8B 87 001Dr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+22]
   2398	0AA2  89 46 FE			     mov     word ptr [bp-2],ax
   2399					;
   2400					;	  /* Acerta links para incluir a thread	no final da lista de prontos*/
   2401					;	  miniSO_thread[nextthread].prev    = last;
   2402					;
   2403	0AA5  8B 46 FA			     mov     ax,word ptr [bp-6]
   2404	0AA8  BA 001A			     mov     dx,26
   2405	0AAB  F7 EA			     imul    dx
   2406	0AAD  8B 56 FE			     mov     dx,word ptr [bp-2]
   2407	0AB0  8B D8			     mov     bx,ax
   2408	0AB2  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   2409					;
   2410					;	  miniSO_thread[nextthread].next    = miniSO_ready;
   2411					;
   2412	0AB6  8B 46 FA			     mov     ax,word ptr [bp-6]
   2413	0AB9  BA 001A			     mov     dx,26
   2414	0ABC  F7 EA			     imul    dx
   2415	0ABE  8B 16 0007r		     mov     dx,word ptr DGROUP:_miniSO_ready
   2416	0AC2  8B D8			     mov     bx,ax
   2417	0AC4  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   2418					;
   2419					;	  miniSO_thread[last].next	    = nextthread;
   2420					;
   2421	0AC8  8B 46 FE			     mov     ax,word ptr [bp-2]
   2422	0ACB  BA 001A			     mov     dx,26
   2423	0ACE  F7 EA			     imul    dx
   2424	0AD0  8B 56 FA			     mov     dx,word ptr [bp-6]
   2425	0AD3  8B D8			     mov     bx,ax
   2426	0AD5  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   2427					;
   2428					;	  miniSO_thread[miniSO_ready].prev  = nextthread;
   2429					;
   2430	0AD9  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   2431	0ADC  BA 001A			     mov     dx,26
   2432	0ADF  F7 EA			     imul    dx
   2433	0AE1  8B 56 FA			     mov     dx,word ptr [bp-6]
   2434	0AE4  8B D8			     mov     bx,ax
   2435	0AE6  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   2436					;
   2437					;	  miniSO_thread[nextthread].exitcode = miniSO_ERROR;
   2438					;
   2439	0AEA  8B 46 FA			     mov     ax,word ptr [bp-6]
   2440	0AED  BA 001A			     mov     dx,26
   2441	0AF0  F7 EA			     imul    dx
   2442	0AF2  8B D8			     mov     bx,ax
   2443	0AF4  C7 87 0019r FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+18],-1
   2444					;
   2445					;	  miniSO_thread[nextthread].status  = READY;
   2446					;
   2447	0AFA  8B 46 FA			     mov     ax,word ptr [bp-6]
   2448	0AFD  BA 001A			     mov     dx,26
   2449	0B00  F7 EA			     imul    dx
   2450	0B02  8B D8			     mov     bx,ax
   2451	0B04  C7 87 000Br 0000		     mov     word ptr DGROUP:_miniSO_thread[bx+4],0
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 44
scall.ASM



   2452	0B0A			     @22@1122:
   2453					;
   2454					;      }
   2455					;
   2456					;	     enable();
   2457					;
   2458	0B0A  E8 0000e			     call    near ptr _enable
   2459					;
   2460					;	     if	     (miniSO_delcurthread)
   2461					;
   2462	0B0D  80 3E 0006r 00		     cmp     byte ptr DGROUP:_miniSO_delcurthread,0
   2463	0B12  74 02			     je	     short @22@1178
   2464	0B14			     @22@1150:
   2465	0B14  EB FE			     jmp     short @22@1150
   2466	0B16			     @22@1178:
   2467					;
   2468					;		     while   (1)
   2469					;			     ;
   2470					;	     return miniSO_OK;
   2471					;
   2472	0B16  B8 0001			     mov     ax,1
   2473	0B19  E9 FD45			     jmp     @22@142
   2474	0B1C			     @22@1206:
   2475					;
   2476					;    }
   2477					;
   2478	0B1C  5F			     pop     di
   2479	0B1D  5E			     pop     si
   2480	0B1E  8B E5			     mov     sp,bp
   2481	0B20  5D			     pop     bp
   2482	0B21  C3			     ret
   2483	0B22			     _sc_kill	     endp
   2484	0B22			     @22@C1250	     label   word
   2485	0B22  0945r			     dw	     @22@562
   2486	0B24  0945r			     dw	     @22@562
   2487	0B26  0991r			     dw	     @22@758
   2488	0B28  098Fr			     dw	     @22@730
   2489	0B2A  098Fr			     dw	     @22@730
   2490	0B2C  098Dr			     dw	     @22@702
   2491					;
   2492					;    int sc_waitpid(pid_t pid,unsigned seg,unsigned off)
   2493					;
   2494					     assume  cs:_TEXT
   2495	0B2E			     _sc_waitpid     proc    near
   2496	0B2E  55			     push    bp
   2497	0B2F  8B EC			     mov     bp,sp
   2498	0B31  83 EC 08			     sub     sp,8
   2499	0B34  56			     push    si
   2500	0B35  57			     push    di
   2501					;
   2502					;    {
   2503					;	     pcb_t pcb,pcbw,prevthread,nextthread,atual;
   2504					;	     int far *p_ref;
   2505					;
   2506					;	     disable();
   2507					;
   2508	0B36  E8 0000e			     call    near ptr _disable
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 45
scall.ASM



   2509					;
   2510					;	     /*	Tem que	verificar se existe a thread */
   2511					;	     pcb = get_pcb(pid);
   2512					;
   2513	0B39  FF 76 04			     push    word ptr [bp+4]
   2514	0B3C  E8 F943			     call    near ptr get_pcb
   2515	0B3F  59			     pop     cx
   2516	0B40  89 46 FE			     mov     word ptr [bp-2],ax
   2517					;
   2518					;	     /*	Se nao existe uma thread com este numero ou se não é pai da thread, entao   +
   2519				     retorna */
   2520					;	     if	     (pcb==-1 || miniSO_thread[pcb].ppid != miniSO_thread[miniSO_ready].pid)+
   2521				     {
   2522					;
   2523	0B43  83 7E FE FF		     cmp     word ptr [bp-2],-1
   2524	0B47  74 20			     je	     short @23@86
   2525	0B49  8B 46 FE			     mov     ax,word ptr [bp-2]
   2526	0B4C  BA 001A			     mov     dx,26
   2527	0B4F  F7 EA			     imul    dx
   2528	0B51  8B D8			     mov     bx,ax
   2529	0B53  8B 87 0009r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+2]
   2530	0B57  50			     push    ax
   2531	0B58  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   2532	0B5B  BA 001A			     mov     dx,26
   2533	0B5E  F7 EA			     imul    dx
   2534	0B60  8B D8			     mov     bx,ax
   2535	0B62  58			     pop     ax
   2536	0B63  3B 87 0007r		     cmp     ax,word ptr DGROUP:_miniSO_thread[bx]
   2537	0B67  74 09			     je	     short @23@142
   2538	0B69			     @23@86:
   2539					;
   2540					;		     enable();
   2541					;
   2542	0B69  E8 0000e			     call    near ptr _enable
   2543					;
   2544					;		     return miniSO_ERROR;
   2545					;
   2546	0B6C  B8 FFFF			     mov     ax,-1
   2547	0B6F			     @23@114:
   2548	0B6F  E9 0189			     jmp     @23@534
   2549	0B72			     @23@142:
   2550					;
   2551					;	     }
   2552					;	     if	     (miniSO_thread[pcb].status!=ZOMBIE)  {
   2553					;
   2554	0B72  8B 46 FE			     mov     ax,word ptr [bp-2]
   2555	0B75  BA 001A			     mov     dx,26
   2556	0B78  F7 EA			     imul    dx
   2557	0B7A  8B D8			     mov     bx,ax
   2558	0B7C  83 BF 000Br 02		     cmp     word ptr DGROUP:_miniSO_thread[bx+4],2
   2559	0B81  75 03			     jne     @@3
   2560	0B83  E9 00B2			     jmp     @23@310
   2561	0B86			     @@3:
   2562					;
   2563					;		     /*	O processo-filho ainda esta em execucao... */
   2564					;		     atual = miniSO_ready;
   2565					;
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 46
scall.ASM



   2566	0B86  8B 36 0007r		     mov     si,word ptr DGROUP:_miniSO_ready
   2567					;
   2568					;		     prevthread	= miniSO_thread[atual].prev;
   2569					;
   2570	0B8A  8B C6			     mov     ax,si
   2571	0B8C  BA 001A			     mov     dx,26
   2572	0B8F  F7 EA			     imul    dx
   2573	0B91  8B D8			     mov     bx,ax
   2574	0B93  8B 87 001Dr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+22]
   2575	0B97  89 46 FC			     mov     word ptr [bp-4],ax
   2576					;
   2577					;		     nextthread	= miniSO_thread[atual].next;
   2578					;
   2579	0B9A  8B C6			     mov     ax,si
   2580	0B9C  BA 001A			     mov     dx,26
   2581	0B9F  F7 EA			     imul    dx
   2582	0BA1  8B D8			     mov     bx,ax
   2583	0BA3  8B BF 001Fr		     mov     di,word ptr DGROUP:_miniSO_thread[bx+24]
   2584					;
   2585					;		     /*	Se eh a	ultima thread ... */
   2586					;		     if	     (atual == nextthread)
   2587					;
   2588	0BA7  3B F7			     cmp     si,di
   2589	0BA9  75 08			     jne     short @23@226
   2590					;
   2591					;			     end_mso("waitpid(): nao ha' mais threads executando!");
   2592					;
   2593	0BAB  B8 00FDr			     mov     ax,offset DGROUP:s@+110
   2594	0BAE  50			     push    ax
   2595	0BAF  E8 F88B			     call    near ptr end_mso
   2596	0BB2  59			     pop     cx
   2597	0BB3			     @23@226:
   2598					;
   2599					;		     /*	Vincula	o BCP da thread	atual ao BCP da	thread "destino" */
   2600					;		     miniSO_thread[pcb].wait = atual;
   2601					;
   2602	0BB3  8B 46 FE			     mov     ax,word ptr [bp-2]
   2603	0BB6  BA 001A			     mov     dx,26
   2604	0BB9  F7 EA			     imul    dx
   2605	0BBB  8B D8			     mov     bx,ax
   2606	0BBD  89 B7 0015r		     mov     word ptr DGROUP:_miniSO_thread[bx+14],si
   2607					;
   2608					;		     miniSO_thread[atual].prev = -1;
   2609					;
   2610	0BC1  8B C6			     mov     ax,si
   2611	0BC3  BA 001A			     mov     dx,26
   2612	0BC6  F7 EA			     imul    dx
   2613	0BC8  8B D8			     mov     bx,ax
   2614	0BCA  C7 87 001Dr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+22],-1
   2615					;
   2616					;		     miniSO_thread[atual].next = -1;
   2617					;
   2618	0BD0  8B C6			     mov     ax,si
   2619	0BD2  BA 001A			     mov     dx,26
   2620	0BD5  F7 EA			     imul    dx
   2621	0BD7  8B D8			     mov     bx,ax
   2622	0BD9  C7 87 001Fr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+24],-1
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 47
scall.ASM



   2623					;
   2624					;		     miniSO_thread[atual].waitfor = pcb;
   2625					;
   2626	0BDF  8B C6			     mov     ax,si
   2627	0BE1  BA 001A			     mov     dx,26
   2628	0BE4  F7 EA			     imul    dx
   2629	0BE6  8B 56 FE			     mov     dx,word ptr [bp-2]
   2630	0BE9  8B D8			     mov     bx,ax
   2631	0BEB  89 97 0017r		     mov     word ptr DGROUP:_miniSO_thread[bx+16],dx
   2632					;
   2633					;		     miniSO_thread[atual].status = WAIT;
   2634					;
   2635	0BEF  8B C6			     mov     ax,si
   2636	0BF1  BA 001A			     mov     dx,26
   2637	0BF4  F7 EA			     imul    dx
   2638	0BF6  8B D8			     mov     bx,ax
   2639	0BF8  C7 87 000Br 0003		     mov     word ptr DGROUP:_miniSO_thread[bx+4],3
   2640					;
   2641					;		     /*	Exclui o nodo da lista de prontos */
   2642					;		     miniSO_thread[prevthread].next=nextthread;
   2643					;
   2644	0BFE  8B 46 FC			     mov     ax,word ptr [bp-4]
   2645	0C01  BA 001A			     mov     dx,26
   2646	0C04  F7 EA			     imul    dx
   2647	0C06  8B D8			     mov     bx,ax
   2648	0C08  89 BF 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],di
   2649					;
   2650					;		     miniSO_thread[nextthread].prev=prevthread;
   2651					;
   2652	0C0C  8B C7			     mov     ax,di
   2653	0C0E  BA 001A			     mov     dx,26
   2654	0C11  F7 EA			     imul    dx
   2655	0C13  8B 56 FC			     mov     dx,word ptr [bp-4]
   2656	0C16  8B D8			     mov     bx,ax
   2657	0C18  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   2658					;
   2659					;		     miniSO_nextthread=nextthread;
   2660					;
   2661	0C1C  89 3E 0004r		     mov     word ptr DGROUP:_miniSO_nextthread,di
   2662					;
   2663					;		     enable();
   2664					;
   2665	0C20  E8 0000e			     call    near ptr _enable
   2666	0C23  EB 00			     jmp     short @23@254
   2667	0C25			     @23@254:
   2668					;
   2669					;		     while   (miniSO_thread[atual].status == WAIT)
   2670					;
   2671	0C25  8B C6			     mov     ax,si
   2672	0C27  BA 001A			     mov     dx,26
   2673	0C2A  F7 EA			     imul    dx
   2674	0C2C  8B D8			     mov     bx,ax
   2675	0C2E  83 BF 000Br 03		     cmp     word ptr DGROUP:_miniSO_thread[bx+4],3
   2676	0C33  74 F0			     je	     short @23@254
   2677					;
   2678					;			     ;
   2679					;		     disable();
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 48
scall.ASM



   2680					;
   2681	0C35  E8 0000e			     call    near ptr _disable
   2682	0C38			     @23@310:
   2683					;
   2684					;	     }
   2685					;	     /*	O processo filho ja terminou...	*/
   2686					;	     /*	Retira o processo filho	da lista de zumbis do pai */
   2687					;	     atual = pcb;
   2688					;
   2689	0C38  8B 76 FE			     mov     si,word ptr [bp-2]
   2690					;
   2691					;	     prevthread	= miniSO_thread[atual].prev;
   2692					;
   2693	0C3B  8B C6			     mov     ax,si
   2694	0C3D  BA 001A			     mov     dx,26
   2695	0C40  F7 EA			     imul    dx
   2696	0C42  8B D8			     mov     bx,ax
   2697	0C44  8B 87 001Dr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+22]
   2698	0C48  89 46 FC			     mov     word ptr [bp-4],ax
   2699					;
   2700					;	     nextthread	= miniSO_thread[atual].next;
   2701					;
   2702	0C4B  8B C6			     mov     ax,si
   2703	0C4D  BA 001A			     mov     dx,26
   2704	0C50  F7 EA			     imul    dx
   2705	0C52  8B D8			     mov     bx,ax
   2706	0C54  8B BF 001Fr		     mov     di,word ptr DGROUP:_miniSO_thread[bx+24]
   2707					;
   2708					;	     if	     (prevthread == -1)	 { /* E	o primeiro da lista */
   2709					;
   2710	0C58  83 7E FC FF		     cmp     word ptr [bp-4],-1
   2711	0C5C  75 24			     jne     short @23@422
   2712					;
   2713					;		     miniSO_thread[miniSO_ready].zombies = nextthread;
   2714					;
   2715	0C5E  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   2716	0C61  BA 001A			     mov     dx,26
   2717	0C64  F7 EA			     imul    dx
   2718	0C66  8B D8			     mov     bx,ax
   2719	0C68  89 BF 001Br		     mov     word ptr DGROUP:_miniSO_thread[bx+20],di
   2720					;
   2721					;		     if	     (nextthread != -1)
   2722					;
   2723	0C6C  83 FF FF			     cmp     di,-1
   2724	0C6F  74 0F			     je	     short @23@394
   2725					;
   2726					;			     miniSO_thread[nextthread].prev = -1;
   2727					;
   2728	0C71  8B C7			     mov     ax,di
   2729	0C73  BA 001A			     mov     dx,26
   2730	0C76  F7 EA			     imul    dx
   2731	0C78  8B D8			     mov     bx,ax
   2732	0C7A  C7 87 001Dr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+22],-1
   2733	0C80			     @23@394:
   2734					;
   2735					;	     }
   2736					;
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 49
scall.ASM



   2737	0C80  EB 0E			     jmp     short @23@450
   2738	0C82			     @23@422:
   2739					;
   2740					;	     else
   2741					;		     miniSO_thread[prevthread].next = nextthread;
   2742					;
   2743	0C82  8B 46 FC			     mov     ax,word ptr [bp-4]
   2744	0C85  BA 001A			     mov     dx,26
   2745	0C88  F7 EA			     imul    dx
   2746	0C8A  8B D8			     mov     bx,ax
   2747	0C8C  89 BF 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],di
   2748	0C90			     @23@450:
   2749					;
   2750					;	     if	     (nextthread != -1)
   2751					;
   2752	0C90  83 FF FF			     cmp     di,-1
   2753	0C93  74 10			     je	     short @23@506
   2754					;
   2755					;		     miniSO_thread[nextthread].prev = prevthread;
   2756					;
   2757	0C95  8B C7			     mov     ax,di
   2758	0C97  BA 001A			     mov     dx,26
   2759	0C9A  F7 EA			     imul    dx
   2760	0C9C  8B 56 FC			     mov     dx,word ptr [bp-4]
   2761	0C9F  8B D8			     mov     bx,ax
   2762	0CA1  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   2763	0CA5			     @23@506:
   2764					;
   2765					;	     p_ref = MK_FP(seg,off);
   2766					;
   2767	0CA5  FF 76 08			     push    word ptr [bp+8]
   2768	0CA8  FF 76 06			     push    word ptr [bp+6]
   2769	0CAB  E8 0000e			     call    near ptr _MK_FP
   2770	0CAE  59			     pop     cx
   2771	0CAF  59			     pop     cx
   2772	0CB0  89 56 FA			     mov     word ptr [bp-6],dx
   2773	0CB3  89 46 F8			     mov     word ptr [bp-8],ax
   2774					;
   2775					;	     *p_ref = miniSO_thread[pcb].exitcode;
   2776					;
   2777	0CB6  8B 46 FE			     mov     ax,word ptr [bp-2]
   2778	0CB9  BA 001A			     mov     dx,26
   2779	0CBC  F7 EA			     imul    dx
   2780	0CBE  8B D8			     mov     bx,ax
   2781	0CC0  8B 87 0019r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+18]
   2782	0CC4  C4 5E F8			     les     bx,dword ptr [bp-8]
   2783	0CC7  26: 89 07			     mov     word ptr es:[bx],ax
   2784					;
   2785					;	     /*	Insere o processo na lista de BCPs livres */
   2786					;	     miniSO_thread[pcb].next = miniSO_free;
   2787					;
   2788	0CCA  8B 46 FE			     mov     ax,word ptr [bp-2]
   2789	0CCD  BA 001A			     mov     dx,26
   2790	0CD0  F7 EA			     imul    dx
   2791	0CD2  8B 16 0009r		     mov     dx,word ptr DGROUP:_miniSO_free
   2792	0CD6  8B D8			     mov     bx,ax
   2793	0CD8  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 50
scall.ASM



   2794					;
   2795					;	     miniSO_free = pcb;
   2796					;
   2797	0CDC  8B 46 FE			     mov     ax,word ptr [bp-2]
   2798	0CDF  A3 0009r			     mov     word ptr DGROUP:_miniSO_free,ax
   2799					;
   2800					;	     miniSO_thread[pcb].status = FREE;
   2801					;
   2802	0CE2  8B 46 FE			     mov     ax,word ptr [bp-2]
   2803	0CE5  BA 001A			     mov     dx,26
   2804	0CE8  F7 EA			     imul    dx
   2805	0CEA  8B D8			     mov     bx,ax
   2806	0CEC  C7 87 000Br FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+4],-1
   2807					;
   2808					;	     enable();
   2809					;
   2810	0CF2  E8 0000e			     call    near ptr _enable
   2811					;
   2812					;	     return pid;
   2813					;
   2814	0CF5  8B 46 04			     mov     ax,word ptr [bp+4]
   2815	0CF8  E9 FE74			     jmp     @23@114
   2816	0CFB			     @23@534:
   2817					;
   2818					;    }
   2819					;
   2820	0CFB  5F			     pop     di
   2821	0CFC  5E			     pop     si
   2822	0CFD  8B E5			     mov     sp,bp
   2823	0CFF  5D			     pop     bp
   2824	0D00  C3			     ret
   2825	0D01			     _sc_waitpid     endp
   2826					;
   2827					;    int sc_wait(unsigned seg,unsigned off)
   2828					;
   2829					     assume  cs:_TEXT
   2830	0D01			     _sc_wait	     proc    near
   2831	0D01  55			     push    bp
   2832	0D02  8B EC			     mov     bp,sp
   2833	0D04  83 EC 08			     sub     sp,8
   2834	0D07  56			     push    si
   2835	0D08  57			     push    di
   2836					;
   2837					;    {
   2838					;	     pcb_t   zombie,next,atual,prevthread,nextthread;
   2839					;	     int far *p_ref;
   2840					;
   2841					;	     disable();
   2842					;
   2843	0D09  E8 0000e			     call    near ptr _disable
   2844					;
   2845					;	     atual =miniSO_ready;
   2846					;
   2847	0D0C  8B 36 0007r		     mov     si,word ptr DGROUP:_miniSO_ready
   2848					;
   2849					;	     if	     (miniSO_thread[miniSO_ready].zombies==-1) {
   2850					;
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 51
scall.ASM



   2851	0D10  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   2852	0D13  BA 001A			     mov     dx,26
   2853	0D16  F7 EA			     imul    dx
   2854	0D18  8B D8			     mov     bx,ax
   2855	0D1A  83 BF 001Br FF		     cmp     word ptr DGROUP:_miniSO_thread[bx+20],-1
   2856	0D1F  74 03			     je	     @@4
   2857	0D21  E9 00AA			     jmp     @24@198
   2858	0D24			     @@4:
   2859					;
   2860					;		     /*	O pai nao tem filhos-zumbi e vai bloquear */
   2861					;		     prevthread	= miniSO_thread[atual].prev;
   2862					;
   2863	0D24  8B C6			     mov     ax,si
   2864	0D26  BA 001A			     mov     dx,26
   2865	0D29  F7 EA			     imul    dx
   2866	0D2B  8B D8			     mov     bx,ax
   2867	0D2D  8B 87 001Dr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+22]
   2868	0D31  89 46 FE			     mov     word ptr [bp-2],ax
   2869					;
   2870					;		     nextthread	= miniSO_thread[atual].next;
   2871					;
   2872	0D34  8B C6			     mov     ax,si
   2873	0D36  BA 001A			     mov     dx,26
   2874	0D39  F7 EA			     imul    dx
   2875	0D3B  8B D8			     mov     bx,ax
   2876	0D3D  8B 87 001Fr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+24]
   2877	0D41  89 46 FC			     mov     word ptr [bp-4],ax
   2878					;
   2879					;		     /*	Se eh a	ultima thread ... */
   2880					;		     if	     (miniSO_ready == nextthread)
   2881					;
   2882	0D44  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   2883	0D47  3B 46 FC			     cmp     ax,word ptr [bp-4]
   2884	0D4A  75 08			     jne     short @24@114
   2885					;
   2886					;			     end_mso("wait(): nao ha' mais threads executando!");
   2887					;
   2888	0D4C  B8 0129r			     mov     ax,offset DGROUP:s@+154
   2889	0D4F  50			     push    ax
   2890	0D50  E8 F6EA			     call    near ptr end_mso
   2891	0D53  59			     pop     cx
   2892	0D54			     @24@114:
   2893					;
   2894					;		     /*	Vincula	o BCP da thread	atual ao BCP da	thread "destino" */
   2895					;		     miniSO_thread[atual].prev = -1;
   2896					;
   2897	0D54  8B C6			     mov     ax,si
   2898	0D56  BA 001A			     mov     dx,26
   2899	0D59  F7 EA			     imul    dx
   2900	0D5B  8B D8			     mov     bx,ax
   2901	0D5D  C7 87 001Dr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+22],-1
   2902					;
   2903					;		     miniSO_thread[atual].next = -1;
   2904					;
   2905	0D63  8B C6			     mov     ax,si
   2906	0D65  BA 001A			     mov     dx,26
   2907	0D68  F7 EA			     imul    dx
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 52
scall.ASM



   2908	0D6A  8B D8			     mov     bx,ax
   2909	0D6C  C7 87 001Fr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+24],-1
   2910					;
   2911					;		     miniSO_thread[atual].waitfor = -1;
   2912					;
   2913	0D72  8B C6			     mov     ax,si
   2914	0D74  BA 001A			     mov     dx,26
   2915	0D77  F7 EA			     imul    dx
   2916	0D79  8B D8			     mov     bx,ax
   2917	0D7B  C7 87 0017r FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+16],-1
   2918					;
   2919					;		     miniSO_thread[atual].status = WAIT;
   2920					;
   2921	0D81  8B C6			     mov     ax,si
   2922	0D83  BA 001A			     mov     dx,26
   2923	0D86  F7 EA			     imul    dx
   2924	0D88  8B D8			     mov     bx,ax
   2925	0D8A  C7 87 000Br 0003		     mov     word ptr DGROUP:_miniSO_thread[bx+4],3
   2926					;
   2927					;		     /*	Exclui o nodo da lista de prontos */
   2928					;		     miniSO_thread[atual].next=nextthread;
   2929					;
   2930	0D90  8B C6			     mov     ax,si
   2931	0D92  BA 001A			     mov     dx,26
   2932	0D95  F7 EA			     imul    dx
   2933	0D97  8B 56 FC			     mov     dx,word ptr [bp-4]
   2934	0D9A  8B D8			     mov     bx,ax
   2935	0D9C  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   2936					;
   2937					;		     miniSO_thread[atual].prev=prevthread;
   2938					;
   2939	0DA0  8B C6			     mov     ax,si
   2940	0DA2  BA 001A			     mov     dx,26
   2941	0DA5  F7 EA			     imul    dx
   2942	0DA7  8B 56 FE			     mov     dx,word ptr [bp-2]
   2943	0DAA  8B D8			     mov     bx,ax
   2944	0DAC  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   2945					;
   2946					;		     miniSO_nextthread=nextthread;
   2947					;
   2948	0DB0  8B 46 FC			     mov     ax,word ptr [bp-4]
   2949	0DB3  A3 0004r			     mov     word ptr DGROUP:_miniSO_nextthread,ax
   2950					;
   2951					;		     enable();
   2952					;
   2953	0DB6  E8 0000e			     call    near ptr _enable
   2954	0DB9  EB 00			     jmp     short @24@142
   2955	0DBB			     @24@142:
   2956					;
   2957					;		     while   (miniSO_thread[atual].status == WAIT)
   2958					;
   2959	0DBB  8B C6			     mov     ax,si
   2960	0DBD  BA 001A			     mov     dx,26
   2961	0DC0  F7 EA			     imul    dx
   2962	0DC2  8B D8			     mov     bx,ax
   2963	0DC4  83 BF 000Br 03		     cmp     word ptr DGROUP:_miniSO_thread[bx+4],3
   2964	0DC9  74 F0			     je	     short @24@142
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 53
scall.ASM



   2965					;
   2966					;			     ;
   2967					;		     disable();
   2968					;
   2969	0DCB  E8 0000e			     call    near ptr _disable
   2970	0DCE			     @24@198:
   2971					;
   2972					;	     }
   2973					;	     /*	O pai tem pelo menos um	filho zumbi... */
   2974					;	     zombie = miniSO_thread[atual].zombies;
   2975					;
   2976	0DCE  8B C6			     mov     ax,si
   2977	0DD0  BA 001A			     mov     dx,26
   2978	0DD3  F7 EA			     imul    dx
   2979	0DD5  8B D8			     mov     bx,ax
   2980	0DD7  8B BF 001Br		     mov     di,word ptr DGROUP:_miniSO_thread[bx+20]
   2981					;
   2982					;	     miniSO_thread[atual].zombies = miniSO_thread[zombie].next;
   2983					;
   2984	0DDB  8B C7			     mov     ax,di
   2985	0DDD  BA 001A			     mov     dx,26
   2986	0DE0  F7 EA			     imul    dx
   2987	0DE2  8B D8			     mov     bx,ax
   2988	0DE4  8B 87 001Fr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+24]
   2989	0DE8  50			     push    ax
   2990	0DE9  8B C6			     mov     ax,si
   2991	0DEB  BA 001A			     mov     dx,26
   2992	0DEE  F7 EA			     imul    dx
   2993	0DF0  8B D8			     mov     bx,ax
   2994	0DF2  58			     pop     ax
   2995	0DF3  89 87 001Br		     mov     word ptr DGROUP:_miniSO_thread[bx+20],ax
   2996					;
   2997					;	     if	     (miniSO_thread[atual].zombies!=-1)
   2998					;
   2999	0DF7  8B C6			     mov     ax,si
   3000	0DF9  BA 001A			     mov     dx,26
   3001	0DFC  F7 EA			     imul    dx
   3002	0DFE  8B D8			     mov     bx,ax
   3003	0E00  83 BF 001Br FF		     cmp     word ptr DGROUP:_miniSO_thread[bx+20],-1
   3004	0E05  74 1A			     je	     short @24@254
   3005					;
   3006					;		     miniSO_thread[miniSO_thread[atual].zombies].prev =	-1;
   3007					;
   3008	0E07  8B C6			     mov     ax,si
   3009	0E09  BA 001A			     mov     dx,26
   3010	0E0C  F7 EA			     imul    dx
   3011	0E0E  8B D8			     mov     bx,ax
   3012	0E10  8B 87 001Br		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+20]
   3013	0E14  BA 001A			     mov     dx,26
   3014	0E17  F7 EA			     imul    dx
   3015	0E19  8B D8			     mov     bx,ax
   3016	0E1B  C7 87 001Dr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+22],-1
   3017	0E21			     @24@254:
   3018					;
   3019					;	     miniSO_thread[zombie].next	= miniSO_free;
   3020					;
   3021	0E21  8B C7			     mov     ax,di
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 54
scall.ASM



   3022	0E23  BA 001A			     mov     dx,26
   3023	0E26  F7 EA			     imul    dx
   3024	0E28  8B 16 0009r		     mov     dx,word ptr DGROUP:_miniSO_free
   3025	0E2C  8B D8			     mov     bx,ax
   3026	0E2E  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   3027					;
   3028					;	     miniSO_thread[zombie].status = FREE;
   3029					;
   3030	0E32  8B C7			     mov     ax,di
   3031	0E34  BA 001A			     mov     dx,26
   3032	0E37  F7 EA			     imul    dx
   3033	0E39  8B D8			     mov     bx,ax
   3034	0E3B  C7 87 000Br FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+4],-1
   3035					;
   3036					;	     miniSO_free = zombie;
   3037					;
   3038	0E41  89 3E 0009r		     mov     word ptr DGROUP:_miniSO_free,di
   3039					;
   3040					;	     p_ref = MK_FP(seg,off);
   3041					;
   3042	0E45  FF 76 06			     push    word ptr [bp+6]
   3043	0E48  FF 76 04			     push    word ptr [bp+4]
   3044	0E4B  E8 0000e			     call    near ptr _MK_FP
   3045	0E4E  59			     pop     cx
   3046	0E4F  59			     pop     cx
   3047	0E50  89 56 FA			     mov     word ptr [bp-6],dx
   3048	0E53  89 46 F8			     mov     word ptr [bp-8],ax
   3049					;
   3050					;	     *p_ref = miniSO_thread[zombie].exitcode;
   3051					;
   3052	0E56  8B C7			     mov     ax,di
   3053	0E58  BA 001A			     mov     dx,26
   3054	0E5B  F7 EA			     imul    dx
   3055	0E5D  8B D8			     mov     bx,ax
   3056	0E5F  8B 87 0019r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+18]
   3057	0E63  C4 5E F8			     les     bx,dword ptr [bp-8]
   3058	0E66  26: 89 07			     mov     word ptr es:[bx],ax
   3059					;
   3060					;	     enable();
   3061					;
   3062	0E69  E8 0000e			     call    near ptr _enable
   3063					;
   3064					;	     return miniSO_thread[zombie].pid;
   3065					;
   3066	0E6C  8B C7			     mov     ax,di
   3067	0E6E  BA 001A			     mov     dx,26
   3068	0E71  F7 EA			     imul    dx
   3069	0E73  8B D8			     mov     bx,ax
   3070	0E75  8B 87 0007r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx]
   3071	0E79  EB 00			     jmp     short @24@282
   3072	0E7B			     @24@282:
   3073					;
   3074					;    }
   3075					;
   3076	0E7B  5F			     pop     di
   3077	0E7C  5E			     pop     si
   3078	0E7D  8B E5			     mov     sp,bp
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 55
scall.ASM



   3079	0E7F  5D			     pop     bp
   3080	0E80  C3			     ret
   3081	0E81			     _sc_wait	     endp
   3082					;
   3083					;    void sc_exit(int codfim)
   3084					;
   3085					     assume  cs:_TEXT
   3086	0E81			     _sc_exit	     proc    near
   3087	0E81  55			     push    bp
   3088	0E82  8B EC			     mov     bp,sp
   3089	0E84  83 EC 06			     sub     sp,6
   3090	0E87  56			     push    si
   3091	0E88  57			     push    di
   3092					;
   3093					;    {
   3094					;	     pcb_t pai,i,last,prevthread,nextthread;
   3095					;
   3096					;	     disable();
   3097					;
   3098	0E89  E8 0000e			     call    near ptr _disable
   3099					;
   3100					;	     /*	Verifica se não	esta' encerrando a thread 0 */
   3101					;	     if	     (miniSO_ready == 0)
   3102					;
   3103	0E8C  83 3E 0007r 00		     cmp     word ptr DGROUP:_miniSO_ready,0
   3104	0E91  75 08			     jne     short @25@86
   3105					;
   3106					;		     end_mso("exit(): thread 0 encerrada!");
   3107					;
   3108	0E93  B8 0152r			     mov     ax,offset DGROUP:s@+195
   3109	0E96  50			     push    ax
   3110	0E97  E8 F5A3			     call    near ptr end_mso
   3111	0E9A  59			     pop     cx
   3112	0E9B			     @25@86:
   3113	0E9B  EB 41			     jmp     short @25@142
   3114	0E9D			     @25@114:
   3115					;
   3116					;	     /*	Trata os zumbis	do processo atual, colocando-os	na lista de livres */
   3117					;	     i = miniSO_thread[miniSO_ready].zombies;
   3118					;	     while   (i!= -1)  {
   3119					;		     miniSO_thread[miniSO_ready].zombies = miniSO_thread[i].next;
   3120					;
   3121	0E9D  8B C6			     mov     ax,si
   3122	0E9F  BA 001A			     mov     dx,26
   3123	0EA2  F7 EA			     imul    dx
   3124	0EA4  8B D8			     mov     bx,ax
   3125	0EA6  8B 87 001Fr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+24]
   3126	0EAA  50			     push    ax
   3127	0EAB  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3128	0EAE  BA 001A			     mov     dx,26
   3129	0EB1  F7 EA			     imul    dx
   3130	0EB3  8B D8			     mov     bx,ax
   3131	0EB5  58			     pop     ax
   3132	0EB6  89 87 001Br		     mov     word ptr DGROUP:_miniSO_thread[bx+20],ax
   3133					;
   3134					;		     miniSO_thread[i].next   = miniSO_free;
   3135					;
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 56
scall.ASM



   3136	0EBA  8B C6			     mov     ax,si
   3137	0EBC  BA 001A			     mov     dx,26
   3138	0EBF  F7 EA			     imul    dx
   3139	0EC1  8B 16 0009r		     mov     dx,word ptr DGROUP:_miniSO_free
   3140	0EC5  8B D8			     mov     bx,ax
   3141	0EC7  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   3142					;
   3143					;		     miniSO_thread[i].status = FREE;
   3144					;
   3145	0ECB  8B C6			     mov     ax,si
   3146	0ECD  BA 001A			     mov     dx,26
   3147	0ED0  F7 EA			     imul    dx
   3148	0ED2  8B D8			     mov     bx,ax
   3149	0ED4  C7 87 000Br FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+4],-1
   3150					;
   3151					;		     miniSO_free	     = i;
   3152					;
   3153	0EDA  89 36 0009r		     mov     word ptr DGROUP:_miniSO_free,si
   3154					;
   3155					;		     i = miniSO_thread[miniSO_ready].zombies;
   3156					;
   3157	0EDE			     @25@142:
   3158	0EDE  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3159	0EE1  BA 001A			     mov     dx,26
   3160	0EE4  F7 EA			     imul    dx
   3161	0EE6  8B D8			     mov     bx,ax
   3162	0EE8  8B B7 001Br		     mov     si,word ptr DGROUP:_miniSO_thread[bx+20]
   3163	0EEC  83 FE FF			     cmp     si,-1
   3164	0EEF  75 AC			     jne     short @25@114
   3165					;
   3166					;	     }
   3167					;	     /*	Passa os filhos	do atual para o	processo 0 */
   3168					;	     for     (i=0;i<miniSO_MAXTHREADS;++i)  {
   3169					;
   3170	0EF1  33 F6			     xor     si,si
   3171	0EF3  EB 3F			     jmp     short @25@338
   3172	0EF5			     @25@226:
   3173					;
   3174					;		     if	     (miniSO_thread[i].status!=FREE && miniSO_thread[i].ppid ==	    +
   3175				     miniSO_thread[miniSO_ready].pid)
   3176					;
   3177	0EF5  8B C6			     mov     ax,si
   3178	0EF7  BA 001A			     mov     dx,26
   3179	0EFA  F7 EA			     imul    dx
   3180	0EFC  8B D8			     mov     bx,ax
   3181	0EFE  83 BF 000Br FF		     cmp     word ptr DGROUP:_miniSO_thread[bx+4],-1
   3182	0F03  74 2E			     je	     short @25@310
   3183	0F05  8B C6			     mov     ax,si
   3184	0F07  BA 001A			     mov     dx,26
   3185	0F0A  F7 EA			     imul    dx
   3186	0F0C  8B D8			     mov     bx,ax
   3187	0F0E  8B 87 0009r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+2]
   3188	0F12  50			     push    ax
   3189	0F13  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3190	0F16  BA 001A			     mov     dx,26
   3191	0F19  F7 EA			     imul    dx
   3192	0F1B  8B D8			     mov     bx,ax
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 57
scall.ASM



   3193	0F1D  58			     pop     ax
   3194	0F1E  3B 87 0007r		     cmp     ax,word ptr DGROUP:_miniSO_thread[bx]
   3195	0F22  75 0F			     jne     short @25@310
   3196					;
   3197					;			     miniSO_thread[i].ppid = 0;
   3198					;
   3199	0F24  8B C6			     mov     ax,si
   3200	0F26  BA 001A			     mov     dx,26
   3201	0F29  F7 EA			     imul    dx
   3202	0F2B  8B D8			     mov     bx,ax
   3203	0F2D  C7 87 0009r 0000		     mov     word ptr DGROUP:_miniSO_thread[bx+2],0
   3204	0F33			     @25@310:
   3205	0F33  46			     inc     si
   3206	0F34			     @25@338:
   3207	0F34  83 FE 10			     cmp     si,16
   3208	0F37  7C BC			     jl	     short @25@226
   3209					;
   3210					;	     }
   3211					;	     pai = get_pcb(miniSO_thread[miniSO_ready].ppid);
   3212					;
   3213	0F39  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3214	0F3C  BA 001A			     mov     dx,26
   3215	0F3F  F7 EA			     imul    dx
   3216	0F41  8B D8			     mov     bx,ax
   3217	0F43  FF B7 0009r		     push    word ptr DGROUP:_miniSO_thread[bx+2]
   3218	0F47  E8 F538			     call    near ptr get_pcb
   3219	0F4A  59			     pop     cx
   3220	0F4B  8B F8			     mov     di,ax
   3221					;
   3222					;	     if	     (pai==-1)
   3223					;
   3224	0F4D  83 FF FF			     cmp     di,-1
   3225	0F50  75 08			     jne     short @25@422
   3226					;
   3227					;		     end_mso("exit(): pai nao encontrado!");
   3228					;
   3229	0F52  B8 016Er			     mov     ax,offset DGROUP:s@+223
   3230	0F55  50			     push    ax
   3231	0F56  E8 F4E4			     call    near ptr end_mso
   3232	0F59  59			     pop     cx
   3233	0F5A			     @25@422:
   3234					;
   3235					;	     /*	Se o processo-pai esta'	esperando em wait/waitpid, coloca ele na lista de   +
   3236				     prontos */
   3237					;	     if	     ( miniSO_thread[pai].status==WAIT &&
   3238					;
   3239					;
   3240					;		       (miniSO_thread[pai].waitfor==-1 || miniSO_thread			    +
   3241				     [pai].waitfor==miniSO_ready) ) {
   3242					;
   3243	0F5A  8B C7			     mov     ax,di
   3244	0F5C  BA 001A			     mov     dx,26
   3245	0F5F  F7 EA			     imul    dx
   3246	0F61  8B D8			     mov     bx,ax
   3247	0F63  83 BF 000Br 03		     cmp     word ptr DGROUP:_miniSO_thread[bx+4],3
   3248	0F68  74 03			     je	     @@5
   3249	0F6A  E9 0080			     jmp     @25@534
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 58
scall.ASM



   3250	0F6D			     @@5:
   3251	0F6D  8B C7			     mov     ax,di
   3252	0F6F  BA 001A			     mov     dx,26
   3253	0F72  F7 EA			     imul    dx
   3254	0F74  8B D8			     mov     bx,ax
   3255	0F76  83 BF 0017r FF		     cmp     word ptr DGROUP:_miniSO_thread[bx+16],-1
   3256	0F7B  74 13			     je	     short @25@506
   3257	0F7D  8B C7			     mov     ax,di
   3258	0F7F  BA 001A			     mov     dx,26
   3259	0F82  F7 EA			     imul    dx
   3260	0F84  8B D8			     mov     bx,ax
   3261	0F86  8B 87 0017r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+16]
   3262	0F8A  3B 06 0007r		     cmp     ax,word ptr DGROUP:_miniSO_ready
   3263	0F8E  75 5D			     jne     short @25@534
   3264	0F90			     @25@506:
   3265					;
   3266					;		     /*	Descobre qual a	ultima thread */
   3267					;		     last = miniSO_thread[miniSO_ready].prev;
   3268					;
   3269	0F90  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3270	0F93  BA 001A			     mov     dx,26
   3271	0F96  F7 EA			     imul    dx
   3272	0F98  8B D8			     mov     bx,ax
   3273	0F9A  8B 87 001Dr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+22]
   3274	0F9E  89 46 FE			     mov     word ptr [bp-2],ax
   3275					;
   3276					;		     /*	Acerta links para incluir a thread no final da lista de	prontos*/
   3277					;		     miniSO_thread[pai].prev	       = last;
   3278					;
   3279	0FA1  8B C7			     mov     ax,di
   3280	0FA3  BA 001A			     mov     dx,26
   3281	0FA6  F7 EA			     imul    dx
   3282	0FA8  8B 56 FE			     mov     dx,word ptr [bp-2]
   3283	0FAB  8B D8			     mov     bx,ax
   3284	0FAD  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   3285					;
   3286					;		     miniSO_thread[pai].next	       = miniSO_ready;
   3287					;
   3288	0FB1  8B C7			     mov     ax,di
   3289	0FB3  BA 001A			     mov     dx,26
   3290	0FB6  F7 EA			     imul    dx
   3291	0FB8  8B 16 0007r		     mov     dx,word ptr DGROUP:_miniSO_ready
   3292	0FBC  8B D8			     mov     bx,ax
   3293	0FBE  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   3294					;
   3295					;		     miniSO_thread[last].next	       = pai;
   3296					;
   3297	0FC2  8B 46 FE			     mov     ax,word ptr [bp-2]
   3298	0FC5  BA 001A			     mov     dx,26
   3299	0FC8  F7 EA			     imul    dx
   3300	0FCA  8B D8			     mov     bx,ax
   3301	0FCC  89 BF 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],di
   3302					;
   3303					;		     miniSO_thread[miniSO_ready].prev  = pai;
   3304					;
   3305	0FD0  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3306	0FD3  BA 001A			     mov     dx,26
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 59
scall.ASM



   3307	0FD6  F7 EA			     imul    dx
   3308	0FD8  8B D8			     mov     bx,ax
   3309	0FDA  89 BF 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],di
   3310					;
   3311					;		     miniSO_thread[pai].status	       = READY;
   3312					;
   3313	0FDE  8B C7			     mov     ax,di
   3314	0FE0  BA 001A			     mov     dx,26
   3315	0FE3  F7 EA			     imul    dx
   3316	0FE5  8B D8			     mov     bx,ax
   3317	0FE7  C7 87 000Br 0000		     mov     word ptr DGROUP:_miniSO_thread[bx+4],0
   3318	0FED			     @25@534:
   3319					;
   3320					;	     }
   3321					;	     /*	Salva anterior e proximo da thread que sera deletada */
   3322					;	     prevthread	= miniSO_thread[miniSO_ready].prev;
   3323					;
   3324	0FED  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3325	0FF0  BA 001A			     mov     dx,26
   3326	0FF3  F7 EA			     imul    dx
   3327	0FF5  8B D8			     mov     bx,ax
   3328	0FF7  8B 87 001Dr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+22]
   3329	0FFB  89 46 FC			     mov     word ptr [bp-4],ax
   3330					;
   3331					;	     nextthread	= miniSO_thread[miniSO_ready].next;
   3332					;
   3333	0FFE  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3334	1001  BA 001A			     mov     dx,26
   3335	1004  F7 EA			     imul    dx
   3336	1006  8B D8			     mov     bx,ax
   3337	1008  8B 87 001Fr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+24]
   3338	100C  89 46 FA			     mov     word ptr [bp-6],ax
   3339					;
   3340					;	     if	     (miniSO_ready == nextthread)
   3341					;
   3342	100F  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3343	1012  3B 46 FA			     cmp     ax,word ptr [bp-6]
   3344	1015  75 08			     jne     short @25@590
   3345					;
   3346					;		     end_mso("exit(): nao ha' mais threads executando!");
   3347					;
   3348	1017  B8 018Ar			     mov     ax,offset DGROUP:s@+251
   3349	101A  50			     push    ax
   3350	101B  E8 F41F			     call    near ptr end_mso
   3351	101E  59			     pop     cx
   3352	101F			     @25@590:
   3353					;
   3354					;	     /*	Exclui o nodo da lista de prontos */
   3355					;	     miniSO_thread[prevthread].next=nextthread;
   3356					;
   3357	101F  8B 46 FC			     mov     ax,word ptr [bp-4]
   3358	1022  BA 001A			     mov     dx,26
   3359	1025  F7 EA			     imul    dx
   3360	1027  8B 56 FA			     mov     dx,word ptr [bp-6]
   3361	102A  8B D8			     mov     bx,ax
   3362	102C  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   3363					;
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 60
scall.ASM



   3364					;	     miniSO_thread[nextthread].prev=prevthread;
   3365					;
   3366	1030  8B 46 FA			     mov     ax,word ptr [bp-6]
   3367	1033  BA 001A			     mov     dx,26
   3368	1036  F7 EA			     imul    dx
   3369	1038  8B 56 FC			     mov     dx,word ptr [bp-4]
   3370	103B  8B D8			     mov     bx,ax
   3371	103D  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   3372					;
   3373					;	     if	     (miniSO_thread[pai].zombies==-1) {
   3374					;
   3375	1041  8B C7			     mov     ax,di
   3376	1043  BA 001A			     mov     dx,26
   3377	1046  F7 EA			     imul    dx
   3378	1048  8B D8			     mov     bx,ax
   3379	104A  83 BF 001Br FF		     cmp     word ptr DGROUP:_miniSO_thread[bx+20],-1
   3380	104F  75 23			     jne     short @25@646
   3381					;
   3382					;		     miniSO_thread[pai].zombies	= miniSO_ready;
   3383					;
   3384	1051  8B C7			     mov     ax,di
   3385	1053  BA 001A			     mov     dx,26
   3386	1056  F7 EA			     imul    dx
   3387	1058  8B 16 0007r		     mov     dx,word ptr DGROUP:_miniSO_ready
   3388	105C  8B D8			     mov     bx,ax
   3389	105E  89 97 001Br		     mov     word ptr DGROUP:_miniSO_thread[bx+20],dx
   3390					;
   3391					;		     miniSO_thread[miniSO_ready].prev =	-1;
   3392					;
   3393	1062  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3394	1065  BA 001A			     mov     dx,26
   3395	1068  F7 EA			     imul    dx
   3396	106A  8B D8			     mov     bx,ax
   3397	106C  C7 87 001Dr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+22],-1
   3398					;
   3399					;	     }
   3400					;
   3401	1072  EB 4B			     jmp     short @25@758
   3402	1074			     @25@646:
   3403					;
   3404					;	     else    {
   3405					;		     i = miniSO_thread[pai].zombies;
   3406					;
   3407	1074  8B C7			     mov     ax,di
   3408	1076  BA 001A			     mov     dx,26
   3409	1079  F7 EA			     imul    dx
   3410	107B  8B D8			     mov     bx,ax
   3411	107D  8B B7 001Br		     mov     si,word ptr DGROUP:_miniSO_thread[bx+20]
   3412	1081  EB 0D			     jmp     short @25@702
   3413	1083			     @25@674:
   3414					;
   3415					;		     while   (miniSO_thread[i].next!=-1)
   3416					;			     i = miniSO_thread[i].next;
   3417					;
   3418	1083  8B C6			     mov     ax,si
   3419	1085  BA 001A			     mov     dx,26
   3420	1088  F7 EA			     imul    dx
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 61
scall.ASM



   3421	108A  8B D8			     mov     bx,ax
   3422	108C  8B B7 001Fr		     mov     si,word ptr DGROUP:_miniSO_thread[bx+24]
   3423	1090			     @25@702:
   3424	1090  8B C6			     mov     ax,si
   3425	1092  BA 001A			     mov     dx,26
   3426	1095  F7 EA			     imul    dx
   3427	1097  8B D8			     mov     bx,ax
   3428	1099  83 BF 001Fr FF		     cmp     word ptr DGROUP:_miniSO_thread[bx+24],-1
   3429	109E  75 E3			     jne     short @25@674
   3430					;
   3431					;		     miniSO_thread[i].next = miniSO_ready;
   3432					;
   3433	10A0  8B C6			     mov     ax,si
   3434	10A2  BA 001A			     mov     dx,26
   3435	10A5  F7 EA			     imul    dx
   3436	10A7  8B 16 0007r		     mov     dx,word ptr DGROUP:_miniSO_ready
   3437	10AB  8B D8			     mov     bx,ax
   3438	10AD  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   3439					;
   3440					;		     miniSO_thread[miniSO_ready].prev =	i;
   3441					;
   3442	10B1  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3443	10B4  BA 001A			     mov     dx,26
   3444	10B7  F7 EA			     imul    dx
   3445	10B9  8B D8			     mov     bx,ax
   3446	10BB  89 B7 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],si
   3447	10BF			     @25@758:
   3448					;
   3449					;	     }
   3450					;	     miniSO_thread[miniSO_ready].next =	-1;
   3451					;
   3452	10BF  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3453	10C2  BA 001A			     mov     dx,26
   3454	10C5  F7 EA			     imul    dx
   3455	10C7  8B D8			     mov     bx,ax
   3456	10C9  C7 87 001Fr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+24],-1
   3457					;
   3458					;	     miniSO_thread[miniSO_ready].status	= ZOMBIE;
   3459					;
   3460	10CF  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3461	10D2  BA 001A			     mov     dx,26
   3462	10D5  F7 EA			     imul    dx
   3463	10D7  8B D8			     mov     bx,ax
   3464	10D9  C7 87 000Br 0002		     mov     word ptr DGROUP:_miniSO_thread[bx+4],2
   3465					;
   3466					;	     miniSO_thread[miniSO_ready].exitcode = codfim;
   3467					;
   3468	10DF  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3469	10E2  BA 001A			     mov     dx,26
   3470	10E5  F7 EA			     imul    dx
   3471	10E7  8B 56 04			     mov     dx,word ptr [bp+4]
   3472	10EA  8B D8			     mov     bx,ax
   3473	10EC  89 97 0019r		     mov     word ptr DGROUP:_miniSO_thread[bx+18],dx
   3474					;
   3475					;	     miniSO_nextthread=nextthread;
   3476					;
   3477	10F0  8B 46 FA			     mov     ax,word ptr [bp-6]
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 62
scall.ASM



   3478	10F3  A3 0004r			     mov     word ptr DGROUP:_miniSO_nextthread,ax
   3479					;
   3480					;	     miniSO_delcurthread=1;
   3481					;
   3482	10F6  C6 06 0006r 01		     mov     byte ptr DGROUP:_miniSO_delcurthread,1
   3483					;
   3484					;	     enable();
   3485					;
   3486	10FB  E8 0000e			     call    near ptr _enable
   3487	10FE			     @25@786:
   3488	10FE  EB FE			     jmp     short @25@786
   3489					;
   3490					;	     while   (1)
   3491					;		     ;
   3492					;    }
   3493					;
   3494	1100  5F			     pop     di
   3495	1101  5E			     pop     si
   3496	1102  8B E5			     mov     sp,bp
   3497	1104  5D			     pop     bp
   3498	1105  C3			     ret
   3499	1106			     _sc_exit	     endp
   3500					;
   3501					;    pid_t sc_getpid()
   3502					;
   3503					     assume  cs:_TEXT
   3504	1106			     _sc_getpid	     proc    near
   3505	1106  55			     push    bp
   3506	1107  8B EC			     mov     bp,sp
   3507					;
   3508					;    {
   3509					;	     return miniSO_thread[miniSO_ready].pid;
   3510					;
   3511	1109  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3512	110C  BA 001A			     mov     dx,26
   3513	110F  F7 EA			     imul    dx
   3514	1111  8B D8			     mov     bx,ax
   3515	1113  8B 87 0007r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx]
   3516	1117  EB 00			     jmp     short @26@58
   3517	1119			     @26@58:
   3518					;
   3519					;    }
   3520					;
   3521	1119  5D			     pop     bp
   3522	111A  C3			     ret
   3523	111B			     _sc_getpid	     endp
   3524					;
   3525					;    pid_t sc_getppid()
   3526					;
   3527					     assume  cs:_TEXT
   3528	111B			     _sc_getppid     proc    near
   3529	111B  55			     push    bp
   3530	111C  8B EC			     mov     bp,sp
   3531					;
   3532					;    {
   3533					;	     return miniSO_thread[miniSO_ready].ppid;
   3534					;
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 63
scall.ASM



   3535	111E  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3536	1121  BA 001A			     mov     dx,26
   3537	1124  F7 EA			     imul    dx
   3538	1126  8B D8			     mov     bx,ax
   3539	1128  8B 87 0009r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+2]
   3540	112C  EB 00			     jmp     short @27@58
   3541	112E			     @27@58:
   3542					;
   3543					;    }
   3544					;
   3545	112E  5D			     pop     bp
   3546	112F  C3			     ret
   3547	1130			     _sc_getppid     endp
   3548					;
   3549					;    int sc_sendsignal(pid_t pid, signal_t signal)
   3550					;
   3551					     assume  cs:_TEXT
   3552	1130			     _sc_sendsignal  proc    near
   3553	1130  55			     push    bp
   3554	1131  8B EC			     mov     bp,sp
   3555	1133  56			     push    si
   3556	1134  57			     push    di
   3557					;
   3558					;    {
   3559					;	     pcb_t   pcb,last;
   3560					;
   3561					;	     disable();
   3562					;
   3563	1135  E8 0000e			     call    near ptr _disable
   3564					;
   3565					;	     /*	Tem que	verificar se existe a thread */
   3566					;	     pcb = get_pcb(pid);
   3567					;
   3568	1138  FF 76 04			     push    word ptr [bp+4]
   3569	113B  E8 F344			     call    near ptr get_pcb
   3570	113E  59			     pop     cx
   3571	113F  8B F0			     mov     si,ax
   3572					;
   3573					;	     /*	Se nao existe uma thread com este numero, entao	retorna	*/
   3574					;	     if	     (pcb==-1)	{
   3575					;
   3576	1141  83 FE FF			     cmp     si,-1
   3577	1144  75 09			     jne     short @28@114
   3578					;
   3579					;		     enable();
   3580					;
   3581	1146  E8 0000e			     call    near ptr _enable
   3582					;
   3583					;		     return miniSO_ERROR;
   3584					;
   3585	1149  B8 FFFF			     mov     ax,-1
   3586	114C			     @28@86:
   3587	114C  E9 00DD			     jmp     @28@226
   3588	114F			     @28@114:
   3589					;
   3590					;	     }
   3591					;	     /*	Seta os	sinais recebidos */
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 64
scall.ASM



   3592					;	     miniSO_thread[pcb].recvsig	|= signal;
   3593					;
   3594	114F  8B C6			     mov     ax,si
   3595	1151  BA 001A			     mov     dx,26
   3596	1154  F7 EA			     imul    dx
   3597	1156  8B 56 06			     mov     dx,word ptr [bp+6]
   3598	1159  8B D8			     mov     bx,ax
   3599	115B  09 97 0011r		     or	     word ptr DGROUP:_miniSO_thread[bx+10],dx
   3600					;
   3601					;	     /*	A thread pode estar esperando pelos sinais ou nao */
   3602					;	     if	     (miniSO_thread[pcb].status	== WAITSIG)  {
   3603					;
   3604	115F  8B C6			     mov     ax,si
   3605	1161  BA 001A			     mov     dx,26
   3606	1164  F7 EA			     imul    dx
   3607	1166  8B D8			     mov     bx,ax
   3608	1168  83 BF 000Br 04		     cmp     word ptr DGROUP:_miniSO_thread[bx+4],4
   3609	116D  74 03			     je	     @@6
   3610	116F  E9 00B1			     jmp     @28@198
   3611	1172			     @@6:
   3612					;
   3613					;		     /*	Verifica se a thread estava esperando pelo sinal */
   3614					;		     if	     ( (miniSO_thread[pcb].recvsig & miniSO_thread[pcb].waitsig) == +
   3615				     miniSO_thread[pcb].waitsig	)  {
   3616					;
   3617	1172  8B C6			     mov     ax,si
   3618	1174  BA 001A			     mov     dx,26
   3619	1177  F7 EA			     imul    dx
   3620	1179  8B D8			     mov     bx,ax
   3621	117B  8B 87 0011r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+10]
   3622	117F  50			     push    ax
   3623	1180  8B C6			     mov     ax,si
   3624	1182  BA 001A			     mov     dx,26
   3625	1185  F7 EA			     imul    dx
   3626	1187  8B D8			     mov     bx,ax
   3627	1189  58			     pop     ax
   3628	118A  23 87 0013r		     and     ax,word ptr DGROUP:_miniSO_thread[bx+12]
   3629	118E  50			     push    ax
   3630	118F  8B C6			     mov     ax,si
   3631	1191  BA 001A			     mov     dx,26
   3632	1194  F7 EA			     imul    dx
   3633	1196  8B D8			     mov     bx,ax
   3634	1198  58			     pop     ax
   3635	1199  3B 87 0013r		     cmp     ax,word ptr DGROUP:_miniSO_thread[bx+12]
   3636	119D  74 03			     je	     @@7
   3637	119F  E9 0081			     jmp     @28@198
   3638	11A2			     @@7:
   3639					;
   3640					;			     /*	O sinal	recebido e' suficiente para tirar a thread da espera+
   3641				     */
   3642					;			     last = miniSO_thread[miniSO_ready].prev;
   3643					;
   3644	11A2  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3645	11A5  BA 001A			     mov     dx,26
   3646	11A8  F7 EA			     imul    dx
   3647	11AA  8B D8			     mov     bx,ax
   3648	11AC  8B BF 001Dr		     mov     di,word ptr DGROUP:_miniSO_thread[bx+22]
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 65
scall.ASM



   3649					;
   3650					;			     miniSO_thread[pcb].prev = last;
   3651					;
   3652	11B0  8B C6			     mov     ax,si
   3653	11B2  BA 001A			     mov     dx,26
   3654	11B5  F7 EA			     imul    dx
   3655	11B7  8B D8			     mov     bx,ax
   3656	11B9  89 BF 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],di
   3657					;
   3658					;			     miniSO_thread[last].next=pcb;
   3659					;
   3660	11BD  8B C7			     mov     ax,di
   3661	11BF  BA 001A			     mov     dx,26
   3662	11C2  F7 EA			     imul    dx
   3663	11C4  8B D8			     mov     bx,ax
   3664	11C6  89 B7 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],si
   3665					;
   3666					;			     miniSO_thread[miniSO_ready].prev=pcb;
   3667					;
   3668	11CA  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3669	11CD  BA 001A			     mov     dx,26
   3670	11D0  F7 EA			     imul    dx
   3671	11D2  8B D8			     mov     bx,ax
   3672	11D4  89 B7 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],si
   3673					;
   3674					;			     miniSO_thread[pcb].next=miniSO_ready;
   3675					;
   3676	11D8  8B C6			     mov     ax,si
   3677	11DA  BA 001A			     mov     dx,26
   3678	11DD  F7 EA			     imul    dx
   3679	11DF  8B 16 0007r		     mov     dx,word ptr DGROUP:_miniSO_ready
   3680	11E3  8B D8			     mov     bx,ax
   3681	11E5  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   3682					;
   3683					;			     miniSO_thread[pcb].status = READY;
   3684					;
   3685	11E9  8B C6			     mov     ax,si
   3686	11EB  BA 001A			     mov     dx,26
   3687	11EE  F7 EA			     imul    dx
   3688	11F0  8B D8			     mov     bx,ax
   3689	11F2  C7 87 000Br 0000		     mov     word ptr DGROUP:_miniSO_thread[bx+4],0
   3690					;
   3691					;			     /*	Seta sinais recebidos e	sinais esperados */
   3692					;			     miniSO_thread[pcb].recvsig	^= miniSO_thread[pcb].waitsig;
   3693					;
   3694	11F8  8B C6			     mov     ax,si
   3695	11FA  BA 001A			     mov     dx,26
   3696	11FD  F7 EA			     imul    dx
   3697	11FF  8B D8			     mov     bx,ax
   3698	1201  8B 87 0013r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+12]
   3699	1205  50			     push    ax
   3700	1206  8B C6			     mov     ax,si
   3701	1208  BA 001A			     mov     dx,26
   3702	120B  F7 EA			     imul    dx
   3703	120D  8B D8			     mov     bx,ax
   3704	120F  58			     pop     ax
   3705	1210  31 87 0011r		     xor     word ptr DGROUP:_miniSO_thread[bx+10],ax
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 66
scall.ASM



   3706					;
   3707					;			     miniSO_thread[pcb].waitsig	= 0;
   3708					;
   3709	1214  8B C6			     mov     ax,si
   3710	1216  BA 001A			     mov     dx,26
   3711	1219  F7 EA			     imul    dx
   3712	121B  8B D8			     mov     bx,ax
   3713	121D  C7 87 0013r 0000		     mov     word ptr DGROUP:_miniSO_thread[bx+12],0
   3714	1223			     @28@198:
   3715					;
   3716					;		     }
   3717					;	     }
   3718					;	     enable();
   3719					;
   3720	1223  E8 0000e			     call    near ptr _enable
   3721					;
   3722					;	     return miniSO_OK;
   3723					;
   3724	1226  B8 0001			     mov     ax,1
   3725	1229  E9 FF20			     jmp     @28@86
   3726	122C			     @28@226:
   3727					;
   3728					;    }
   3729					;
   3730	122C  5F			     pop     di
   3731	122D  5E			     pop     si
   3732	122E  5D			     pop     bp
   3733	122F  C3			     ret
   3734	1230			     _sc_sendsignal  endp
   3735					;
   3736					;    int sc_waitsignal(signal_t	signal)
   3737					;
   3738					     assume  cs:_TEXT
   3739	1230			     _sc_waitsignal  proc    near
   3740	1230  55			     push    bp
   3741	1231  8B EC			     mov     bp,sp
   3742	1233  83 EC 06			     sub     sp,6
   3743	1236  56			     push    si
   3744	1237  57			     push    di
   3745	1238  8B 7E 04			     mov     di,word ptr [bp+4]
   3746					;
   3747					;    {
   3748					;	     pcb_t   pcb,prevthread,nextthread;
   3749					;	     int     waitint=0;
   3750					;
   3751	123B  C7 46 FA 0000		     mov     word ptr [bp-6],0
   3752					;
   3753					;
   3754					;	     disable();
   3755					;
   3756	1240  E8 0000e			     call    near ptr _disable
   3757					;
   3758					;	     pcb = miniSO_ready;
   3759					;
   3760	1243  8B 36 0007r		     mov     si,word ptr DGROUP:_miniSO_ready
   3761					;
   3762					;	     /*	Verifica se ja'	nao recebeu os sinais */
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 67
scall.ASM



   3763					;	     if	     ( (miniSO_thread[pcb].recvsig & signal) ==	signal )  {
   3764					;
   3765	1247  8B C6			     mov     ax,si
   3766	1249  BA 001A			     mov     dx,26
   3767	124C  F7 EA			     imul    dx
   3768	124E  8B D8			     mov     bx,ax
   3769	1250  8B 87 0011r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+10]
   3770	1254  23 C7			     and     ax,di
   3771	1256  3B C7			     cmp     ax,di
   3772	1258  75 1F			     jne     short @29@86
   3773					;
   3774					;		     /*	Ele ja'	recebeu	os sinais */
   3775					;		     miniSO_thread[pcb].recvsig	^= signal;
   3776					;
   3777	125A  8B C6			     mov     ax,si
   3778	125C  BA 001A			     mov     dx,26
   3779	125F  F7 EA			     imul    dx
   3780	1261  8B D8			     mov     bx,ax
   3781	1263  31 BF 0011r		     xor     word ptr DGROUP:_miniSO_thread[bx+10],di
   3782					;
   3783					;		     miniSO_thread[pcb].waitsig	= 0;
   3784					;
   3785	1267  8B C6			     mov     ax,si
   3786	1269  BA 001A			     mov     dx,26
   3787	126C  F7 EA			     imul    dx
   3788	126E  8B D8			     mov     bx,ax
   3789	1270  C7 87 0013r 0000		     mov     word ptr DGROUP:_miniSO_thread[bx+12],0
   3790					;
   3791					;	     }
   3792					;
   3793	1276  E9 0094			     jmp     @29@170
   3794	1279			     @29@86:
   3795					;
   3796					;	     else    {
   3797					;		     /*	Ele ainda nao recebeu os sinais	e vai para a lista de espera */
   3798					;		     miniSO_thread[pcb].waitsig	= signal;
   3799					;
   3800	1279  8B C6			     mov     ax,si
   3801	127B  BA 001A			     mov     dx,26
   3802	127E  F7 EA			     imul    dx
   3803	1280  8B D8			     mov     bx,ax
   3804	1282  89 BF 0013r		     mov     word ptr DGROUP:_miniSO_thread[bx+12],di
   3805					;
   3806					;		     /*	Se eh a	ultima thread ... */
   3807					;		     prevthread	= miniSO_thread[pcb].prev;
   3808					;
   3809	1286  8B C6			     mov     ax,si
   3810	1288  BA 001A			     mov     dx,26
   3811	128B  F7 EA			     imul    dx
   3812	128D  8B D8			     mov     bx,ax
   3813	128F  8B 87 001Dr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+22]
   3814	1293  89 46 FE			     mov     word ptr [bp-2],ax
   3815					;
   3816					;		     nextthread	= miniSO_thread[pcb].next;
   3817					;
   3818	1296  8B C6			     mov     ax,si
   3819	1298  BA 001A			     mov     dx,26
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 68
scall.ASM



   3820	129B  F7 EA			     imul    dx
   3821	129D  8B D8			     mov     bx,ax
   3822	129F  8B 87 001Fr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+24]
   3823	12A3  89 46 FC			     mov     word ptr [bp-4],ax
   3824					;
   3825					;		     if	     (pcb == nextthread)
   3826					;
   3827	12A6  3B 76 FC			     cmp     si,word ptr [bp-4]
   3828	12A9  75 08			     jne     short @29@142
   3829					;
   3830					;			     end_mso("waitsignal(): nao	ha' mais threads executando!");
   3831					;
   3832	12AB  B8 01B3r			     mov     ax,offset DGROUP:s@+292
   3833	12AE  50			     push    ax
   3834	12AF  E8 F18B			     call    near ptr end_mso
   3835	12B2  59			     pop     cx
   3836	12B3			     @29@142:
   3837					;
   3838					;		     /*	Retira o BCP da	thread corrente	da lista de prontos */
   3839					;		     miniSO_thread[pcb].next = -1;
   3840					;
   3841	12B3  8B C6			     mov     ax,si
   3842	12B5  BA 001A			     mov     dx,26
   3843	12B8  F7 EA			     imul    dx
   3844	12BA  8B D8			     mov     bx,ax
   3845	12BC  C7 87 001Fr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+24],-1
   3846					;
   3847					;		     miniSO_thread[pcb].prev  =	-1;
   3848					;
   3849	12C2  8B C6			     mov     ax,si
   3850	12C4  BA 001A			     mov     dx,26
   3851	12C7  F7 EA			     imul    dx
   3852	12C9  8B D8			     mov     bx,ax
   3853	12CB  C7 87 001Dr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+22],-1
   3854					;
   3855					;		     /*	Exclui o nodo da lista de prontos */
   3856					;		     miniSO_thread[prevthread].next=nextthread;
   3857					;
   3858	12D1  8B 46 FE			     mov     ax,word ptr [bp-2]
   3859	12D4  BA 001A			     mov     dx,26
   3860	12D7  F7 EA			     imul    dx
   3861	12D9  8B 56 FC			     mov     dx,word ptr [bp-4]
   3862	12DC  8B D8			     mov     bx,ax
   3863	12DE  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   3864					;
   3865					;		     miniSO_thread[nextthread].prev=prevthread;
   3866					;
   3867	12E2  8B 46 FC			     mov     ax,word ptr [bp-4]
   3868	12E5  BA 001A			     mov     dx,26
   3869	12E8  F7 EA			     imul    dx
   3870	12EA  8B 56 FE			     mov     dx,word ptr [bp-2]
   3871	12ED  8B D8			     mov     bx,ax
   3872	12EF  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   3873					;
   3874					;		     miniSO_thread[pcb].status = WAITSIG;
   3875					;
   3876	12F3  8B C6			     mov     ax,si
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 69
scall.ASM



   3877	12F5  BA 001A			     mov     dx,26
   3878	12F8  F7 EA			     imul    dx
   3879	12FA  8B D8			     mov     bx,ax
   3880	12FC  C7 87 000Br 0004		     mov     word ptr DGROUP:_miniSO_thread[bx+4],4
   3881					;
   3882					;		     miniSO_nextthread=nextthread;
   3883					;
   3884	1302  8B 46 FC			     mov     ax,word ptr [bp-4]
   3885	1305  A3 0004r			     mov     word ptr DGROUP:_miniSO_nextthread,ax
   3886					;
   3887					;		     waitint=1;
   3888					;
   3889	1308  C7 46 FA 0001		     mov     word ptr [bp-6],1
   3890	130D			     @29@170:
   3891					;
   3892					;	     }
   3893					;	     enable();
   3894					;
   3895	130D  E8 0000e			     call    near ptr _enable
   3896					;
   3897					;	     if	     (waitint)
   3898					;
   3899	1310  83 7E FA 00		     cmp     word ptr [bp-6],0
   3900	1314  74 12			     je	     short @29@254
   3901	1316  EB 00			     jmp     short @29@226
   3902	1318			     @29@226:
   3903					;
   3904					;		     while   (miniSO_thread[pcb].status	== WAITSIG)
   3905					;
   3906	1318  8B C6			     mov     ax,si
   3907	131A  BA 001A			     mov     dx,26
   3908	131D  F7 EA			     imul    dx
   3909	131F  8B D8			     mov     bx,ax
   3910	1321  83 BF 000Br 04		     cmp     word ptr DGROUP:_miniSO_thread[bx+4],4
   3911	1326  74 F0			     je	     short @29@226
   3912	1328			     @29@254:
   3913					;
   3914					;			     ;
   3915					;	     return 0;
   3916					;
   3917	1328  33 C0			     xor     ax,ax
   3918	132A  EB 00			     jmp     short @29@282
   3919	132C			     @29@282:
   3920					;
   3921					;    }
   3922					;
   3923	132C  5F			     pop     di
   3924	132D  5E			     pop     si
   3925	132E  8B E5			     mov     sp,bp
   3926	1330  5D			     pop     bp
   3927	1331  C3			     ret
   3928	1332			     _sc_waitsignal  endp
   3929					;
   3930					;    static int	get_sem_pos(semid_t s)
   3931					;
   3932					     assume  cs:_TEXT
   3933	1332			     get_sem_pos     proc    near
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 70
scall.ASM



   3934	1332  55			     push    bp
   3935	1333  8B EC			     mov     bp,sp
   3936					;
   3937					;    {
   3938					;	     int i;
   3939					;
   3940					;	     for     (i=0;i<miniSO_MAXSEMAPHORES;++i)
   3941					;
   3942	1335  33 D2			     xor     dx,dx
   3943	1337  EB 21			     jmp     short @30@198
   3944	1339			     @30@58:
   3945					;
   3946					;		     if	     (miniSO_sem[i].status!=FREE && miniSO_sem[i].semid==s)
   3947					;
   3948	1339  8B DA			     mov     bx,dx
   3949	133B  B1 03			     mov     cl,3
   3950	133D  D3 E3			     shl     bx,cl
   3951	133F  83 BF 01A7r FF		     cmp     word ptr DGROUP:_miniSO_sem[bx],-1
   3952	1344  74 13			     je	     short @30@170
   3953	1346  8B DA			     mov     bx,dx
   3954	1348  B1 03			     mov     cl,3
   3955	134A  D3 E3			     shl     bx,cl
   3956	134C  8B 87 01A9r		     mov     ax,word ptr DGROUP:_miniSO_sem[bx+2]
   3957	1350  3B 46 04			     cmp     ax,word ptr [bp+4]
   3958	1353  75 04			     jne     short @30@170
   3959					;
   3960					;			     return i;
   3961					;
   3962	1355  8B C2			     mov     ax,dx
   3963	1357			     @30@142:
   3964	1357  EB 0B			     jmp     short @30@254
   3965	1359			     @30@170:
   3966	1359  42			     inc     dx
   3967	135A			     @30@198:
   3968	135A  83 FA 0A			     cmp     dx,10
   3969	135D  7C DA			     jl	     short @30@58
   3970					;
   3971					;	     return miniSO_ERROR;
   3972					;
   3973	135F  B8 FFFF			     mov     ax,-1
   3974	1362  EB F3			     jmp     short @30@142
   3975	1364			     @30@254:
   3976					;
   3977					;    }
   3978					;
   3979	1364  5D			     pop     bp
   3980	1365  C3			     ret
   3981	1366			     get_sem_pos     endp
   3982					;
   3983					;    semid_t sc_semcreate (int value)
   3984					;
   3985					     assume  cs:_TEXT
   3986	1366			     _sc_semcreate   proc    near
   3987	1366  55			     push    bp
   3988	1367  8B EC			     mov     bp,sp
   3989	1369  56			     push    si
   3990					;
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 71
scall.ASM



   3991					;    {
   3992					;	     int i;
   3993					;	     semid_t s;
   3994					;
   3995					;	     for     (i=0;i<miniSO_MAXSEMAPHORES;++i)
   3996					;
   3997	136A  33 F6			     xor     si,si
   3998	136C  EB 74 90			     jmp     @31@310
   3999	136F			     @31@58:
   4000					;
   4001					;		     if	     (miniSO_sem[i].status==FREE) {
   4002					;
   4003	136F  8B DE			     mov     bx,si
   4004	1371  B1 03			     mov     cl,3
   4005	1373  D3 E3			     shl     bx,cl
   4006	1375  83 BF 01A7r FF		     cmp     word ptr DGROUP:_miniSO_sem[bx],-1
   4007	137A  75 65			     jne     short @31@282
   4008	137C  EB 14			     jmp     short @31@198
   4009	137E			     @31@114:
   4010					;
   4011					;			     /*	Gera um	semid */
   4012					;			     while   (get_sem_pos(nextsemid)!=miniSO_ERROR) {
   4013					;				     if	     (nextsemid==32767)
   4014					;
   4015	137E  81 3E 0005r 7FFF		     cmp     word ptr DGROUP:nextsemid,32767
   4016	1384  75 08			     jne     short @31@170
   4017					;
   4018					;					     nextsemid = 0;
   4019					;
   4020	1386  C7 06 0005r 0000		     mov     word ptr DGROUP:nextsemid,0
   4021	138C  EB 04			     jmp     short @31@198
   4022	138E			     @31@170:
   4023					;
   4024					;				     else
   4025					;					     nextsemid++;
   4026					;
   4027	138E  FF 06 0005r		     inc     word ptr DGROUP:nextsemid
   4028	1392			     @31@198:
   4029	1392  FF 36 0005r		     push    word ptr DGROUP:nextsemid
   4030	1396  E8 FF99			     call    near ptr get_sem_pos
   4031	1399  59			     pop     cx
   4032	139A  3D FFFF			     cmp     ax,-1
   4033	139D  75 DF			     jne     short @31@114
   4034					;
   4035					;			     }
   4036					;			     miniSO_sem[i].status=READY;
   4037					;
   4038	139F  8B DE			     mov     bx,si
   4039	13A1  B1 03			     mov     cl,3
   4040	13A3  D3 E3			     shl     bx,cl
   4041	13A5  C7 87 01A7r 0000		     mov     word ptr DGROUP:_miniSO_sem[bx],0
   4042					;
   4043					;			     miniSO_sem[i].semid=nextsemid++;
   4044					;
   4045	13AB  8B DE			     mov     bx,si
   4046	13AD  B1 03			     mov     cl,3
   4047	13AF  D3 E3			     shl     bx,cl
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 72
scall.ASM



   4048	13B1  A1 0005r			     mov     ax,word ptr DGROUP:nextsemid
   4049	13B4  89 87 01A9r		     mov     word ptr DGROUP:_miniSO_sem[bx+2],ax
   4050	13B8  FF 06 0005r		     inc     word ptr DGROUP:nextsemid
   4051					;
   4052					;			     miniSO_sem[i].value=value;
   4053					;
   4054	13BC  8B DE			     mov     bx,si
   4055	13BE  B1 03			     mov     cl,3
   4056	13C0  D3 E3			     shl     bx,cl
   4057	13C2  8B 46 04			     mov     ax,word ptr [bp+4]
   4058	13C5  89 87 01ABr		     mov     word ptr DGROUP:_miniSO_sem[bx+4],ax
   4059					;
   4060					;			     miniSO_sem[i].queue=-1;
   4061					;
   4062	13C9  8B DE			     mov     bx,si
   4063	13CB  B1 03			     mov     cl,3
   4064	13CD  D3 E3			     shl     bx,cl
   4065	13CF  C7 87 01ADr FFFF		     mov     word ptr DGROUP:_miniSO_sem[bx+6],-1
   4066					;
   4067					;			     return miniSO_sem[i].semid;
   4068					;
   4069	13D5  8B DE			     mov     bx,si
   4070	13D7  B1 03			     mov     cl,3
   4071	13D9  D3 E3			     shl     bx,cl
   4072	13DB  8B 87 01A9r		     mov     ax,word ptr DGROUP:_miniSO_sem[bx+2]
   4073	13DF			     @31@254:
   4074	13DF  EB 0D			     jmp     short @31@366
   4075	13E1			     @31@282:
   4076	13E1  46			     inc     si
   4077	13E2			     @31@310:
   4078	13E2  83 FE 0A			     cmp     si,10
   4079	13E5  7D 02			     jge     @@8
   4080	13E7  EB 86			     jmp     @31@58
   4081	13E9			     @@8:
   4082					;
   4083					;		     }
   4084					;	     return miniSO_ERROR;
   4085					;
   4086	13E9  B8 FFFF			     mov     ax,-1
   4087	13EC  EB F1			     jmp     short @31@254
   4088	13EE			     @31@366:
   4089					;
   4090					;    }
   4091					;
   4092	13EE  5E			     pop     si
   4093	13EF  5D			     pop     bp
   4094	13F0  C3			     ret
   4095	13F1			     _sc_semcreate   endp
   4096					;
   4097					;    int sc_semset (semid_t s,int value)
   4098					;
   4099					     assume  cs:_TEXT
   4100	13F1			     _sc_semset	     proc    near
   4101	13F1  55			     push    bp
   4102	13F2  8B EC			     mov     bp,sp
   4103	13F4  56			     push    si
   4104					;
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 73
scall.ASM



   4105					;    {
   4106					;	     int sem;
   4107					;
   4108					;	     sem = get_sem_pos(s);
   4109					;
   4110	13F5  FF 76 04			     push    word ptr [bp+4]
   4111	13F8  E8 FF37			     call    near ptr get_sem_pos
   4112	13FB  59			     pop     cx
   4113	13FC  8B F0			     mov     si,ax
   4114					;
   4115					;	     if	     (sem==miniSO_ERROR	|| miniSO_sem[sem].queue!=-1)
   4116					;
   4117	13FE  83 FE FF			     cmp     si,-1
   4118	1401  74 0D			     je	     short @32@86
   4119	1403  8B DE			     mov     bx,si
   4120	1405  B1 03			     mov     cl,3
   4121	1407  D3 E3			     shl     bx,cl
   4122	1409  83 BF 01ADr FF		     cmp     word ptr DGROUP:_miniSO_sem[bx+6],-1
   4123	140E  74 05			     je	     short @32@142
   4124	1410			     @32@86:
   4125					;
   4126					;		     return miniSO_ERROR;
   4127					;
   4128	1410  B8 FFFF			     mov     ax,-1
   4129	1413			     @32@114:
   4130	1413  EB 12			     jmp     short @32@170
   4131	1415			     @32@142:
   4132					;
   4133					;	     miniSO_sem[sem].value = value;
   4134					;
   4135	1415  8B DE			     mov     bx,si
   4136	1417  B1 03			     mov     cl,3
   4137	1419  D3 E3			     shl     bx,cl
   4138	141B  8B 46 06			     mov     ax,word ptr [bp+6]
   4139	141E  89 87 01ABr		     mov     word ptr DGROUP:_miniSO_sem[bx+4],ax
   4140					;
   4141					;	     return miniSO_OK;
   4142					;
   4143	1422  B8 0001			     mov     ax,1
   4144	1425  EB EC			     jmp     short @32@114
   4145	1427			     @32@170:
   4146					;
   4147					;    }
   4148					;
   4149	1427  5E			     pop     si
   4150	1428  5D			     pop     bp
   4151	1429  C3			     ret
   4152	142A			     _sc_semset	     endp
   4153					;
   4154					;    int sc_semup (semid_t s)
   4155					;
   4156					     assume  cs:_TEXT
   4157	142A			     _sc_semup	     proc    near
   4158	142A  55			     push    bp
   4159	142B  8B EC			     mov     bp,sp
   4160	142D  83 EC 02			     sub     sp,2
   4161	1430  56			     push    si
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 74
scall.ASM



   4162	1431  57			     push    di
   4163					;
   4164					;    {
   4165					;	     int sem;
   4166					;	     pcb_t pcb,last,prevthread,nextthread;
   4167					;
   4168					;	     disable();
   4169					;
   4170	1432  E8 0000e			     call    near ptr _disable
   4171					;
   4172					;	     sem = get_sem_pos(s);
   4173					;
   4174	1435  FF 76 04			     push    word ptr [bp+4]
   4175	1438  E8 FEF7			     call    near ptr get_sem_pos
   4176	143B  59			     pop     cx
   4177	143C  8B F0			     mov     si,ax
   4178					;
   4179					;	     if	     (sem==miniSO_ERROR) {
   4180					;
   4181	143E  83 FE FF			     cmp     si,-1
   4182	1441  75 09			     jne     short @33@114
   4183					;
   4184					;		     enable();
   4185					;
   4186	1443  E8 0000e			     call    near ptr _enable
   4187					;
   4188					;		     return miniSO_ERROR;
   4189					;
   4190	1446  B8 FFFF			     mov     ax,-1
   4191	1449			     @33@86:
   4192	1449  E9 00C5			     jmp     @33@254
   4193	144C			     @33@114:
   4194					;
   4195					;	     }
   4196					;	     miniSO_sem[sem].value++;
   4197					;
   4198	144C  8B DE			     mov     bx,si
   4199	144E  B1 03			     mov     cl,3
   4200	1450  D3 E3			     shl     bx,cl
   4201	1452  FF 87 01ABr		     inc     word ptr DGROUP:_miniSO_sem[bx+4]
   4202					;
   4203					;	     if	     (miniSO_sem[sem].queue!=-1) {
   4204					;
   4205	1456  8B DE			     mov     bx,si
   4206	1458  B1 03			     mov     cl,3
   4207	145A  D3 E3			     shl     bx,cl
   4208	145C  83 BF 01ADr FF		     cmp     word ptr DGROUP:_miniSO_sem[bx+6],-1
   4209	1461  75 03			     jne     @@9
   4210	1463  E9 00A2			     jmp     @33@226
   4211	1466			     @@9:
   4212					;
   4213					;		     pcb = miniSO_sem[sem].queue;
   4214					;
   4215	1466  8B DE			     mov     bx,si
   4216	1468  B1 03			     mov     cl,3
   4217	146A  D3 E3			     shl     bx,cl
   4218	146C  8B BF 01ADr		     mov     di,word ptr DGROUP:_miniSO_sem[bx+6]
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 75
scall.ASM



   4219					;
   4220					;		     miniSO_sem[sem].queue = miniSO_thread[pcb].next;
   4221					;
   4222	1470  8B C7			     mov     ax,di
   4223	1472  BA 001A			     mov     dx,26
   4224	1475  F7 EA			     imul    dx
   4225	1477  8B D8			     mov     bx,ax
   4226	1479  8B 87 001Fr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+24]
   4227	147D  8B DE			     mov     bx,si
   4228	147F  B1 03			     mov     cl,3
   4229	1481  D3 E3			     shl     bx,cl
   4230	1483  89 87 01ADr		     mov     word ptr DGROUP:_miniSO_sem[bx+6],ax
   4231					;
   4232					;		     if	     (miniSO_sem[sem].queue!=-1)
   4233					;
   4234	1487  8B DE			     mov     bx,si
   4235	1489  B1 03			     mov     cl,3
   4236	148B  D3 E3			     shl     bx,cl
   4237	148D  83 BF 01ADr FF		     cmp     word ptr DGROUP:_miniSO_sem[bx+6],-1
   4238	1492  74 17			     je	     short @33@198
   4239					;
   4240					;			     miniSO_thread[miniSO_sem[sem].queue].prev = -1;
   4241					;
   4242	1494  8B DE			     mov     bx,si
   4243	1496  B1 03			     mov     cl,3
   4244	1498  D3 E3			     shl     bx,cl
   4245	149A  8B 87 01ADr		     mov     ax,word ptr DGROUP:_miniSO_sem[bx+6]
   4246	149E  BA 001A			     mov     dx,26
   4247	14A1  F7 EA			     imul    dx
   4248	14A3  8B D8			     mov     bx,ax
   4249	14A5  C7 87 001Dr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+22],-1
   4250	14AB			     @33@198:
   4251					;
   4252					;		     last = miniSO_thread[miniSO_ready].prev;
   4253					;
   4254	14AB  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   4255	14AE  BA 001A			     mov     dx,26
   4256	14B1  F7 EA			     imul    dx
   4257	14B3  8B D8			     mov     bx,ax
   4258	14B5  8B 87 001Dr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+22]
   4259	14B9  89 46 FE			     mov     word ptr [bp-2],ax
   4260					;
   4261					;		     miniSO_thread[pcb].prev = last;
   4262					;
   4263	14BC  8B C7			     mov     ax,di
   4264	14BE  BA 001A			     mov     dx,26
   4265	14C1  F7 EA			     imul    dx
   4266	14C3  8B 56 FE			     mov     dx,word ptr [bp-2]
   4267	14C6  8B D8			     mov     bx,ax
   4268	14C8  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   4269					;
   4270					;		     miniSO_thread[last].next=pcb;
   4271					;
   4272	14CC  8B 46 FE			     mov     ax,word ptr [bp-2]
   4273	14CF  BA 001A			     mov     dx,26
   4274	14D2  F7 EA			     imul    dx
   4275	14D4  8B D8			     mov     bx,ax
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 76
scall.ASM



   4276	14D6  89 BF 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],di
   4277					;
   4278					;		     miniSO_thread[miniSO_ready].prev=pcb;
   4279					;
   4280	14DA  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   4281	14DD  BA 001A			     mov     dx,26
   4282	14E0  F7 EA			     imul    dx
   4283	14E2  8B D8			     mov     bx,ax
   4284	14E4  89 BF 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],di
   4285					;
   4286					;		     miniSO_thread[pcb].next=miniSO_ready;
   4287					;
   4288	14E8  8B C7			     mov     ax,di
   4289	14EA  BA 001A			     mov     dx,26
   4290	14ED  F7 EA			     imul    dx
   4291	14EF  8B 16 0007r		     mov     dx,word ptr DGROUP:_miniSO_ready
   4292	14F3  8B D8			     mov     bx,ax
   4293	14F5  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   4294					;
   4295					;		     miniSO_thread[pcb].status = READY;
   4296					;
   4297	14F9  8B C7			     mov     ax,di
   4298	14FB  BA 001A			     mov     dx,26
   4299	14FE  F7 EA			     imul    dx
   4300	1500  8B D8			     mov     bx,ax
   4301	1502  C7 87 000Br 0000		     mov     word ptr DGROUP:_miniSO_thread[bx+4],0
   4302	1508			     @33@226:
   4303					;
   4304					;	     }
   4305					;	     enable();
   4306					;
   4307	1508  E8 0000e			     call    near ptr _enable
   4308					;
   4309					;	     return miniSO_OK;
   4310					;
   4311	150B  B8 0001			     mov     ax,1
   4312	150E  E9 FF38			     jmp     @33@86
   4313	1511			     @33@254:
   4314					;
   4315					;    }
   4316					;
   4317	1511  5F			     pop     di
   4318	1512  5E			     pop     si
   4319	1513  8B E5			     mov     sp,bp
   4320	1515  5D			     pop     bp
   4321	1516  C3			     ret
   4322	1517			     _sc_semup	     endp
   4323					;
   4324					;    int sc_semdown (semid_t s)
   4325					;
   4326					     assume  cs:_TEXT
   4327	1517			     _sc_semdown     proc    near
   4328	1517  55			     push    bp
   4329	1518  8B EC			     mov     bp,sp
   4330	151A  83 EC 08			     sub     sp,8
   4331	151D  56			     push    si
   4332	151E  57			     push    di
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 77
scall.ASM



   4333					;
   4334					;    {
   4335					;	     int sem;
   4336					;	     pcb_t pcb,ant,i,prevthread,nextthread;
   4337					;
   4338					;	     disable();
   4339					;
   4340	151F  E8 0000e			     call    near ptr _disable
   4341					;
   4342					;	     sem = get_sem_pos(s);
   4343					;
   4344	1522  FF 76 04			     push    word ptr [bp+4]
   4345	1525  E8 FE0A			     call    near ptr get_sem_pos
   4346	1528  59			     pop     cx
   4347	1529  8B F8			     mov     di,ax
   4348					;
   4349					;	     if	     (sem==miniSO_ERROR) {
   4350					;
   4351	152B  83 FF FF			     cmp     di,-1
   4352	152E  75 09			     jne     short @34@114
   4353					;
   4354					;		     enable();
   4355					;
   4356	1530  E8 0000e			     call    near ptr _enable
   4357					;
   4358					;		     return miniSO_ERROR;
   4359					;
   4360	1533  B8 FFFF			     mov     ax,-1
   4361	1536			     @34@86:
   4362	1536  E9 011E			     jmp     @34@534
   4363	1539			     @34@114:
   4364					;
   4365					;	     }
   4366					;	     miniSO_sem[sem].value--;
   4367					;
   4368	1539  8B DF			     mov     bx,di
   4369	153B  B1 03			     mov     cl,3
   4370	153D  D3 E3			     shl     bx,cl
   4371	153F  FF 8F 01ABr		     dec     word ptr DGROUP:_miniSO_sem[bx+4]
   4372					;
   4373					;	     if	     (miniSO_sem[sem].value<0) {
   4374					;
   4375	1543  8B DF			     mov     bx,di
   4376	1545  B1 03			     mov     cl,3
   4377	1547  D3 E3			     shl     bx,cl
   4378	1549  83 BF 01ABr 00		     cmp     word ptr DGROUP:_miniSO_sem[bx+4],0
   4379	154E  7C 03			     jl	     @@10
   4380	1550  E9 00FB			     jmp     @34@478
   4381	1553			     @@10:
   4382					;
   4383					;		     pcb = miniSO_ready;
   4384					;
   4385	1553  8B 36 0007r		     mov     si,word ptr DGROUP:_miniSO_ready
   4386					;
   4387					;		     prevthread	= miniSO_thread[pcb].prev;
   4388					;
   4389	1557  8B C6			     mov     ax,si
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 78
scall.ASM



   4390	1559  BA 001A			     mov     dx,26
   4391	155C  F7 EA			     imul    dx
   4392	155E  8B D8			     mov     bx,ax
   4393	1560  8B 87 001Dr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+22]
   4394	1564  89 46 FA			     mov     word ptr [bp-6],ax
   4395					;
   4396					;		     nextthread	= miniSO_thread[pcb].next;
   4397					;
   4398	1567  8B C6			     mov     ax,si
   4399	1569  BA 001A			     mov     dx,26
   4400	156C  F7 EA			     imul    dx
   4401	156E  8B D8			     mov     bx,ax
   4402	1570  8B 87 001Fr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+24]
   4403	1574  89 46 F8			     mov     word ptr [bp-8],ax
   4404					;
   4405					;		     /*	Se eh a	ultima thread ... */
   4406					;		     if	     (pcb == nextthread)
   4407					;
   4408	1577  3B 76 F8			     cmp     si,word ptr [bp-8]
   4409	157A  75 08			     jne     short @34@198
   4410					;
   4411					;			     end_mso("semdown(): nao ha' mais threads executando!");
   4412					;
   4413	157C  B8 01E2r			     mov     ax,offset DGROUP:s@+339
   4414	157F  50			     push    ax
   4415	1580  E8 EEBA			     call    near ptr end_mso
   4416	1583  59			     pop     cx
   4417	1584			     @34@198:
   4418					;
   4419					;		     /*	Coloca o BCP da	thread no final	da lista de espera do semaforo */
   4420					;		     ant = -1;
   4421					;
   4422	1584  C7 46 FE FFFF		     mov     word ptr [bp-2],-1
   4423					;
   4424					;		     i = miniSO_sem[sem].queue;
   4425					;
   4426	1589  8B DF			     mov     bx,di
   4427	158B  B1 03			     mov     cl,3
   4428	158D  D3 E3			     shl     bx,cl
   4429	158F  8B 87 01ADr		     mov     ax,word ptr DGROUP:_miniSO_sem[bx+6]
   4430	1593  EB 14			     jmp     short @34@254
   4431	1595			     @34@226:
   4432					;
   4433					;		     while   (i!=-1) {
   4434					;			     ant = i;
   4435					;
   4436	1595  8B 46 FC			     mov     ax,word ptr [bp-4]
   4437	1598  89 46 FE			     mov     word ptr [bp-2],ax
   4438					;
   4439					;			     i = miniSO_thread[i].next;
   4440					;
   4441	159B  8B 46 FC			     mov     ax,word ptr [bp-4]
   4442	159E  BA 001A			     mov     dx,26
   4443	15A1  F7 EA			     imul    dx
   4444	15A3  8B D8			     mov     bx,ax
   4445	15A5  8B 87 001Fr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+24]
   4446	15A9			     @34@254:
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 79
scall.ASM



   4447	15A9  89 46 FC			     mov     word ptr [bp-4],ax
   4448	15AC  83 7E FC FF		     cmp     word ptr [bp-4],-1
   4449	15B0  75 E3			     jne     short @34@226
   4450					;
   4451					;		     }
   4452					;		     if	     (ant==-1) {
   4453					;
   4454	15B2  83 7E FE FF		     cmp     word ptr [bp-2],-1
   4455	15B6  75 1B			     jne     short @34@366
   4456					;
   4457					;			     miniSO_sem[sem].queue = pcb;
   4458					;
   4459	15B8  8B DF			     mov     bx,di
   4460	15BA  B1 03			     mov     cl,3
   4461	15BC  D3 E3			     shl     bx,cl
   4462	15BE  89 B7 01ADr		     mov     word ptr DGROUP:_miniSO_sem[bx+6],si
   4463					;
   4464					;			     miniSO_thread[pcb].prev = -1;
   4465					;
   4466	15C2  8B C6			     mov     ax,si
   4467	15C4  BA 001A			     mov     dx,26
   4468	15C7  F7 EA			     imul    dx
   4469	15C9  8B D8			     mov     bx,ax
   4470	15CB  C7 87 001Dr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+22],-1
   4471					;
   4472					;		     }
   4473					;
   4474	15D1  EB 1E			     jmp     short @34@394
   4475	15D3			     @34@366:
   4476					;
   4477					;		     else {
   4478					;			     miniSO_thread[ant].next = pcb;
   4479					;
   4480	15D3  8B 46 FE			     mov     ax,word ptr [bp-2]
   4481	15D6  BA 001A			     mov     dx,26
   4482	15D9  F7 EA			     imul    dx
   4483	15DB  8B D8			     mov     bx,ax
   4484	15DD  89 B7 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],si
   4485					;
   4486					;			     miniSO_thread[pcb].prev = ant;
   4487					;
   4488	15E1  8B C6			     mov     ax,si
   4489	15E3  BA 001A			     mov     dx,26
   4490	15E6  F7 EA			     imul    dx
   4491	15E8  8B 56 FE			     mov     dx,word ptr [bp-2]
   4492	15EB  8B D8			     mov     bx,ax
   4493	15ED  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   4494	15F1			     @34@394:
   4495					;
   4496					;		     }
   4497					;		     miniSO_thread[pcb].next = -1;
   4498					;
   4499	15F1  8B C6			     mov     ax,si
   4500	15F3  BA 001A			     mov     dx,26
   4501	15F6  F7 EA			     imul    dx
   4502	15F8  8B D8			     mov     bx,ax
   4503	15FA  C7 87 001Fr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+24],-1
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 80
scall.ASM



   4504					;
   4505					;		     /*	Exclui o nodo da lista de prontos */
   4506					;		     miniSO_thread[prevthread].next=nextthread;
   4507					;
   4508	1600  8B 46 FA			     mov     ax,word ptr [bp-6]
   4509	1603  BA 001A			     mov     dx,26
   4510	1606  F7 EA			     imul    dx
   4511	1608  8B 56 F8			     mov     dx,word ptr [bp-8]
   4512	160B  8B D8			     mov     bx,ax
   4513	160D  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   4514					;
   4515					;		     miniSO_thread[nextthread].prev=prevthread;
   4516					;
   4517	1611  8B 46 F8			     mov     ax,word ptr [bp-8]
   4518	1614  BA 001A			     mov     dx,26
   4519	1617  F7 EA			     imul    dx
   4520	1619  8B 56 FA			     mov     dx,word ptr [bp-6]
   4521	161C  8B D8			     mov     bx,ax
   4522	161E  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   4523					;
   4524					;		     miniSO_thread[pcb].status = WAITSEM;
   4525					;
   4526	1622  8B C6			     mov     ax,si
   4527	1624  BA 001A			     mov     dx,26
   4528	1627  F7 EA			     imul    dx
   4529	1629  8B D8			     mov     bx,ax
   4530	162B  C7 87 000Br 0005		     mov     word ptr DGROUP:_miniSO_thread[bx+4],5
   4531					;
   4532					;		     miniSO_nextthread=nextthread;
   4533					;
   4534	1631  8B 46 F8			     mov     ax,word ptr [bp-8]
   4535	1634  A3 0004r			     mov     word ptr DGROUP:_miniSO_nextthread,ax
   4536					;
   4537					;		     enable();
   4538					;
   4539	1637  E8 0000e			     call    near ptr _enable
   4540	163A  EB 00			     jmp     short @34@422
   4541	163C			     @34@422:
   4542					;
   4543					;		     while   (miniSO_thread[pcb].status	== WAITSEM)
   4544					;
   4545	163C  8B C6			     mov     ax,si
   4546	163E  BA 001A			     mov     dx,26
   4547	1641  F7 EA			     imul    dx
   4548	1643  8B D8			     mov     bx,ax
   4549	1645  83 BF 000Br 05		     cmp     word ptr DGROUP:_miniSO_thread[bx+4],5
   4550	164A  74 F0			     je	     short @34@422
   4551					;
   4552					;			     ;
   4553					;	     }
   4554					;
   4555	164C  EB 03			     jmp     short @34@506
   4556	164E			     @34@478:
   4557					;
   4558					;	     else
   4559					;		     enable();
   4560					;
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 81
scall.ASM



   4561	164E  E8 0000e			     call    near ptr _enable
   4562	1651			     @34@506:
   4563					;
   4564					;	     return miniSO_OK;
   4565					;
   4566	1651  B8 0001			     mov     ax,1
   4567	1654  E9 FEDF			     jmp     @34@86
   4568	1657			     @34@534:
   4569					;
   4570					;    }
   4571					;
   4572	1657  5F			     pop     di
   4573	1658  5E			     pop     si
   4574	1659  8B E5			     mov     sp,bp
   4575	165B  5D			     pop     bp
   4576	165C  C3			     ret
   4577	165D			     _sc_semdown     endp
   4578					;
   4579					;    int sc_semdestroy (semid_t	s)
   4580					;
   4581					     assume  cs:_TEXT
   4582	165D			     _sc_semdestroy  proc    near
   4583	165D  55			     push    bp
   4584	165E  8B EC			     mov     bp,sp
   4585	1660  56			     push    si
   4586					;
   4587					;    {
   4588					;	     int sem;
   4589					;
   4590					;	     sem = get_sem_pos(s);
   4591					;
   4592	1661  FF 76 04			     push    word ptr [bp+4]
   4593	1664  E8 FCCB			     call    near ptr get_sem_pos
   4594	1667  59			     pop     cx
   4595	1668  8B F0			     mov     si,ax
   4596					;
   4597					;	     if	     (sem==miniSO_ERROR	|| miniSO_sem[sem].queue!=-1)
   4598					;
   4599	166A  83 FE FF			     cmp     si,-1
   4600	166D  74 0D			     je	     short @35@86
   4601	166F  8B DE			     mov     bx,si
   4602	1671  B1 03			     mov     cl,3
   4603	1673  D3 E3			     shl     bx,cl
   4604	1675  83 BF 01ADr FF		     cmp     word ptr DGROUP:_miniSO_sem[bx+6],-1
   4605	167A  74 05			     je	     short @35@142
   4606	167C			     @35@86:
   4607					;
   4608					;		     return miniSO_ERROR;
   4609					;
   4610	167C  B8 FFFF			     mov     ax,-1
   4611	167F			     @35@114:
   4612	167F  EB 11			     jmp     short @35@170
   4613	1681			     @35@142:
   4614					;
   4615					;	     miniSO_sem[sem].status = FREE;
   4616					;
   4617	1681  8B DE			     mov     bx,si
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 82
scall.ASM



   4618	1683  B1 03			     mov     cl,3
   4619	1685  D3 E3			     shl     bx,cl
   4620	1687  C7 87 01A7r FFFF		     mov     word ptr DGROUP:_miniSO_sem[bx],-1
   4621					;
   4622					;	     return miniSO_OK;
   4623					;
   4624	168D  B8 0001			     mov     ax,1
   4625	1690  EB ED			     jmp     short @35@114
   4626	1692			     @35@170:
   4627					;
   4628					;    }
   4629					;
   4630	1692  5E			     pop     si
   4631	1693  5D			     pop     bp
   4632	1694  C3			     ret
   4633	1695			     _sc_semdestroy  endp
   4634					;
   4635					;    int sc_sembroadcast (semid_t s)
   4636					;
   4637					     assume  cs:_TEXT
   4638	1695			     _sc_sembroadcast	     proc    near
   4639	1695  55			     push    bp
   4640	1696  8B EC			     mov     bp,sp
   4641	1698  83 EC 02			     sub     sp,2
   4642	169B  56			     push    si
   4643	169C  57			     push    di
   4644					;
   4645					;    {
   4646					;	     int sem;
   4647					;	     int contador;
   4648					;	     pcb_t pcb,last,prevthread,nextthread;
   4649					;
   4650					;	     disable();
   4651					;
   4652	169D  E8 0000e			     call    near ptr _disable
   4653					;
   4654					;	     sem = get_sem_pos(s);
   4655					;
   4656	16A0  FF 76 04			     push    word ptr [bp+4]
   4657	16A3  E8 FC8C			     call    near ptr get_sem_pos
   4658	16A6  59			     pop     cx
   4659	16A7  8B F0			     mov     si,ax
   4660					;
   4661					;	     if	     (sem==miniSO_ERROR) {
   4662					;
   4663	16A9  83 FE FF			     cmp     si,-1
   4664	16AC  75 09			     jne     short @36@114
   4665					;
   4666					;		     enable();
   4667					;
   4668	16AE  E8 0000e			     call    near ptr _enable
   4669					;
   4670					;		     return miniSO_ERROR;
   4671					;
   4672	16B1  B8 FFFF			     mov     ax,-1
   4673	16B4			     @36@86:
   4674	16B4  E9 00C8			     jmp     @36@282
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 83
scall.ASM



   4675	16B7			     @36@114:
   4676	16B7  E9 00AC			     jmp     @36@226
   4677	16BA			     @36@142:
   4678					;
   4679					;	     }
   4680					;
   4681					;	     while(miniSO_sem[sem].queue!=-1) {
   4682					;		     miniSO_sem[sem].value++;
   4683					;
   4684	16BA  8B DE			     mov     bx,si
   4685	16BC  B1 03			     mov     cl,3
   4686	16BE  D3 E3			     shl     bx,cl
   4687	16C0  FF 87 01ABr		     inc     word ptr DGROUP:_miniSO_sem[bx+4]
   4688					;
   4689					;		     pcb = miniSO_sem[sem].queue;
   4690					;
   4691	16C4  8B DE			     mov     bx,si
   4692	16C6  B1 03			     mov     cl,3
   4693	16C8  D3 E3			     shl     bx,cl
   4694	16CA  8B BF 01ADr		     mov     di,word ptr DGROUP:_miniSO_sem[bx+6]
   4695					;
   4696					;		     miniSO_sem[sem].queue = miniSO_thread[pcb].next;
   4697					;
   4698	16CE  8B C7			     mov     ax,di
   4699	16D0  BA 001A			     mov     dx,26
   4700	16D3  F7 EA			     imul    dx
   4701	16D5  8B D8			     mov     bx,ax
   4702	16D7  8B 87 001Fr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+24]
   4703	16DB  8B DE			     mov     bx,si
   4704	16DD  B1 03			     mov     cl,3
   4705	16DF  D3 E3			     shl     bx,cl
   4706	16E1  89 87 01ADr		     mov     word ptr DGROUP:_miniSO_sem[bx+6],ax
   4707					;
   4708					;		     if	     (miniSO_sem[sem].queue!=-1)
   4709					;
   4710	16E5  8B DE			     mov     bx,si
   4711	16E7  B1 03			     mov     cl,3
   4712	16E9  D3 E3			     shl     bx,cl
   4713	16EB  83 BF 01ADr FF		     cmp     word ptr DGROUP:_miniSO_sem[bx+6],-1
   4714	16F0  74 17			     je	     short @36@198
   4715					;
   4716					;			     miniSO_thread[miniSO_sem[sem].queue].prev = -1;
   4717					;
   4718	16F2  8B DE			     mov     bx,si
   4719	16F4  B1 03			     mov     cl,3
   4720	16F6  D3 E3			     shl     bx,cl
   4721	16F8  8B 87 01ADr		     mov     ax,word ptr DGROUP:_miniSO_sem[bx+6]
   4722	16FC  BA 001A			     mov     dx,26
   4723	16FF  F7 EA			     imul    dx
   4724	1701  8B D8			     mov     bx,ax
   4725	1703  C7 87 001Dr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+22],-1
   4726	1709			     @36@198:
   4727					;
   4728					;		     last = miniSO_thread[miniSO_ready].prev;
   4729					;
   4730	1709  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   4731	170C  BA 001A			     mov     dx,26
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 84
scall.ASM



   4732	170F  F7 EA			     imul    dx
   4733	1711  8B D8			     mov     bx,ax
   4734	1713  8B 87 001Dr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+22]
   4735	1717  89 46 FE			     mov     word ptr [bp-2],ax
   4736					;
   4737					;		     miniSO_thread[pcb].prev = last;
   4738					;
   4739	171A  8B C7			     mov     ax,di
   4740	171C  BA 001A			     mov     dx,26
   4741	171F  F7 EA			     imul    dx
   4742	1721  8B 56 FE			     mov     dx,word ptr [bp-2]
   4743	1724  8B D8			     mov     bx,ax
   4744	1726  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   4745					;
   4746					;		     miniSO_thread[last].next=pcb;
   4747					;
   4748	172A  8B 46 FE			     mov     ax,word ptr [bp-2]
   4749	172D  BA 001A			     mov     dx,26
   4750	1730  F7 EA			     imul    dx
   4751	1732  8B D8			     mov     bx,ax
   4752	1734  89 BF 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],di
   4753					;
   4754					;		     miniSO_thread[miniSO_ready].prev=pcb;
   4755					;
   4756	1738  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   4757	173B  BA 001A			     mov     dx,26
   4758	173E  F7 EA			     imul    dx
   4759	1740  8B D8			     mov     bx,ax
   4760	1742  89 BF 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],di
   4761					;
   4762					;		     miniSO_thread[pcb].next=miniSO_ready;
   4763					;
   4764	1746  8B C7			     mov     ax,di
   4765	1748  BA 001A			     mov     dx,26
   4766	174B  F7 EA			     imul    dx
   4767	174D  8B 16 0007r		     mov     dx,word ptr DGROUP:_miniSO_ready
   4768	1751  8B D8			     mov     bx,ax
   4769	1753  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   4770					;
   4771					;		     miniSO_thread[pcb].status = READY;
   4772					;
   4773	1757  8B C7			     mov     ax,di
   4774	1759  BA 001A			     mov     dx,26
   4775	175C  F7 EA			     imul    dx
   4776	175E  8B D8			     mov     bx,ax
   4777	1760  C7 87 000Br 0000		     mov     word ptr DGROUP:_miniSO_thread[bx+4],0
   4778	1766			     @36@226:
   4779	1766  8B DE			     mov     bx,si
   4780	1768  B1 03			     mov     cl,3
   4781	176A  D3 E3			     shl     bx,cl
   4782	176C  83 BF 01ADr FF		     cmp     word ptr DGROUP:_miniSO_sem[bx+6],-1
   4783	1771  74 03			     je	     @@11
   4784	1773  E9 FF44			     jmp     @36@142
   4785	1776			     @@11:
   4786					;
   4787					;
   4788					;	     }
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 85
scall.ASM



   4789					;	     enable();
   4790					;
   4791	1776  E8 0000e			     call    near ptr _enable
   4792					;
   4793					;	     return miniSO_OK;
   4794					;
   4795	1779  B8 0001			     mov     ax,1
   4796	177C  E9 FF35			     jmp     @36@86
   4797	177F			     @36@282:
   4798					;
   4799					;    }
   4800					;
   4801	177F  5F			     pop     di
   4802	1780  5E			     pop     si
   4803	1781  8B E5			     mov     sp,bp
   4804	1783  5D			     pop     bp
   4805	1784  C3			     ret
   4806	1785			     _sc_sembroadcast	     endp
   4807	1785			     _TEXT   ends
   4808	0000			     _BSS    segment word public 'BSS'
   4809	0000			     _miniSO_oldisr  label   dword
   4810	0000  04*(??)			     db	     4 dup (?)
   4811	0004			     _miniSO_nextthread	     label   word
   4812	0004  02*(??)			     db	     2 dup (?)
   4813	0006			     _miniSO_delcurthread    label   byte
   4814	0006  01*(??)			     db	     1 dup (?)
   4815	0007			     _miniSO_thread  label   word
   4816	0007  01A0*(??)			     db	     416 dup (?)
   4817	01A7			     _miniSO_sem     label   word
   4818	01A7  50*(??)			     db	     80	dup (?)
   4819					     ?debug  C E9
   4820					     ?debug  C FA00000000
   4821	01F7			     _BSS    ends
   4822	008F			     _DATA   segment word public 'DATA'
   4823	008F			     s@	     label   byte
   4824	008F  0A			     db	     10
   4825	0090  0A			     db	     10
   4826	0091  00			     db	     0
   4827	0092  50 72 65 73 73 69	6F+	     db	     'Pressione	uma tecla para reiniciar...'
   4828	      6E 65 20 75 6D 61	20+
   4829	      74 65 63 6C 61 20	70+
   4830	      61 72 61 20 72 65	69+
   4831	      6E 69 63 69 61 72	2E+
   4832	      2E 2E
   4833	00B7  0A			     db	     10
   4834	00B8  00			     db	     0
   4835	00B9  6B 69 6C 6C 28 29	3A+	     db	     'kill(): thread 0 excluida!'
   4836	      20 74 68 72 65 61	64+
   4837	      20 30 20 65 78 63	6C+
   4838	      75 69 64 61 21
   4839	00D3  00			     db	     0
   4840	00D4  6B 69 6C 6C 28 29	3A+	     db	     'kill(): nao ha'
   4841	      20 6E 61 6F 20 68	61
   4842	00E2  27			     db	     39
   4843	00E3  20 6D 61 69 73 20	74+	     db	     ' mais threads executando!'
   4844	      68 72 65 61 64 73	20+
   4845	      65 78 65 63 75 74	61+
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 86
scall.ASM



   4846	      6E 64 6F 21
   4847	00FC  00			     db	     0
   4848	00FD  77 61 69 74 70 69	64+	     db	     'waitpid(): nao ha'
   4849	      28 29 3A 20 6E 61	6F+
   4850	      20 68 61
   4851	010E  27			     db	     39
   4852	010F  20 6D 61 69 73 20	74+	     db	     ' mais threads executando!'
   4853	      68 72 65 61 64 73	20+
   4854	      65 78 65 63 75 74	61+
   4855	      6E 64 6F 21
   4856	0128  00			     db	     0
   4857	0129  77 61 69 74 28 29	3A+	     db	     'wait(): nao ha'
   4858	      20 6E 61 6F 20 68	61
   4859	0137  27			     db	     39
   4860	0138  20 6D 61 69 73 20	74+	     db	     ' mais threads executando!'
   4861	      68 72 65 61 64 73	20+
   4862	      65 78 65 63 75 74	61+
   4863	      6E 64 6F 21
   4864	0151  00			     db	     0
   4865	0152  65 78 69 74 28 29	3A+	     db	     'exit(): thread 0 encerrada!'
   4866	      20 74 68 72 65 61	64+
   4867	      20 30 20 65 6E 63	65+
   4868	      72 72 61 64 61 21
   4869	016D  00			     db	     0
   4870	016E  65 78 69 74 28 29	3A+	     db	     'exit(): pai nao encontrado!'
   4871	      20 70 61 69 20 6E	61+
   4872	      6F 20 65 6E 63 6F	6E+
   4873	      74 72 61 64 6F 21
   4874	0189  00			     db	     0
   4875	018A  65 78 69 74 28 29	3A+	     db	     'exit(): nao ha'
   4876	      20 6E 61 6F 20 68	61
   4877	0198  27			     db	     39
   4878	0199  20 6D 61 69 73 20	74+	     db	     ' mais threads executando!'
   4879	      68 72 65 61 64 73	20+
   4880	      65 78 65 63 75 74	61+
   4881	      6E 64 6F 21
   4882	01B2  00			     db	     0
   4883	01B3  77 61 69 74 73 69	67+	     db	     'waitsignal(): nao	ha'
   4884	      6E 61 6C 28 29 3A	20+
   4885	      6E 61 6F 20 68 61
   4886	01C7  27			     db	     39
   4887	01C8  20 6D 61 69 73 20	74+	     db	     ' mais threads executando!'
   4888	      68 72 65 61 64 73	20+
   4889	      65 78 65 63 75 74	61+
   4890	      6E 64 6F 21
   4891	01E1  00			     db	     0
   4892	01E2  73 65 6D 64 6F 77	6E+	     db	     'semdown(): nao ha'
   4893	      28 29 3A 20 6E 61	6F+
   4894	      20 68 61
   4895	01F3  27			     db	     39
   4896	01F4  20 6D 61 69 73 20	74+	     db	     ' mais threads executando!'
   4897	      68 72 65 61 64 73	20+
   4898	      65 78 65 63 75 74	61+
   4899	      6E 64 6F 21
   4900	020D  00			     db	     0
   4901	020E			     _DATA   ends
   4902	1785			     _TEXT   segment byte public 'CODE'
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 87
scall.ASM



   4903	1785			     _TEXT   ends
   4904				     _get_sem_pos    equ     get_sem_pos
   4905					     extrn   _miniSO_return_addr:near
   4906					     public  _miniSO_contextswitch
   4907					     public  _scall
   4908				     _get_pcb	     equ     get_pcb
   4909				     _end_mso	     equ     end_mso
   4910				     _scroll equ     scroll
   4911				     _getCursorPosition	     equ     getCursorPosition
   4912				     _setCursorPosition	     equ     setCursorPosition
   4913					     public  _miniSO_scall_table
   4914					     public  _miniSO_oldisr
   4915					     public  _miniSO_nextthread
   4916					     public  _miniSO_delcurthread
   4917					     public  _miniSO_free
   4918					     public  _miniSO_ready
   4919					     public  _miniSO_thread
   4920				     _nextsemid	     equ     nextsemid
   4921					     public  _miniSO_sem
   4922				     _miniSO_key     equ     miniSO_key
   4923				     _miniSO_iskey   equ     miniSO_iskey
   4924				     _miniSO_pag     equ     miniSO_pag
   4925				     _miniSO_cor     equ     miniSO_cor
   4926				     _miniSO_col     equ     miniSO_col
   4927					     extrn   _putstr:near
   4928					     extrn   _getch:near
   4929					     extrn   _putch:near
   4930					     public  _sc_sembroadcast
   4931					     public  _sc_semdestroy
   4932					     public  _sc_semdown
   4933					     public  _sc_semup
   4934					     public  _sc_semset
   4935					     public  _sc_semcreate
   4936					     public  _sc_waitsignal
   4937					     public  _sc_sendsignal
   4938					     public  _sc_getppid
   4939					     public  _sc_getpid
   4940					     public  _sc_exit
   4941					     public  _sc_waitpid
   4942					     public  _sc_wait
   4943					     public  _sc_kill
   4944					     public  _sc_fork
   4945					     public  _sc_reboot
   4946					     public  _sc_gettime
   4947					     public  _sc_getdate
   4948					     public  _sc_gotoxy
   4949					     public  _sc_wherey
   4950					     public  _sc_wherex
   4951					     public  _sc_setcolor
   4952					     public  _sc_getcolor
   4953					     public  _sc_clrscr
   4954					     public  _sc_getch
   4955					     public  _sc_putch
   4956					     public  _miniSO_init_semtable
   4957					     public  _miniSO_init_proctable
   4958					     extrn   _FP_OFF:near
   4959					     extrn   _FP_SEG:near
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 88
scall.ASM



   4960					     extrn   _MK_FP:near
   4961					     extrn   _disable:near
   4962					     extrn   _enable:near
   4963					     extrn   _setvect:near
   4964				     _s@     equ     s@
   4965					     end
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 89
Symbol Table




Symbol Name		Type   Value			   Cref	(defined at #)

??DATE			Text   "11/19/18"
??FILENAME		Text   "scall	"
??TIME			Text   "21:30:18"
??VERSION		Number 030A
@10@58			Near   _TEXT:0207		   763	#764
@11@58			Near   _TEXT:0218		   786	#787
@12@58			Near   _TEXT:0244		   832	#833
@13@114			Near   _TEXT:02F3		   954	#955
@14@114			Near   _TEXT:038D		   1063	 #1064
@15@170			Near   _TEXT:03C6		   1108	 #1115
@15@226			Near   _TEXT:0403		   1114	 1142  #1151
@15@254			Near   _TEXT:0435		   1102	 #1184
@15@86			Near   _TEXT:03AC		   1084	 #1094
@17@142			Near   _TEXT:04AD		   #1304  1316
@17@170			Near   _TEXT:04AF		   1292	 1299  #1306
@17@198			Near   _TEXT:04B0		   1281	 #1308
@17@254			Near   _TEXT:04BA		   1305	 #1317
@17@58			Near   _TEXT:0489		   #1282  1310
@18@114			Near   _TEXT:04D0		   1338	 #1348
@18@58			Near   _TEXT:04C3		   #1339  1350
@19@114			Near   _TEXT:0596		   1458	 #1479
@19@58			Near   _TEXT:0576		   #1459  1481
@1@170			Near   _TEXT:0039		   #191	 272
@1@198			Near   _TEXT:0046		   #201	 215  230  246	261
@1@226			Near   _TEXT:0048		   #203	 273
@1@254			Near   _TEXT:0059		   #216	 274
@1@282			Near   _TEXT:006E		   #231	 275
@1@310			Near   _TEXT:0087		   178	188  #247
@1@338			Near   _TEXT:0088		   166	#249
@1@394			Near   _TEXT:0094		   202	#262
@1@58			Near   _TEXT:000D		   #167	 252
@1@C434			Word   _TEXT:0098		   190	#271
@20@114			Near   _TEXT:05D6		   1544	 #1545
@21@114			Near   _TEXT:05ED		   1581	 #1588
@21@142			Near   _TEXT:05F4		   #1599  1636
@21@198			Near   _TEXT:0607		   1612	 #1617
@21@254			Near   _TEXT:0617		   1622	 #1628
@21@282			Near   _TEXT:061B		   1598	 1627  #1634
@21@338			Near   _TEXT:082E		   1587	 #1933
@21@86			Near   _TEXT:05EA		   #1586  1932
@22@1010		Near   _TEXT:0A5B		   2302	 #2348
@22@1038		Near   _TEXT:0A6A		   2261	 #2358
@22@1066		Near   _TEXT:0A7B		   2368	 #2369
@22@1122		Near   _TEXT:0B0A		   2387	 #2452
@22@114			Near   _TEXT:085B		   #1988  2212
@22@1150		Near   _TEXT:0B14		   #2464  2465
@22@1178		Near   _TEXT:0B16		   2463	 #2466
@22@1206		Near   _TEXT:0B1C		   1998	 #2474
@22@142			Near   _TEXT:0861		   #1997  2473
@22@170			Near   _TEXT:0864		   1987	 #1999
@22@198			Near   _TEXT:0866		   #2001  2052
@22@226			Near   _TEXT:08A6		   2000	 #2045
@22@310			Near   _TEXT:08BC		   #2060  2103
@22@394			Near   _TEXT:0906		   2070	 2083  #2099
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 90
Symbol Table



@22@422			Near   _TEXT:0907		   2059	 #2101
@22@562			Near   _TEXT:0945		   #2137  2485	2486
@22@646			Near   _TEXT:0980		   2169	 #2179
@22@674			Near   _TEXT:098B		   2163	 2178  #2190
@22@702			Near   _TEXT:098D		   #2197  2490
@22@730			Near   _TEXT:098F		   #2204  2488	2489
@22@758			Near   _TEXT:0991		   2134	 #2211	2487
@22@786			Near   _TEXT:0994		   2196	 2203  2210  #2213
@22@842			Near   _TEXT:09D5		   2235	 #2262
@22@86			Near   _TEXT:084D		   1965	 #1973
@22@898			Near   _TEXT:0A14		   2281	 #2303
@22@926			Near   _TEXT:0A24		   #2315  2331
@22@954			Near   _TEXT:0A31		   2314	 #2325
@22@C1250		Word   _TEXT:0B22		   2136	 #2484
@23@114			Near   _TEXT:0B6F		   #2547  2815
@23@142			Near   _TEXT:0B72		   2537	 #2549
@23@226			Near   _TEXT:0BB3		   2589	 #2597
@23@254			Near   _TEXT:0C25		   2666	 #2667	2676
@23@310			Near   _TEXT:0C38		   2560	 #2682
@23@394			Near   _TEXT:0C80		   2724	 #2733
@23@422			Near   _TEXT:0C82		   2711	 #2738
@23@450			Near   _TEXT:0C90		   2737	 #2748
@23@506			Near   _TEXT:0CA5		   2753	 #2763
@23@534			Near   _TEXT:0CFB		   2548	 #2816
@23@86			Near   _TEXT:0B69		   2524	 #2538
@24@114			Near   _TEXT:0D54		   2884	 #2892
@24@142			Near   _TEXT:0DBB		   2954	 #2955	2964
@24@198			Near   _TEXT:0DCE		   2857	 #2970
@24@254			Near   _TEXT:0E21		   3004	 #3017
@24@282			Near   _TEXT:0E7B		   3071	 #3072
@25@114			Near   _TEXT:0E9D		   #3114  3164
@25@142			Near   _TEXT:0EDE		   3113	 #3157
@25@226			Near   _TEXT:0EF5		   #3172  3208
@25@310			Near   _TEXT:0F33		   3182	 3195  #3204
@25@338			Near   _TEXT:0F34		   3171	 #3206
@25@422			Near   _TEXT:0F5A		   3225	 #3233
@25@506			Near   _TEXT:0F90		   3256	 #3264
@25@534			Near   _TEXT:0FED		   3249	 3263  #3318
@25@590			Near   _TEXT:101F		   3344	 #3352
@25@646			Near   _TEXT:1074		   3380	 #3402
@25@674			Near   _TEXT:1083		   #3413  3429
@25@702			Near   _TEXT:1090		   3412	 #3423
@25@758			Near   _TEXT:10BF		   3401	 #3447
@25@786			Near   _TEXT:10FE		   #3487  3488
@25@86			Near   _TEXT:0E9B		   3104	 #3112
@26@58			Near   _TEXT:1119		   3516	 #3517
@27@58			Near   _TEXT:112E		   3540	 #3541
@28@114			Near   _TEXT:114F		   3577	 #3588
@28@198			Near   _TEXT:1223		   3610	 3637  #3714
@28@226			Near   _TEXT:122C		   3587	 #3726
@28@86			Near   _TEXT:114C		   #3586  3725
@29@142			Near   _TEXT:12B3		   3828	 #3836
@29@170			Near   _TEXT:130D		   3793	 #3890
@29@226			Near   _TEXT:1318		   3901	 #3902	3911
@29@254			Near   _TEXT:1328		   3900	 #3912
@29@282			Near   _TEXT:132C		   3918	 #3919
@29@86			Near   _TEXT:1279		   3772	 #3794
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 91
Symbol Table



@30@142			Near   _TEXT:1357		   #3963  3974
@30@170			Near   _TEXT:1359		   3952	 3958  #3965
@30@198			Near   _TEXT:135A		   3943	 #3967
@30@254			Near   _TEXT:1364		   3964	 #3975
@30@58			Near   _TEXT:1339		   #3944  3969
@31@114			Near   _TEXT:137E		   #4009  4033
@31@170			Near   _TEXT:138E		   4016	 #4022
@31@198			Near   _TEXT:1392		   4008	 4021  #4028
@31@254			Near   _TEXT:13DF		   #4073  4087
@31@282			Near   _TEXT:13E1		   4007	 #4075
@31@310			Near   _TEXT:13E2		   3998	 #4077
@31@366			Near   _TEXT:13EE		   4074	 #4088
@31@58			Near   _TEXT:136F		   #3999  4080
@32@114			Near   _TEXT:1413		   #4129  4144
@32@142			Near   _TEXT:1415		   4123	 #4131
@32@170			Near   _TEXT:1427		   4130	 #4145
@32@86			Near   _TEXT:1410		   4118	 #4124
@33@114			Near   _TEXT:144C		   4182	 #4193
@33@198			Near   _TEXT:14AB		   4238	 #4250
@33@226			Near   _TEXT:1508		   4210	 #4302
@33@254			Near   _TEXT:1511		   4192	 #4313
@33@86			Near   _TEXT:1449		   #4191  4312
@34@114			Near   _TEXT:1539		   4352	 #4363
@34@198			Near   _TEXT:1584		   4409	 #4417
@34@226			Near   _TEXT:1595		   #4431  4449
@34@254			Near   _TEXT:15A9		   4430	 #4446
@34@366			Near   _TEXT:15D3		   4455	 #4475
@34@394			Near   _TEXT:15F1		   4474	 #4494
@34@422			Near   _TEXT:163C		   4540	 #4541	4550
@34@478			Near   _TEXT:164E		   4380	 #4556
@34@506			Near   _TEXT:1651		   4555	 #4562
@34@534			Near   _TEXT:1657		   4362	 #4568
@34@86			Near   _TEXT:1536		   #4361  4567
@35@114			Near   _TEXT:167F		   #4611  4625
@35@142			Near   _TEXT:1681		   4605	 #4613
@35@170			Near   _TEXT:1692		   4612	 #4626
@35@86			Near   _TEXT:167C		   4600	 #4606
@36@114			Near   _TEXT:16B7		   4664	 #4675
@36@142			Near   _TEXT:16BA		   #4677  4784
@36@198			Near   _TEXT:1709		   4714	 #4726
@36@226			Near   _TEXT:1766		   4676	 #4778
@36@282			Near   _TEXT:177F		   4674	 #4797
@36@86			Near   _TEXT:16B4		   #4673  4796
@3@114			Near   _TEXT:00BF		   330	#331
@5@114			Near   _TEXT:010E		   429	#435
@5@142			Near   _TEXT:0111		   434	#441
@5@170			Near   _TEXT:0113		   407	#446
@5@310			Near   _TEXT:0153		   507	#513
@5@338			Near   _TEXT:0156		   445	498  512  #519
@5@366			Near   _TEXT:016A		   540	#541
@6@114			Near   _TEXT:0188		   566	#578
@6@226			Near   _TEXT:01AB		   613	#616
@6@254			Near   _TEXT:01B8		   615	#630
@6@282			Near   _TEXT:01BC		   577	#637
@6@86			Near   _TEXT:0186		   #576	 636
@7@170			Near   _TEXT:01E0		   696	#697
@8@58			Near   _TEXT:01EB		   717	#718
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 92
Symbol Table



@9@58			Near   _TEXT:01FA		   742	#743
@@0			Near   _TEXT:0090		   251	#253
@@1			Near   _TEXT:03B8		   1101	 #1103
@@10			Near   _TEXT:1553		   4379	 #4381
@@11			Near   _TEXT:1776		   4783	 #4785
@@2			Near   _TEXT:0A94		   2386	 #2388
@@3			Near   _TEXT:0B86		   2559	 #2561
@@4			Near   _TEXT:0D24		   2856	 #2858
@@5			Near   _TEXT:0F6D		   3248	 #3250
@@6			Near   _TEXT:1172		   3609	 #3611
@@7			Near   _TEXT:11A2		   3636	 #3638
@@8			Near   _TEXT:13E9		   4079	 #4081
@@9			Near   _TEXT:1466		   4209	 #4211
@CPU			Text   0101H
@CURSEG			Text   _TEXT			   #10	#14  #18  #22  #148  #1553  #1557  #4808  #4822	 #4902
@FILENAME		Text   SCALL
@WORDSIZE		Text   2			   #10	#14  #18  #22  #148  #1553  #1557  #4808  #4822	 #4902
B@			Byte   _BSS:0000		   #19
B@W			Word   _BSS:0000		   #20
D@			Byte   _DATA:0000		   #15
D@W			Word   _DATA:0000		   #16	1604  1616  1621  1626	1633
END_MSO			Near   _TEXT:043D		   #1201  1971	2176  2595  2890  3110	3231  3350  3834  4415
GETCURSORPOSITION	Near   _TEXT:00B0		   #310	 411  472  761	782
GET_PCB			Near   _TEXT:0482		   #1271  1605	1979  2228  2514  3218	3569
GET_SEM_POS		Near   _TEXT:1332		   #3933  4030	4111  4175  4345  4593	4657
MINISO_COL		Byte   _DATA:0000		   #23	365  495  668
MINISO_COR		Byte   _DATA:0001		   #25	373  452  715  737
MINISO_ISKEY		Byte   _DATA:0003		   #29	565  570  620
MINISO_KEY		Byte   _DATA:0004		   #31	574  625
MINISO_PAG		Byte   _DATA:0002		   #27	291  317  456
NEXTSEMID		Word   _DATA:0005		   #33	4015  4020  4027  4029	4048  4050
S@			Byte   _DATA:008F		   1223	 1247  1969  2174  2593	 2888  3108  3229  3348	 3832  4413  #4823
SCROLL			Near   _TEXT:00C1		   #342	 440  518
SETCURSORPOSITION	Near   _TEXT:00A0		   #280	 534  690  826
_DISABLE		Near   ----:---- Extern		   1371	 1592  1959  2508  2681	 2843  2969  3098  3563	 3756  4170  4340 +
							   4652	 #4961
_ENABLE			Near   ----:---- Extern		   1218	 1504  1533  1927  1992	 2458  2542  2665  2810	 2953  3062  3486 +
							   3581	 3720  3895  4186  4307	 4356  4539  4561  4668	 4791  #4962
_END_MSO		Alias  END_MSO			   #4909
_FP_OFF			Near   ----:---- Extern		   1821	 #4958
_FP_SEG			Near   ----:---- Extern		   1806	 #4959
_GETCH			Near   ----:---- Extern		   1255	 #4928
_GETCURSORPOSITION	Alias  GETCURSORPOSITION	   #4911
_GET_PCB		Alias  GET_PCB			   #4908
_GET_SEM_POS		Alias  GET_SEM_POS		   #4904
_MINISO_COL		Alias  MINISO_COL		   #4926
_MINISO_CONTEXTSWITCH	Near   _TEXT:0391		   #1076  4906
_MINISO_COR		Alias  MINISO_COR		   #4925
_MINISO_DELCURTHREAD	Byte   _BSS:0006		   1107	 1113  1495  2189  2462	 3482  #4813  4916
_MINISO_FREE		Word   _DATA:0009		   #39	1453  1580  1642  1646	1651  2027  2033  2251	2257  2791  2798  +
							   3024	 3038  3139  3153  4917
_MINISO_INIT_PROCTABLE	Near   _TEXT:04D7		   #1361  4957
_MINISO_INIT_SEMTABLE	Near   _TEXT:04BC		   #1328  1377	4956
_MINISO_ISKEY		Alias  MINISO_ISKEY		   #4923
_MINISO_KEY		Alias  MINISO_KEY		   #4922
_MINISO_NEXTTHREAD	Word   _BSS:0004		   1083	 1093  1099  1157  1190	 1499  2185  2661  2949	 3478  3885  4535 +
							   #4811  4915
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 93
Symbol Table



_MINISO_OLDISR		Dword  _BSS:0000		   1209	 1210  1524  1525  #4809  4914
_MINISO_PAG		Alias  MINISO_PAG		   #4924
_MINISO_READY		Word   _DATA:0007		   #36	1088  1100  1121  1129	1137  1146  1158  1162	1171  1179  1382  +
							   1386	 1394  1402  1405  1411	 1414  1420  1428  1436	 1444  1663  1883 +
							   1905	 1919  2162  2168  2393	 2415  2430  2531  2566	 2715  2847  2851 +
							   2882	 3103  3127  3158  3189	 3213  3262  3269  3291	 3305  3324  3333 +
							   3342	 3387  3393  3436  3442	 3452  3460  3468  3511	 3535  3644  3668 +
							   3679	 3760  4254  4280  4291	 4385  4730  4756  4767	 4918
_MINISO_RETURN_ADDR	Near   ----:---- Extern		   1793	 #4905
_MINISO_SCALL_TABLE	Word   _DATA:000B		   #42	175  186  200  213  227	 244  4913
_MINISO_SEM		Word   _BSS:01A7		   1346	 3951  3956  4006  4041	 4049  4058  4065  4072	 4122  4139  4201 +
							   4208	 4218  4230  4237  4245	 4371  4378  4429  4462	 4604  4620  4687 +
							   4694	 4706  4713  4721  4782	 #4817	4921
_MINISO_THREAD		Word   _BSS:0007		   1092	 1125  1133  1141  1150	 1166  1175  1183  1291	 1297  1390  1398 +
							   1407	 1416  1424  1432  1440	 1448  1469  1477  1486	 1490  1650  1659 +
							   1667	 1674  1815  1830  1838	 1846  1854  1862  1870	 1878  1887  1898 +
							   1907	 1915  1923  2013  2020	 2029  2041  2050  2069	 2075  2082  2091 +
							   2098	 2113  2122  2132  2149	 2158  2227  2244  2253	 2272  2280  2290 +
							   2298	 2313  2324  2330  2339	 2347  2357  2367  2380	 2397  2408  2417 +
							   2426	 2435  2443  2451  2529	 2536  2558  2574  2583	 2606  2614  2622 +
							   2631	 2639  2648  2657  2675	 2697  2706  2719  2732	 2747  2762  2781 +
							   2793	 2806  2855  2867  2876	 2901  2909  2917  2925	 2935  2944  2963 +
							   2980	 2988  2995  3003  3012	 3016  3026  3034  3056	 3070  3125  3132 +
							   3141	 3149  3162  3181  3187	 3194  3203  3217  3247	 3255  3261  3273 +
							   3284	 3293  3301  3309  3317	 3328  3337  3362  3371	 3379  3389  3397 +
							   3411	 3422  3428  3438  3446	 3456  3464  3473  3515	 3539  3599  3608 +
							   3621	 3628  3635  3648  3656	 3664  3672  3681  3689	 3698  3705  3713 +
							   3769	 3781
_MK_FP			Near   ----:---- Extern		   860	981  1688  2769	 3044  #4960
_NEXTSEMID		Alias  NEXTSEMID		   #4920
_PUTCH			Near   ----:---- Extern		   1241	 #4929
_PUTSTR			Near   ----:---- Extern		   1225	 1233  1249  #4927
_S@			Alias  S@			   #4964
_SCALL			Near   _TEXT:0000		   #153	 4907
_SCROLL			Alias  SCROLL			   #4910
_SC_CLRSCR		Near   _TEXT:01C0		   54  #649  4953
_SC_EXIT		Near   _TEXT:0E81		   106	1713  #3086  4940
_SC_FORK		Near   _TEXT:05D8		   90  #1562  4944
_SC_GETCH		Near   _TEXT:0170		   50  #555  4954
_SC_GETCOLOR		Near   _TEXT:01E2		   58  #708  4952
_SC_GETDATE		Near   _TEXT:0248		   78  #846  4947
_SC_GETPID		Near   _TEXT:1106		   110	#3504  4939
_SC_GETPPID		Near   _TEXT:111B		   114	#3528  4938
_SC_GETTIME		Near   _TEXT:02F8		   82  #968  4946
_SC_GOTOXY		Near   _TEXT:021A		   74  #798  4948
_SC_KILL		Near   _TEXT:0834		   94  #1947  4943
_SC_PUTCH		Near   _TEXT:00DA		   46  #388  4955
_SC_REBOOT		Near   _TEXT:05B8		   86  1260  #1516  4945
_SC_SEMBROADCAST	Near   _TEXT:1695		   146	#4638  4930
_SC_SEMCREATE		Near   _TEXT:1366		   126	#3986  4935
_SC_SEMDESTROY		Near   _TEXT:165D		   142	#4582  4931
_SC_SEMDOWN		Near   _TEXT:1517		   138	#4327  4932
_SC_SEMSET		Near   _TEXT:13F1		   130	#4100  4934
_SC_SEMUP		Near   _TEXT:142A		   134	#4157  4933
_SC_SENDSIGNAL		Near   _TEXT:1130		   118	#3552  4937
_SC_SETCOLOR		Near   _TEXT:01ED		   62  #729  4951
_SC_WAIT		Near   _TEXT:0D01		   102	#2830  4942
Turbo Assembler	 Version 3.1	    11/19/18 21:30:19	    Page 94
Symbol Table



_SC_WAITPID		Near   _TEXT:0B2E		   98  #2495  4941
_SC_WAITSIGNAL		Near   _TEXT:1230		   122	#3739  4936
_SC_WHEREX		Near   _TEXT:01FC		   66  #754  4950
_SC_WHEREY		Near   _TEXT:0209		   70  #775  4949
_SETCURSORPOSITION	Alias  SETCURSORPOSITION	   #4912
_SETVECT		Near   ----:---- Extern		   1213	 1528  #4963

Macro Name						   Cref	(defined at #)

$COMM							   #1

Groups & Segments	Bit Size Align	Combine	Class	   Cref	(defined at #)

DGROUP			Group				   #12	13  175	 186  200  213	227  244  291  317  365	 373  452  456	  +
							   495	565  570  574  620  625	 668  715  737	1083  1088  1092  1093	  +
							   1099	 1100  1107  1113  1121	 1125  1129  1133  1137	 1141  1146  1150 +
							   1157	 1158  1162  1166  1171	 1175  1179  1183  1190	 1209  1210  1223 +
							   1247	 1291  1297  1346  1382	 1386  1390  1394  1398	 1402  1405  1407 +
							   1411	 1414  1416  1420  1424	 1428  1432  1436  1440	 1444  1448  1453 +
							   1469	 1477  1486  1490  1495	 1499  1524  1525  1580	 1604  1616  1621 +
							   1626	 1633  1642  1646  1650	 1651  1659  1663  1667	 1674  1815  1830 +
							   1838	 1846  1854  1862  1870	 1878  1883  1887  1898	 1905  1907  1915 +
							   1919	 1923  1969  2013  2020	 2027  2029  2033  2041	 2050  2069  2075 +
							   2082	 2091  2098  2113  2122	 2132  2149  2158  2162	 2168  2174  2185 +
							   2189	 2227  2244  2251  2253	 2257  2272  2280  2290	 2298  2313  2324 +
							   2330	 2339  2347  2357  2367	 2380  2393  2397  2408	 2415  2417  2426 +
							   2430	 2435  2443  2451  2462	 2529  2531  2536  2558	 2566  2574  2583 +
							   2593	 2606  2614
  _BSS			16  01F7 Word	Public	BSS	   12  #18  #4808
  _DATA			16  020E Word	Public	DATA	   12  #14  #22	 #1553	#4822
_TEXT			16  1785 Byte	Public	CODE	   #10	13  #148  152  279  309	 341  387  554	648  707  728  753  774	  +
							   797	845  967  1075	1200  1270  1327  1360	1515  #1557  1561  1946	  +
							   2494	 2829  3085  3503  3527	 3551  3738  3932  3985	 4099  4156  4326 +
							   4581	 4637  #4902
